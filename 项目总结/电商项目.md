# 一,电商

## 1.架构：

前端:vue+vuetify+iview+element-ui

​			本地配置host环境.

​		前端请求后台需要经过nginx代理.

​				配置了.mange.mrshop.com 监控80端口 转发到127.0.0.1:9001前端web项目

​				配置了.api.mrshop.com  转发到127.0.0.1:8088

​					转发到zuul.zuul负责将请求到路由指定的server

父级项目:

baidu-shop-parent

​	baidu-shop-basics

​			baidu-shop-erurka-server 

​					erurka-server:用来提供服务注册中心

​			baidu-shop-upload-server

​					upload-server:mvc图片上传

​							重要点:1:解决跨域问题.

​										2:调用mvc的上传功能.file.transferTo(图片的路径);//上传	

​			baidu-shop-zuul-server

​					zuul-server:

​										解决跨域名访问.通过CorsConfiguration对象.

​										zuul:负责路由 请求过滤.  

​										ribbon:负载均衡.

​										hystrix:负责熔断

​	baidu-shop-commons

​			baidu-shop-common-core

​					base:公共的返回规范.

​					dto:公共的分页类.

​					global:全局异常处理

​							@RestControllerAdvice// 加在类上表示请求拦截  类似于aop  afterpostProcess增强方法.

​							@ExceptionHandler(value= MethodArgumentNotValidException.class)加在方法上表示要拦截的是那种类型的异常

​					utils:公共的工具类

​								Json转换工具类

​								转换大小写拼音工具类.	

​								公共验证标识符	

​	baidu-shop-servers

​			baidu-shop-category-server 接口的实现类 控制层/业务层/持久层.

​						category-server:分类管理.

​			baidu-shop-brand-server

​						brand-server:品牌管理

​	baidu-shop-server-api :api方法 swaager2配置

​			baidu-shop-categroy-api



​						category-api:存放分类管理的接口.

​			baidu-shop-brand-api

​						brand-api:存放品牌管理的接口



## 2.后台

### 2.1后台管理

商品管理：商品分类，品牌，商品规格等

销售管理：订单统计，订单退款，促销活动

用户管理：用户控制，冻结，解冻等

权限管理：整个项目的权限控制

### 2.1.2后台技术

SpringMVC，Spring，Mybatis，SpringBoot，SpringCloud

Redis，RabbitMQ，ES（Elasticsearch），nginx，FastDFS，MyCat，Thymeleaf，JWT



## 3.前台

### 3.1前台管理

搜索商品，购物车，订单，评论

### 3.2前台技术

HTML，CSS，Java，JQuery

Vuetify，WebPack（构建工具），NPM（安装包工具）,Vue-cli（脚手架）,vue-router（路由），axios，quil-editor

## 

## 4.开发环境

JDK（JDK1.8）+IDE（idea）+maven+git



## 5.域名

我们在开发的过程中，为了保证以后的生产、测试环境统一。尽量都采用域名来访问项目。

一级域名：www.mrshop.com

二级域名：manage.mrshop.com , api.mrshop.com



## 6.项目结构

- **mingrui-shop-parent**

  mingrui-shop-basics

​			mingrui-shop-config-server

​			mingrui-shop-eureka-server 8761

​			mingrui-shop-zuul-server 8088 --> 

​			mingrui-shop-upload-server 8200



- **mingrui-shop-commons**

​		mingrui-shop-common-core



- **mingrui-shop-services**

​		mingrui-shop-service-categoty 

​		mingrui-shop-service-brand 

​		mingrui-shop-service-spec



- **mingrui-shop-services-api**

​		mingrui-shop-service-api-categoty

​		mingrui-shop-service-api-brand

​		mingrui-shop-service-api-spec



## 7.创建项目

### 搭建父类项目

![image-20201230172409142](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230172409142.png)



### 删除src文件夹

### pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.baidu</groupId>
    <artifactId>mingrui-shop-parent</artifactId>
    <version>1.0-SNAPSHOT</version>
    
    <!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>

    <properties>
        <!--项目构建编码-->
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF8</project.reporting.outputEncoding>
        
        <!--声明JDK版本-->
        <java.version>1.8</java.version>
        <!--spring cloud 版本.注意此版本是建立在boot2.2.2版本上的-->
        <mr.spring.cloud.version>Hoxton.SR1</mr.spring.cloud.version>
    </properties>


    <!--boot 版本-->
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.1.RELEASE</version>
        <!--始终从仓库中获取，不从本地路径获取-->
        <relativePath />
    </parent>
    <dependencies>
        <!-- 集成commons工具类 -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
        </dependency>
        <!-- 集成lombok 框架 -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <!--junit测试-->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
        </dependency>
        <!-- SpringBoot整合eureka客户端 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <!--boot 测试模块-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    <!-- 项目依赖,子级模块可以继承依赖-->
    <dependencyManagement>
        <dependencies>
            <!--cloud 依赖-->
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${mr.spring.cloud.version}</version>
                <type>pom</type>
                <!--解决maven单继承的问题-->
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
    <!-- 注意： 这里必须要添加， 否者各种依赖有问题 -->
    <repositories>
        <repository>
            <id>spring-milestones</id>
            <name>Spring Milestones</name>
            <url>https://repo.spring.io/libs-milestone</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
    </repositories>


</project>
```



### 创建基本父级项目

在mingrui-shop-parent 工程名上右键-->new-->module

![image-20201230173247639](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230173247639.png)

项目名为: mingrui-shop-basics

![image-20201230173436445](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230173436445.png)

删除src文件夹

pom.xml

只需要把打包方式设置为pom即可,暂时先不要引入其他依赖

```xml
<!--父级项目不需要打包所有packging的类型为pom--> 
<packaging>pom</packaging> 
```



### 创建工具工程

 在mingrui-shop-parent 工程名上右键-->new-->module

![image-20201230173247639](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230173247639.png)

项目名为: mingrui-shop-commoms

![image-20201230173742612](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230173742612.png)

删除src文件夹

pom.xml

只需要把打包方式设置为pom即可,暂时先不要引入其他依赖

```xml
<!--父级项目不需要打包所有packging的类型为pom--> 
<packaging>pom</packaging> 
```



### 创建服务实现工程

 在mingrui-shop-parent 工程名上右键-->new-->module

![image-20201230173247639](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230173247639.png)

项目名为: mingrui-shop-service

![image-20201230173911437](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230173911437.png)

pom.xml

```xml
<!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
    <dependencies>
        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!-- springcloud feign组件 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
    </dependencies>
```



### 创建服务接口工程

 在mingrui-shop-parent 工程名上右键-->new-->module

![image-20201230173247639](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230173247639.png)

项目名为: mingrui-shop-service-api

![image-20201230174819837](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230174819837.png)

pom.xml

```xml
<!--父级项目不需要打包所有packging的类型为pom--> 
<packaging>pom</packaging> 

<dependencies> 
	<!-- SpringBoot-整合Web组件 --> 
	<dependency> 
		<groupId>org.springframework.boot</groupId> 
		<artifactId>spring-boot-starter-web</artifactId> 
	</dependency> 
</dependencies>
```



### 创建eureka服务

在mingrui-shop-basics工程名上右键-->new-->module

![image-20201230175536847](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230175536847.png)

![image-20201230175559992](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230175559992.png)

注意:在点击finish之前一定要确认一遍当前创建工程的父工程是mingrui-shop-basics,

​		接下来的项目创建的时候也是一样的

pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>mingrui-shop-basics</artifactId>
        <groupId>com.baidu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>mingrui-shop-basics-eureka-server</artifactId>

    <dependencies>
        <!--eureka 服务依赖-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-netflix-eureka-server</artifactId>
        </dependency>
    </dependencies>

</project>
```

application.yml

```yml
server:
  port: 8761
spring:
  application:
    name: eureka-server
eureka:
  client:
    # eureka服务url,值为map集合默认key为defaultZone
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka
    # 当前服务是否同时注册
    register-with-eureka: false
    # 去注册中心获取其他服务的地址
    fetch-registry: false
  instance:
    hostname: localhost
    # 定义服务续约任务（心跳）的调用间隔，单位：秒 默认30
    lease-renewal-interval-in-seconds: 1
    # 定义服务失效的时间，单位：秒 默认90
    lease-expiration-duration-in-seconds: 2
  server:
    # 测试时关闭自我保护机制，保证不可用服务及时踢出
    enable-self-preservation: false

```

创建启动类

首先在java包下创建com.baidu.shop

![image-20201230191534676](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230191534676.png)

其次在com.baidu.shop上创建启动类

![image-20201230192209313](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201230192209313.png)

启动类：

```java
package com.baidu.shop;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer
public class RunBasicsEurekaServer {
    public static void main(String[] args) {
        SpringApplication.run(RunBasicsEurekaServer.class);
    }
}

```

## 8.前台项目

![image-20201231101627031](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201231101627031.png)

找到此文件从Visual Studio Code打开

![image-20201231101715938](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20201231101715938.png)

项目搭建完成！！！

# 二，分类管理

## 1.搭建

mingrui-shop-common-core工程

在mingrui-shop--commons项目下新建mingrui-shopcommon-core项目

![image-20210105113803076](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105113803076.png)

pom.xml

```xml
 <!--处理json与各种数据类型或文档类型的转换-->
        <dependency>
            <groupId>com.google.code.gson</groupId>
            <artifactId>gson</artifactId>
            <version>2.8.5</version>
        </dependency>

        <!--json对象序列化和反序列化的支持-->
        <dependency>
            <groupId>org.codehaus.jackson</groupId>
            <artifactId>jackson-core-lgpl</artifactId>
            <version>1.9.13</version>
        </dependency>
        <dependency>
        <groupId>org.codehaus.jackson</groupId>
            <artifactId>jackson-mapper-lgpl</artifactId>
            <version>1.9.13</version>
        </dependency>

        <!--java对象和json对象之间的转换-->
        <dependency>
            <groupId>org.codehaus.jackson</groupId>
            <artifactId>jackson-core-asl</artifactId>
            <version>1.9.13</version>
        </dependency>
        <dependency>
            <groupId>org.codehaus.jackson</groupId>
            <artifactId>jackson-mapper-asl</artifactId>
            <version>1.9.13</version>
        </dependency>

        <!--alibaba的json处理工具-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.2.62</version>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>2.11.2</version>
        </dependency>

```

新建包com.baidu.shop.utils创建JSONUtil

```java
import com.alibaba.fastjson.JSONObject;
import org.codehaus.jackson.JsonParseException;
import org.codehaus.jackson.map.JsonMappingException;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.type.TypeReference;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.reflect.TypeToken;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;


public class JSONUtil {
    private static Gson gson = null;
    static {
        gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();// todo yyyy-MM-dd HH:mm:ss
    }
    public static synchronized Gson newInstance() {
        if (gson == null) {
            gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();
        }
        return gson;
    }
    public static String toJsonString(Object obj) {
        return gson.toJson(obj);
    }
    public static <T> T toBean(String json, Class<T> clz) {
        return gson.fromJson(json, clz);
    }
    public static <T> Map<String, T> toMap(String json, Class<T> clz) {
        Map<String, JsonObject> map = gson.fromJson(json, new
                TypeToken<Map<String, JsonObject>>() {
                }.getType());
        Map<String, T> result = new HashMap<String, T>();
        for (String key : map.keySet()) {
            result.put(key, gson.fromJson(map.get(key), clz));
        }
        return result;
    }
    public static Map<String, Object> toMap(String json) {
        Map<String, Object> map = gson.fromJson(json, new TypeToken<Map<String,
                Object>>() {
        }.getType());
        return map;
    }
    public static <T> List<T> toList(String json, Class<T> clz) {
        JsonArray array = new JsonParser().parse(json).getAsJsonArray();
        List<T> list = new ArrayList<T>();
        for (final JsonElement elem : array) {
            list.add(gson.fromJson(elem, clz));
        }
        return list;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> Object getObjectByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseObject(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> List<T> getListByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseArray(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param key
     * 键
     * @return
     */
    public static String getStrByKey(String json, String key) {
        String str = "";
        if (json != null && !"".equals(json)) {
            JSONObject j = JSONObject.parseObject(json);
            if (j.get(key) != null) {
                str = j.get(key).toString();
            }
        }
        return str;
    }
    /**
     * 向文件中写数据
     *
     * @param _sDestFile
     * @param _sContent
     * @throws IOException
     */
    public static void writeByFileOutputStream(String _sDestFile, String
            _sContent) throws IOException {
        FileOutputStream fos = null;
        try {
            fos = new FileOutputStream(_sDestFile);
            fos.write(_sContent.getBytes());
        } catch (Exception ex) {
            ex.printStackTrace();
        } finally {
            if (fos != null) {
                fos.close();
                fos = null;
            }
        }
    }
    /**
     * 非空
     *
     * @param str
     * @return true:不为空 false：空
     */
    public static boolean noEmpty(String str) {
        boolean flag = true;
        if ("".equals(str)) {
            flag = false;
        }
        return flag;
    }
    /**
     * 将"%"去掉
     *
     * @param str
     * @return
     */
    public static double getDecimalByPercentage(String str) {
        double fuse = 0.0;
        if (!"".equals(str) && str != null) {
            if (str.split("%").length > 0) {
                fuse = Double.parseDouble(str.split("%")[0]);
                return fuse;
            }
        }
        return 0.0;
    }
    /**
     * 保留2位小数
     *
     * @param number
     * @return
     */
    public static double ConversionFraction(double number) {
        return Math.floor(number * 100 + 0.5) / 100;
    }
    public static float ConversionM(double number) {
        return (float) JSONUtil.ConversionFraction(number / 1024 / 1024);
    }
    public static String getErrorText(String s) {
        JSONObject j = JSONObject.parseObject(s);
        return
                j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
    }
    public static String getSingleJobId(String s) throws Exception {
        JSONObject j = JSONObject.parseObject(s);
        try {
            return
                    j.getJSONObject(j.keySet().iterator().next()).get("jobid").toString();
        } catch (Exception e) {
            try {
                return
                        j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
            } catch (Exception e1) {
                throw new Exception(e1.getMessage());
            }
        }
    }
    public static <T> T readValue(String jsonStr, TypeReference type)
            throws JsonParseException, JsonMappingException, IOException {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(jsonStr, type);
    }
    public static JSON_TYPE getJSONType(String str) {
        if (null == str || "".equals(str)) {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
        final char[] strChar = str.substring(0, 1).toCharArray();
        final char firstChar = strChar[0];
        if (firstChar == '{') {
            return JSON_TYPE.JSON_TYPE_OBJECT;
        } else if (firstChar == '[') {
            return JSON_TYPE.JSON_TYPE_ARRAY;
        } else {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
    }
    public enum JSON_TYPE {
        /** JSONObject */
        JSON_TYPE_OBJECT,
        /** JSONArray */
        JSON_TYPE_ARRAY,
        /** 不是JSON格式的字符串 */
        JSON_TYPE_ERROR
    }
}
```

新建包com.baidu.shop.status创建HTTPStatus

```java
 
public class HTTPStatus {
    public static final int OK = 200;//成功
    public static final int ERROR = 500;//失败
}
```

新建包com.baidu.shop.base创建Result

```java
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
public class Result<T> {
    private Integer code;//返回码
    private String message;//返回消息
    private T data;//返回数据
    public Result(Integer code, String message, Object data) {
        this.code = code;
        this.message = message;
        this.data = (T) data;
    }
}
```

com.baidu.shop.status创建BaseApiService

```java
import com.baidu.shop.utils.JSONUtil;
import com.baidu.shop.status.HTTPStatus;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

@Data
@Component
@Slf4j
public class BaseApiService<T> {
    public Result<T> setResultError(Integer code, String msg) {
        return setResult(code, msg, null);
    }
    // 返回错误，可以传msg
    public Result<T> setResultError(String msg) {
        return setResult(HTTPStatus.ERROR, msg, null);
    }
    // 返回成功，可以传data值
    public Result<T> setResultSuccess(T data) {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", data);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess() {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", null);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess(String msg) {
        return setResult(HTTPStatus.OK, msg, null);
    }
    // 通用封装
    public Result<T> setResult(Integer code, String msg, T data) {
        log.info(String.format("{code : %s , message : %s , data : %s}",code,msg,
                JSONUtil.toJsonString(data)));
        return new Result<T>(code, msg, data);
    }
}
```

在mingrui-shop-parent新建mingrui-shop-service-api工程

![image-20210105115100246](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105115100246.png)

![image-20210105115039158](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105115039158.png)

mingrui-shop-service-api/pom.xml

```xml
<!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!--Entity 中的@Table 和@Id需要次注解-->
        <dependency>
            <groupId>javax.persistence</groupId>
            <artifactId>persistence-api</artifactId>
            <version>1.0.2</version>
        </dependency>
        <!--2.3版本之后web删除了验证插件-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <!--引入common工程代码-->
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-common-core</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
```

在mingrui-shop-service-api项目下新建mingrui-shopservice-api-xxx项目

pom.xml

```xml
  <!--帮助开发人员快速生成API文档-->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-swagger2</artifactId>
            <version>2.9.2</version>
        </dependency>
        <!--提供可视化的API文档-->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-swagger-ui</artifactId>
            <version>2.9.2</version>
        </dependency>
```

mingrui-shopservice-api-xxx项目新建包com.baidu.shop.entity

```java
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
com.baidu.shop.entity
@ApiModel(value = "分类实体类")
@Data
@Table(name = "tb_category")
public class CategoryEntity {
    @Id
    @ApiModelProperty(value = "分类主键",example = "1")
    private Integer id;

    @ApiModelProperty(value = "分类名称")
    private String name;

    @ApiModelProperty(value = "父级分类",example = "1")
    private Integer parentId;

    @ApiModelProperty(value = "是否是父级节点",example = "1")
    private Integer isParent;

    @ApiModelProperty(value = "排序",example = "1")
    private Integer sort;
}
```

com.baidu.shop.config.MrSwagger2Config

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

@Configuration
@EnableSwagger2
public class MrSwagger2Config {
    @Bean
    public Docket createRestApi(){
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(this.apiInfo())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.baidu"))
                .paths(PathSelectors.any())
                .build();
    }
    private ApiInfo apiInfo(){
        return new ApiInfoBuilder()
                //标题
                .title("明瑞SWAGGER2标题")
                //条款地址
                .termsOfServiceUrl("http://www.baidu.com")
                //联系方式-->有String参数的方法但是已经过时，所以不推荐使用
                .contact(new Contact("shenyaqi","baidu.com","shenyaqiii@163.com"))
                //版本
                .version("v1.0")
                //项目描述
                .description("描述")
                //创建API基本信息
                .build();
    }
}
```

## 2.商品查询

### 后台

定义商品分类接口

mingrui-shopservice-api-xxx项目创建com.baidu.shop.CategoryService

```java
import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;

@Api(tags = "商品分类接口")
public interface CategoryService {
    @ApiOperation(value = "通过查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);
}
```

service工程

在mingrui-shop-parent创建mingrui-shop-service

![image-20210105115941331](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105115941331.png)

![image-20210105115951385](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105115951385.png)

mingrui-shop-service/pom.xml

```xml
<dependencies>
        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!-- springcloud feign组件 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!--mysql数据库连接-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope><!--项目运行阶段使用-->
        </dependency>
        <!--通用mapper-->
        <dependency>
            <groupId>tk.mybatis</groupId>
            <artifactId>mapper-spring-boot-starter</artifactId>
            <version>2.1.5</version>
        </dependency>
        <!--分页工具-->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.10</version>
        </dependency>
    	<!--将mingrui-shop-service-api-xxx引入项目-->
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-service-api-xxx</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
    </dependencies>
```

在mingrui-shop-service工程下新建mingrui-shop-service-xxx工程

![image-20210105130336600](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105130336600.png)

![image-20210105130356851](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105130356851.png)

在resources创建application.yml

![image-20210105130503532](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105130503532.png)

application.yml

```yml
server:
  port: 8100
spring:
  application:
    name: xxx-server
  # 配置数据源
  datasource:
    # 数据源名称，任意
    name: mysql
    url: jdbc:mysql://127.0.0.1:3306/mr-shop?useSSL=true&nullNamePatternMatchesAll=true&serverTimezone=GMT%2B8&useUnicode=true&characterEncoding=utf8
    # 数据库连接用户
    username: root
    # 数据库连接密码
    password: root
    # 驱动名称
    driver-class-name: com.mysql.cj.jdbc.Driver
    # boot2.0+使用hikari作为默认数据库连接池
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      # 是否自动提交事务 默认
      auto-commit: true
      # 允许的最小连接数
      minimum-idle: 5
      # 连接池内最大连接数
      maximum-pool-size: 10
      # 验证连接的sql语句
      connection-test-query: SELECT 1 FROM DUAL
      # 连接超时时间 默认30000 毫秒 如果小于250毫秒，则被重置回30秒
      connection-timeout: 30000
      # 验证超时时间默认5000毫秒 如果小于250毫秒，则会被重置回5秒
      validation-timeout: 5000
      # 设置连接在连接池中的存货时间 如果不等于0且小于30秒则会被重置回30分钟
      max-lifetime: 1800000
# 通用mapper
mapper:
  mappers: tk.mybatis.mapper.common.Mapper
  identity: MYSQL
#日志设置
logging:
  level:
    # 打印与我们程序相关的日志信息
    com.baidu.shop: debug
# eureka配置
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

新建包com.baidu新建启动类RunShopServicexxx.class

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.openfeign.EnableFeignClients;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication
@EnableFeignClients
@MapperScan("com.baidu.shop.mapper")
public class RunShopServicexxx {
    public static void main(String[] args) {
        SpringApplication.run(RunShopServicexxx.class);
    }
}
```

在com.baidu下新建包shop.mapper创建mapper

```java
import com.baidu.shop.entity.CategoryEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

public interface CategoryMapper extends Mapper<CategoryEntity> {
    @Select(value = "select id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
    List<CategoryEntity> getByBrandId(Integer brandId);
}
```

在com.baidu下新建包shop.service.impl新建实现类

```java
import com.baidu.shop.mapper.CategoryMapper;
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.service.CategoryService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;
import java.util.List;

@RestController
public class CategoryServiceImpl extends BaseApiService implements CategoryService {

    @Resource
    private CategoryMapper categoryMapper;

    //商品查询
    @Override
    public Result<List<CategoryEntity>> getCategoryByPid(Integer pid) {
        CategoryEntity categoryEntity = new CategoryEntity();
        categoryEntity.setParentId(pid);
        List<CategoryEntity> list = categoryMapper.select(categoryEntity);
        return this.setResultSuccess(list);
    }
}
```

浏览器输入

```
http://localhost:8100/category/list
```

![image-20210105131346290](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105131346290.png)

### 网管服务

在mingrui-shop-basic项目下新建mingrui-shop-basic-zuul-server

![image-20210105131629210](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105131629210.png)

![image-20210105131640846](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105131640846.png)

pom.xml

```xml
<!-- zuul -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
</dependency>
```

![image-20210105131735590](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105131735590.png)

 application.yml

```yml
server:
  port: 8088

spring:
  application:
    name: eureka-zuul

zuul:
  # 声明路由
  routes:
    # 路由名称
    api-xxx:
      # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
      path: /api-xxx/**
      serviceId: xxx-server
  # 启用重试
  retryable: true
  # 包含此路径的不进行路由
  ignored-patterns: /upload/**
  # 忽略上传服务
  ignored-services:
    -upload-server
#配置负载
ribbon:
  ConnectTimeout: 250 # 连接超时时间(ms)
  ReadTimeout: 2000 # 通信超时时间(ms)
  OkToRetryOnAllOperations: true # 是否对所有操作重试
  MaxAutoRetriesNextServer: 2 # 同一服务不同实例的重试次数
  MaxAutoRetries: 1 # 同一实例的重试次数

hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000 # 熔断超时时长：6000ms

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

新建包com.baidu

![image-20210105131836944](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105131836944.png)

新建启动类RunBasicZuulServer.class

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;

@SpringBootApplication
@EnableZuulProxy
@EnableEurekaClient
public class RunBasicZuulServer {
    public static void main(String[] args) {
        SpringApplication.run(RunBasicZuulServer.class);
    }
}
```

在com.baidu下新建global.GlobalCorsConfig

![image-20210105132026138](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105132026138.png)

```java

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new
                UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);//3.返回新的CorsFilter.
        return new CorsFilter(source);
    }
}
```

### 前台

Category.vue

![image-20210105132415559](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105132415559.png)

![image-20210105132516216](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105132516216.png)

删除line:5和line:22

```html
<template>
    <v-card>
        <v-flex xs12 sm10>
            <v-tree url="/category/list"
            :isEdit="isEdit"
            @handleAdd="handleAdd"
            @handleEdit="handleEdit"
            @handleDelete="handleDelete"
            @handleClick="handleClick"
            />
        </v-flex>
    </v-card>
</template>
<script>
    //import {treeData} from '../../mockDB'
    export default {
        name: "category",
            data() {
                return {
                isEdit:true
                }
            },
        methods: {
            handleAdd(node) {
                console.log("add .... ");
                console.log(node);
        	},
            handleEdit(id, name) {
            	console.log("edit... id: " + id + ", name: " + name)
            },
            handleDelete(id) {
            	console.log("delete ... " + id)
            },
            handleClick(node) {
                console.log(node)
                3.5.2 Tree.vue
                getData方法重新制定resp回调
            }
    	}
    };
</script>
<style scoped>
</style>
```

Tree.vue

```html
<template>
  <v-list class="pt-0 pb-0" dense>
    <TreeItem
      class="item" :model="model" v-for="(model, index) in db" :key="index"
      :url="url"
      :isEdit="isEdit"
      :nodes="nodes"
      @handleAdd="handleAdd"
      @handleEdit="handleEdit"
      @handleDelete="handleDelete"
      @handleClick="handleClick"
    />
  </v-list>
</template>

<script>
  import TreeItem from './TreeItem';

  export default {
    name: "vTree",
    props: {
      url: String,
      isEdit: {
        type: Boolean,
        default: false
      },
      treeData:{
        type:Array
      }
    },
    data() {
      return {
        db: [],
        nodes:{
          opened:null,
          selected:{isSelected:false}
        }
      }
    },
    components: {
      TreeItem
    },
    created() {
      if(this.treeData && this.treeData.length > 0){
        this.db = this.treeData;
        return;
      }
      this.getData();
    },
    methods: {
      getData() {
        this.$http.get(this.url, {params: {pid: 0}}).then(resp => {
          console.log(resp)
          this.db = resp.data.data;
          this.db.forEach(n => n['path'] = [n.name])
        })
      },
      handleAdd(node) {
        this.$emit("handleAdd", this.copyNodeInfo(node));
      },
      handleEdit(id, name) {
        this.$emit("handleEdit", id, name)
      },
      handleDelete(id) {
        this.deleteById(id, this.db);
        this.$emit("handleDelete", id);
      },
      handleClick(node){
        this.$emit("handleClick", this.copyNodeInfo(node))
      },
      // 根据id删除
      deleteById(id, arr) {
        let src = arr & this.db;
        for (let i in src) {
          let d = src[i];
          if (d.id === id) {
            src.splice(i, 1)
            return;
          }
          if (d.children && d.children.length > 0) {
            this.deleteById(id, d.children)
          }
        }
      },
      copyNodeInfo(node){
        const o = {};
        for(let i in node){
          o[i] = node[i];
        }
        return o;
      }
    },
    watch: {}
  }
</script>

<style scoped>
  .item {
    cursor: pointer;
  }
</style>

```

TreeItem.vue

```html
<template>
  <div>
    <v-list-tile
      @click="toggle" class="level1 pt-0 pb-0 mt-0 mb-0" :class="{'selected':isSelected}">
      <v-list-tile-avatar>
        <v-icon v-if="model.isParent">{{open ? 'folder_open' : 'folder'}}</v-icon>
        <v-icon v-if="!model.isParent">insert_drive_file</v-icon>
      </v-list-tile-avatar>
      <v-list-tile-content>
        <v-list-tile-title v-show="!beginEdit">
          <span >{{model.name}}</span>
        </v-list-tile-title>
        <input v-show="beginEdit" @click.stop="" :ref="model.id" v-model="model.name"
               @blur="afterEdit" @keydown.enter="afterEdit"/>
      </v-list-tile-content>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c1='primary'" @mouseout="c1=''" :color="c1" @click.stop="addChild">
          <i class="el-icon-plus"/>
        </v-btn>
      </v-list-tile-action>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c2='success'" @mouseout="c2=''" :color="c2" @click.stop="editChild">
          <i class="el-icon-edit"/>
        </v-btn>
      </v-list-tile-action>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c3='error'" @mouseout="c3=''" :color="c3" @click.stop="deleteChild">
          <i class="el-icon-delete"/>
        </v-btn>
      </v-list-tile-action>
    </v-list-tile>

    <v-list v-if="isFolder" v-show="open" class="ml-4 pt-0 pb-0" dense transition="scale-transition">
      <tree-item
        class="item"
        v-for="(model, index) in model.children"
        :key="index"
        :model="model"
        :url="url"
        :isEdit="isEdit"
        :nodes="nodes"
        :parentState="open"
        @handleAdd="handleAdd"
        @handleEdit="handleEdit"
        @handleDelete="handleDelete"
        @handleClick="handleClick"
      >
      </tree-item>
    </v-list>
  </div>
</template>

<script>
  import Vue from 'vue'

  export default {
    name: "tree-item",
    props: {
      model: Object,
      url: String,
      isEdit: {
        type: Boolean,
        default: false
      },
      nodes: Object,
      parentState:Boolean
    },
    created() {
    },
    data: function () {
      return {
        c1: '',
        c2: '',
        c3: '',
        isSelected: false,
        open:false,
        beginEdit:false
      }
    },
    watch:{
      parentState(val){
        if(!val){
          this.open = val;
        }
      }
    },
    computed: {
      isFolder: function () {
        return this.model.children &&
          this.model.children.length > 0
      }
    },
    methods: {
      toggle: function () {
        // 将其它被选中项取消选中
        this.nodes.selected.isSelected = false;
        // 当前项被选中
        this.isSelected = true;
        // 保存当前选中项
        this.nodes.selected = this

        // 客户自己的点击事件回调
        this.handleClick(this.model);

        // 判断是否为顶级节点，顶级节点需要记录和替换
        if(this.model.parentId == 0){
          // 判断打开节点是否是自己
          if(this.nodes.opened && this != this.nodes.opened){
            // 不是，则关闭原来的节点
            this.nodes.opened.open = false;
          }
          // 将自己记录为打开的节点
          this.nodes.opened = this;
        }
        // 切换开闭状态
        this.open = !this.open;
        // 如果已经是叶子节点,或者自己是关闭的，或者自己已经有儿子了，结束
        if (!this.model.isParent || this.isFolder || !this.open) {
          return;
        }
        // 展开后查询子节点
        this.$http.get(this.url, {params: {pid: this.model.id}})
          .then(resp => {
          Vue.set(this.model, 'children', resp.data.data);
          // 封装当前节点的路径
          this.model.children.forEach(n => {
            n['path'] = [];
            this.model.path.forEach(p => n['path'].push(p));
            n['path'].push(n.name);
          });
        }).catch( e => {
          console.log(e);
        });
      },
      addChild: function () {
        let child = {
          id: 0,
          name: '新的节点',
          parentId: this.model.id,
          isParent: false,
          sort:this.model.children? this.model.children.length + 1:1
        }
        if (!this.model.isParent) {
          Vue.set(this.model, 'children', [child]);
          this.model.isParent = true;
          this.open = true;
          this.handleAdd(child);
        } else {
          if (!this.isFolder) {
            this.$http.get(this.url, {params: {pid: this.model.id}}).then(resp => {
              Vue.set(this.model, 'children', resp.data);
              this.model.children.push(child);
              this.open = true;
              this.handleAdd(child);
            });
          } else {
            this.model.children.push(child);
            this.open = true;
            this.handleAdd(child);
          }
        }
      },
      deleteChild: function () {
        this.$message.confirm('此操作将永久删除数据，是否继续?', '提示', {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.handleDelete(this.model.id);
        }).catch(()=>{
          this.$message.info('已取消删除');
        })

      },
      editChild() {
        this.beginEdit = true;
        this.$nextTick(() => this.$refs[this.model.id].focus());
      },
      afterEdit() {
        if (this.beginEdit) {
          this.beginEdit = false;
          this.handleEdit(this.model.id, this.model.name);
        }
      },
      handleAdd(node) {
        this.$emit("handleAdd", node);
      },
      handleDelete(id) {
        this.$emit("handleDelete", id);
      },
      handleEdit(id, name) {
        this.$emit("handleEdit", id, name)
      },
      handleClick(node) {
        this.$emit("handleClick", node);
      }
    }
  }
</script>

<style scoped>
  .level1 {
    height: 40px;
  }

  .selected {
    background-color: rgba(105,184,249,0.75);
  }
</style>
```

依次启动eureka-server,xxx-service,zuul-server,vue项目 保证自己的hosts,nginx没有问题

浏览器输入

```
http://manage.mrshop.com/
```

![image-20210105133814745](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105133814745.png)

## 3.商品删除

### 后台

mingrui-shop-service-api-xxx

service：CategoryService

```java
@ApiOperation(value = "删除商品分类")
@DeleteMapping(value = "category/del")
Result<JsonObject> delCategory(Integer id);
```

mingrui-shop-common-core

util：新建ObjectUtil(让代码更优雅)

```java
package com.baidu.shop.utils;

public class ObjectUtil {
    public static  Boolean isNull(Object obj){
        return null == obj;
    }
    public static Boolean isNotNull(Object obj){
        return null != obj;
    }
}
```

mingrui-shop-service-api-xxx新建com.baidu.shop.status

![image-20210105134314798](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105134314798.png)

HTTPStatus

```java
package com.baidu.shop.status;

public class HTTPStatus {
    public static final int OK = 200;//成功
    public static final int ERROR = 500;//失败
}
```

实现类中要做的事:

 通过当前id查询分类信息

 判断是否有数据(安全) 

判断当前节点是否是父级节点(安全) 

判断当前节点的父节点下 除了当前节点是否还有别的节点(业务) 

​		没有:将当前节点的父节点isParent的值修改为0 

通过id删除数据

代码实现CategoryServiceImpl

```java
//商品删除
@Transactional//事务 增删改都需要
@Override
public Result<JsonObject> delCategory(Integer id) {

    String msg = "";

    System.out.println(id);
    //判断页面传递过来的id是否合法
    if(null != id && id >0){
        //通过id查询当前节点信息
        CategoryEntity categoryEntity = categoryMapper.selectByPrimaryKey(id);

        //判断当前节点是否为父节点(安全!)
        if (categoryEntity.getParentId() == 1)return this.setResultError("当前是父节点不能删除");//return之后的代码不会执行

        //如果当前分类被品牌绑定的话不能被删除 --> 通过分类id查询中间表是否有数据 true : 当前分类不能被删除 false:继续执行
        Example example1 = new Example(CategoryBrandEntity.class);
        example1.createCriteria().andEqualTo("categoryId",id);
        List<CategoryBrandEntity> categoryBrandEntities = categoryBrandMapper.selectByExample(example1);
        if (categoryBrandEntities.size() > 0){
            return this.setResultError("当前分类被品牌绑定不能被删除 ");
        }


        //通过当前节点的父节点id 查询 当前节点(将要被删除的节点)的父节点下是否还有其他子节点
        Example example = new Example(CategoryEntity.class);
        example.createCriteria().andEqualTo("parentId",categoryEntity.getParentId());
        List<CategoryEntity> categoryList = categoryMapper.selectByExample(example);


        //如果size <= 1 --> 如果当前节点被删除的话 当前节点的父节点下没有节点了 --> 将当前节点的父节点状态改为叶子节点
        if (categoryList.size() <= 1){
            CategoryEntity updateCategoryEntity= new CategoryEntity();
            updateCategoryEntity.setParentId(0);
            updateCategoryEntity.setId(categoryEntity.getParentId());

            categoryMapper.updateByPrimaryKeySelective(updateCategoryEntity);
        }
        categoryMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
    }
    return this.setResultError("id不合理");
}
```

### 前台

TreeItem.vue : line 164

```js
deleteChild: function () {
        if(this.model.isParent == 1){
          this.$message.warning('当前为父节点,不能删除');
          return;
        }
        this.$message.confirm('此操作将永久删除数据，是否继续?', '提示', {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.handleDelete(this.model.id);
        }).catch(()=>{
          this.$message.info('已取消删除');
        })

      },
```

Category.vue

```js
handleDelete(id) {
        this.$http.delete('./category/del?id=' + id).then(resp=>{

            if(resp.data.code != 200){
              this.$message.error('删除失败：' + resp.data.message);
              return;
            }

            this.editKey = new Date().getTime();
            this.$message.success('删除成功')
        }).catch(error => console.log(error))
      },
```

注意需要给v-tree组件绑定一个key的属性,默认值为0

```vue
<v-tree :key="key" url="/category/list">
    data() {
        return {
        	key:0
    	}
    }
```

## 4.商品修改

### 后台

mingrui-shop-service-api-xxx

service：CategoryService

```java
@ApiOperation(value = "修改商品分类")
@PutMapping(value = "category/edit")
Result<JsonObject> editCategory( @RequestBody CategoryEntity entity);
```

mingrui-shop-service-xxx

代码实现CategoryServiceImpl

```java
//修改商品分类
@Transactional
@Override
public Result<JsonObject> editCategory(CategoryEntity entity) {
    try {
        categoryMapper.updateByPrimaryKeySelective(entity);
    } catch (Exception e) {
        e.printStackTrace();
    }
    return this.setResultSuccess();
}
```

### 前台

将TreeItem.vue的afterEdit方法this.model.beginEdit改为 this.beginEdit

```js
 afterEdit() {
        if (this.beginEdit) {
          this.beginEdit = false;
          this.handleEdit(this.model.id, this.model.name);
        }
      },
```

Category.vue

```js
 handleEdit(id, name) {
        console.log("edit... id: " + id + ", name: " + name)
        this.$http.put('./category/edit',{
          id:id,
          name:name
        }).then(resp=>{
          this.$message.success('修改成功')
          this.editKey = new Date().getTime();
        }).catch(error => console.log(error))
      },
```

## 5.商品新增

### 后台

mingrui-shop-service-api-xxx

service：CategoryService

```java
@ApiOperation(value = "增加商品分类")
@PostMapping(value = "category/add")
Result<JsonObject> addCategory(@RequestBody CategoryEntity entity);
```

mingrui-shop-service-xxx

实现代码：CategoryServiceImpl

```java
//新增商品分类
@Transactional
@Override
public Result<JsonObject> addCategory(CategoryEntity entity) {

    CategoryEntity parentCategoryEntity = new CategoryEntity();
    parentCategoryEntity.setId(entity.getParentId());
    parentCategoryEntity.setIsParent(1);
    categoryMapper.updateByPrimaryKeySelective(parentCategoryEntity);

    categoryMapper.insertSelective(entity);

    return this.setResultSuccess();
}
```

### 前台

Category.vue

```js
handleAdd(node) {
        console.log("add .... ");


        //处理boolean值
        node.isParent = node.isParent?1:0;
        //删除id属性
        delete node.id;
                console.log(node);
        //新增
        this.$http.post('./category/add',node).then(resp=>{
            this.$message.success('新增成功')
            this.editKey = new Date().getTime();
        }).catch(error=>console.log(error))
      },
```

## 项目不完美

### 参数校验

common-core工程新建包com.baidu.shop.validate.group

包下新建操作类MingruiOperation

```java
package com.baidu.shop.validate.group;

public class MingruiOperation {
    public interface Add{}
    public interface Update{}
    public interface Search{}
}
```

mingrui-shop-service-api-xxx

com.baidu.shop.entity

```java
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

@ApiModel(value = "分类实体类")
@Data
@Table(name = "tb_category")
public class CategoryEntity {
    @Id
    @ApiModelProperty(value = "分类主键",example = "1")
    @NotNull(message = "ID不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类名称")
    @NotEmpty(message = "分类名称不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "父级分类",example = "1")
    @NotNull(message = "父类ID不能为空",groups = {MingruiOperation.Update.class})
    private Integer parentId;

    @ApiModelProperty(value = "是否是父级节点",example = "1")
    @NotNull(message = "是否为父节点不能为空",groups = {MingruiOperation.Add.class})
    private Integer isParent;

    @ApiModelProperty(value = "排序",example = "1")
    @NotNull(message = "排序字段不能为空",groups = {MingruiOperation.Add.class})
    private Integer sort;
}
```

 service：

```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.validate.group.MingruiOperation;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.models.auth.In;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;


@Api(tags = "商品分类接口")
public interface CategoryService {
    @ApiOperation(value = "通过查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);

    @ApiOperation(value = "删除商品分类")
    @DeleteMapping(value = "category/del")
    Result<JsonObject> delCategory(Integer id);

    @ApiOperation(value = "修改商品分类")
    @PutMapping(value = "category/edit")
    Result<JsonObject> editCategory(@Validated({MingruiOperation.Update.class}) @RequestBody CategoryEntity entity);

    @ApiOperation(value = "增加商品分类")
    @PostMapping(value = "category/add")
    Result<JsonObject> addCategory(@Validated({MingruiOperation.Add.class})@RequestBody CategoryEntity entity);

    @ApiOperation(value = "通过品牌id查询商品分类")
    @GetMapping(value = "category/getByBrand")
    Result<List<CategoryEntity>> getByBrand (Integer brandId);
}
```

### 全局异常处理

mingrui-shop-common-core

pom.xml

```html
<!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
```

com.baidu.shop.staus:HTTPStatus

```java
public static final int PARAMS_VALIDATE_ERROR = 5002;//参数校验失败
```

新建包com.baidu.shop.global

新建全局异常处理类GlobalException

![image-20210105141915045](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105141915045.png)

```java
package com.baidu.shop.global;

import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import com.google.gson.JsonObject;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.stream.Collectors;

@RestControllerAdvice
@Slf4j
public class globalException {
    @ExceptionHandler(value = RuntimeException.class)
    public Result<JsonObject> testException(RuntimeException e){
        log.error("code : {}, message : {}", HTTPStatus.ERROR,e.getMessage());
        return new Result<JsonObject>(HTTPStatus.ERROR,e.getMessage(),null);
    }
    @ExceptionHandler(value = MethodArgumentNotValidException.class)
    public HashMap<String, Object> methodValid(MethodArgumentNotValidException exception) throws Exception{
        //== ===区别？？
        HashMap<String, Object> map = new HashMap<>();
        map.put("code",HTTPStatus.PARAMS_VALIDATE_ERROR);

       List<String> msgList = new ArrayList<>();

       exception.getBindingResult().getFieldErrors().stream().forEach(error ->{
           msgList.add("Field -->" + error.getField() + ":" + error.getDefaultMessage());
           log.error("Field -->" + error.getField() + ":" + error.getDefaultMessage());
       });
        String message = msgList.parallelStream().collect(Collectors.joining(","));

        map.put("massage",message);

        return map;
    }
}
```

# 三，品牌管理

## 1.品牌查询

### 后台

mingrui-shop-common-core

pom.xml

```html
<!--帮助开发人员快速生成API文档-->
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger2</artifactId>
    <version>2.9.2</version>
</dependency>
```

com.baidu.shop.validate.group

 MingruiOperation

```java
public interface Search{}
```

在com.baidu.shop.base包下新建BaseDTO

```java
package com.baidu.shop.base;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

@Data
@ApiModel(value = "BaseDTO用于数据传输,其他dto需要继承此类")
public class BaseDTO {

    @ApiModelProperty(value = "当前页",example = "1")
    private Integer page;

    @ApiModelProperty(value = "每页显示多少条",example = "5")
    private Integer rows;

    @ApiModelProperty(value = "排序字段")
    private String sort;

    @ApiModelProperty(value = "是否升序")
    private String order;

    public String getOrder() {
        return sort + " " + (Boolean.valueOf(order) ? "desc":"asc");
    }
}
```

mingrui-shop-service-api

pom.xml

```html
<!--分页工具-->
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper-spring-boot-starter</artifactId>
    <version>1.2.10</version>
</dependency>
```

mingrui-shop-service-api-xxx

在com.baidu.shop下新建dto包

新建BrandDto

```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

@Data
@ApiModel(value = "品牌DTO")
public class BrandDto extends BaseDTO {

    @ApiModelProperty(value = "品牌ID",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "品牌名称",example = "1")
    @NotEmpty(message = "品牌名称不能为空",groups = {MingruiOperation.Add.class, MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "品牌图片")
    private String image;

    @ApiModelProperty(value = "品牌首字母")
    private Character letter;
}
```

com.baidu.shop.service包下新建BrandService

```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.github.pagehelper.PageInfo;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;

import java.util.List;

@Api(tags = "品牌接口")
public interface BrandService {
    @GetMapping(value = "brand/list")
    @ApiOperation(value = "查询品牌列表")
    Result<List<BrandEntity>> getBrandInfo(BrandDto brandDto);
}
```

mingrui-shop-service-xxx

在mapper包下新建BrandMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.BrandEntity;
import tk.mybatis.mapper.common.Mapper;

public interface BrandMapper extends Mapper<BrandEntity> {
}
```

com.baidu.shop.service.impl

新建BrandServiceImpl

```java
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.mapper.BrandMapper;
import com.baidu.shop.service.BrandService;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;
import javax.annotation.Resource;
import java.util.List;

@RestController
public class BrandServiceImpl extends BaseApiService implements BrandService{

    @Autowired
    private BrandMapper brandMapper;

    //查询品牌
    @Override
    public Result<List<BrandEntity>> getBrandInfo(BrandDto brandDto) {
        //mybatis如何自定义分页插件 --》 mybatis执行器
        PageHelper.startPage(brandDto.getPage(),brandDto.getRows());
        if (!StringUtils.isEmpty(brandDto.getSort()))PageHelper.orderBy(brandDto.getOrder());

        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDto, BrandEntity.class);

        Example example = new Example(BrandEntity.class);
        example.createCriteria().andLike("name","%" + brandEntity.getName() + "%");

        List<BrandEntity> brandEntities = brandMapper.selectByExample(example);
        PageInfo<BrandEntity> pageInfo = new PageInfo<>(brandEntities);
        return this.setResultSuccess(pageInfo);
    }
```

### 前台

官网地址: 

表格:https://v15.vuetifyjs.com/zh-Hans/components/data-tables 

输入框:https://v15.vuetifyjs.com/zh-Hans/components/snackbars 

按钮:https://v15.vuetifyjs.com/zh-Hans/components/buttons

在item包下新建MrBrand.vue

```html
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info" @click="dialog = true">新增</v-btn>
      <div class="text-xs-center">
        <v-dialog v-model="dialog" width="500">
          <v-card>
            <v-card-title class="headline grey lighten-2" primary-title>
            品牌 {{isEdit?'修改':'新增'}}
           </v-card-title>
            <mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail"/>
          </v-card>
        </v-dialog>
      </div>
      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />
      <!--append-icon : 图标 label : input默认值-->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <!-- 注意此处不能只能用官网的属性,应当参照Brand.vue的写法 -->
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <!-- :src 给元素绑定src属性 属性的值为props.item.image -->
        <td class="text-xs-center">
          <img width="200" :src="props.item.image" />
          </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="text-xs-center">
            <v-btn falt icon  @click="editDialog(props.item)" color="green">
                <v-icon>edit</v-icon>
            </v-btn>
            <v-btn falt icon @click="delDialog(props.item.id)" color="red">
                <v-icon>delete</v-icon>
            </v-btn>
        </td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from './MrBrandForm';
export default {
  name: "MrBrand",
  components:{
    MrBrandForm
  },
  data() {
    return {
      brandDetail:{},
      isEdit:false,
      dialog:false,
      pagination: {},
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
        {
          text: "操作",
          align: "center",
          sortable: false,
          value: "id",
        }
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    closeDialog(){
      this.dialog = false;
      this.getTableData()
    },
    addDialog(){
      this.isEdit = false;
      this.dialog = true;
    },
    editDialog(obj){
      this.brandDetail = obj;
      this.isEdit = true;
      this.dialog = true;
    },
    delDialog(id){
      this.$http.delete('brand/del?id=' + id).then(resp =>{
        if(resp.data.code == 200){
            this.getTableData()
            this.$message.success('删除成功')
        }else{
          this.$message.error(resp.data.msg)
        }
      }).catch(error => console.log(error))
    },
    getTableData() {
      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search,
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    },
  },
  watch: {
    pagination() {
      this.getTableData();
    },
  },
};
</script>
 
```

index.js line : 27

```
route("/item/brand",'/item/MrBrand',"MrBrand"),
```

## 2.品牌新增

### 后台

mingrui-shop-common-core

在utils包下新建BaiduBeanUtil

```java
package com.baidu.shop.utils;

import org.springframework.beans.BeanUtils;

public class BaiduBeanUtil<T>{
    public static <T> T copyProperties(Object source,Class<T> tClass) {
        T t=null;
        try {
            t = tClass.newInstance();//创建实例
            BeanUtils.copyProperties(source, t);
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }
        return t;
    }
}
```

mingrui-shop-service-api-xxx

com.baidu.shop.dto BrandDto

```java
@ApiModelProperty(value = "品牌分类信息")
@NotEmpty(message = "品牌分类信息不能为空",groups = {MingruiOperation.Add.class})
private String categories;
```

com.baidu.shop.entity包下新建CategoryBrandEntity

```java
package com.baidu.shop.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.persistence.Table;

@Data
@Table(name = "tb_category_brand")
@NoArgsConstructor
@AllArgsConstructor
public class CategoryBrandEntity {
    private Integer categoryId;

    private Integer brandId;
}
```

com.baidu.shop.service：BrandService

```java
@PostMapping(value = "brand/save")
@ApiOperation(value = "新增品牌")
Result<JsonObject> save(@RequestBody BrandDto brandDto);
```

mingrui-shop-service-xxx

在mapper包下新建CategoryBrandMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.CategoryBrandEntity;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

public interface CategoryBrandMapper extends InsertListMapper<CategoryBrandEntity>, Mapper<CategoryBrandEntity> {
}
```

com.baidu.shop.service.impl：BrandServiceImpl

```java
//新增品牌
    @Transactional
    @Override
    public Result<JsonObject> save(BrandDto brandDto) {

        //新增返回主键?
        //两种方式实现 select-key insert加两个属性
        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDto,BrandEntity.class);
        //处理品牌首字母
        brandDto.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandDto.getName().charAt(0)),PinyinUtil.TO_FUUL_PINYIN).charAt(0));

        brandMapper.insertSelective(brandEntity);
        //维护中间表数据
        this.insetrCategoryBrandList(brandDto.getCategories(),brandEntity.getId());
        return this.setResultSuccess();
    }
```

```java
//新增修改整合
private void insetrCategoryBrandList (String categories,Integer brandId){
    if (StringUtils.isEmpty(categories))throw new RuntimeException("分类信息不能为空");

    //判断分类集合字符串中是否包含,
    if(categories.contains(",")){
        categoryBrandMapper.insertList(
            //数组转list
            Arrays.asList(categories.split(","))
                    //获取stream流，流：对一次数据进行操作
                    .stream()
                    //遍历list中所有数据
                    .map(categoryById->new CategoryBrandEntity(Integer.valueOf(categoryById),brandId))
                    //最终转换成list
                    .collect(Collectors.toList())
        );
    }else{
        CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
        categoryBrandEntity.setCategoryId(Integer.valueOf(categories));
        categoryBrandEntity.setBrandId(brandId);

        categoryBrandMapper.insertSelective(categoryBrandEntity);
    }
}
```

### 前台

```vue
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info" @click="dialog = true">新增</v-btn>
      <div class="text-xs-center">
        <v-dialog v-model="dialog" width="500">
          <v-card>
            <v-card-title class="headline grey lighten-2" primary-title>
            品牌 {{isEdit?'修改':'新增'}}
           </v-card-title>
            <mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail"/>
          </v-card>
        </v-dialog>
      </div>
      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />
      <!--append-icon : 图标 label : input默认值-->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <!-- 注意此处不能只能用官网的属性,应当参照Brand.vue的写法 -->
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <!-- :src 给元素绑定src属性 属性的值为props.item.image -->
        <td class="text-xs-center">
          <img width="200" :src="props.item.image" />
          </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="text-xs-center">
            <v-btn falt icon  @click="editDialog(props.item)" color="green">
                <v-icon>edit</v-icon>
            </v-btn>
            <v-btn falt icon @click="delDialog(props.item.id)" color="red">
                <v-icon>delete</v-icon>
            </v-btn>
        </td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from './MrBrandForm';
export default {
  name: "MrBrand",
  components:{
    MrBrandForm
  },
  data() {
    return {
      brandDetail:{},
      isEdit:false,
      dialog:false,
      pagination: {},
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
        {
          text: "操作",
          align: "center",
          sortable: false,
          value: "id",
        }
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    closeDialog(){
      this.dialog = false;
      this.getTableData()
    },
    addDialog(){
      this.isEdit = false;
      this.dialog = true;
    },
    editDialog(obj){
      this.brandDetail = obj;
      this.isEdit = true;
      this.dialog = true;
    },
    delDialog(id){
      this.$http.delete('brand/del?id=' + id).then(resp =>{
        if(resp.data.code == 200){
            this.getTableData()
            this.$message.success('删除成功')
        }else{
          this.$message.error(resp.data.msg)
        }
      }).catch(error => console.log(error))
    },
    getTableData() {
      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search,
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    },
  },
  watch: {
    pagination() {
      this.getTableData();
    },
  },
};
</script>
 
```

Casecader.vue需要修改113行

![image-20210105144612657](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105144612657.png)

MrBrand.vue

```vue
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info" @click="dialog = true">新增</v-btn>
      <div class="text-xs-center">
        <v-dialog v-model="dialog" width="500">
          <v-card>
            <v-card-title class="headline grey lighten-2" primary-title>
            品牌 {{isEdit?'修改':'新增'}}
           </v-card-title>
            <mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail"/>
          </v-card>
        </v-dialog>
      </div>
      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />
      <!--append-icon : 图标 label : input默认值-->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <!-- 注意此处不能只能用官网的属性,应当参照Brand.vue的写法 -->
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <!-- :src 给元素绑定src属性 属性的值为props.item.image -->
        <td class="text-xs-center">
          <img width="200" :src="props.item.image" />
          </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="text-xs-center">
            <v-btn falt icon  @click="editDialog(props.item)" color="green">
                <v-icon>edit</v-icon>
            </v-btn>
            <v-btn falt icon @click="delDialog(props.item.id)" color="red">
                <v-icon>delete</v-icon>
            </v-btn>
        </td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from './MrBrandForm';
export default {
  name: "MrBrand",
  components:{
    MrBrandForm
  },
  data() {
    return {
      brandDetail:{},
      isEdit:false,
      dialog:false,
      pagination: {},
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
        {
          text: "操作",
          align: "center",
          sortable: false,
          value: "id",
        }
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    closeDialog(){
      this.dialog = false;
      this.getTableData()
    },
    addDialog(){
      this.isEdit = false;
      this.dialog = true;
    },
    editDialog(obj){
      this.brandDetail = obj;
      this.isEdit = true;
      this.dialog = true;
    },
    delDialog(id){
      this.$http.delete('brand/del?id=' + id).then(resp =>{
        if(resp.data.code == 200){
            this.getTableData()
            this.$message.success('删除成功')
        }else{
          this.$message.error(resp.data.msg)
        }
      }).catch(error => console.log(error))
    },
    getTableData() {
      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search,
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    },
  },
  watch: {
    pagination() {
      this.getTableData();
    },
  },
};
</script>
 
```

### 新增遗留的问题

品牌首字母自动识别

#### 后台

mingrui-shop-common-core

pom.xml

```html
<dependency>
    <groupId>com.belerweb</groupId>
    <artifactId>pinyin4j</artifactId>
    <version>2.5.1</version>
</dependency>
```

com.baidu.shop.utils包下新建PinyinUtil

```java
package com.baidu.shop.utils;

import net.sourceforge.pinyin4j.PinyinHelper;
import net.sourceforge.pinyin4j.format.HanyuPinyinOutputFormat;
import net.sourceforge.pinyin4j.format.HanyuPinyinToneType;
import java.util.regex.Matcher;
import java.util.regex.Pattern;


public class PinyinUtil {
    public static final Boolean TO_FUUL_PINYIN = true;
    public static final Boolean TO_FIRST_CHAR_PINYIN = false;
    /**
     * 获取汉字首字母或全拼大写字母
     *
     * @param chinese 汉字
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母大写字符窜
     */
    public static String getUpperCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toUpperCase();
    }
    /**
     * 获取汉字首字母或全拼小写字母
     *
     * @param chinese 汉字
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母小写字符窜
     */
    public static String getLowerCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toLowerCase();
    }
    /**
     * 将汉字转成拼音
     * <p>
     * 取首字母或全拼
     *
     * @param hanzi 汉字字符串
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 拼音
     */
    private static String convertHanzi2Pinyin(String hanzi, boolean isFull) {
/***
 * ^[\u2E80-\u9FFF]+$ 匹配所有东亚区的语言
 * ^[\u4E00-\u9FFF]+$ 匹配简体和繁体
 * ^[\u4E00-\u9FA5]+$ 匹配简体
 */
        String regExp = "^[\u4E00-\u9FFF]+$";
        StringBuffer sb = new StringBuffer();
        if (hanzi == null || "".equals(hanzi.trim())) {
            return "";
        }
        String pinyin = "";
        for (int i = 0; i < hanzi.length(); i++) {
            char unit = hanzi.charAt(i);
//是汉字，则转拼音
            if (match(String.valueOf(unit), regExp)) {
                pinyin = convertSingleHanzi2Pinyin(unit);
                if (isFull) {
                    sb.append(pinyin);
                } else {
                    sb.append(pinyin.charAt(0));
                }
            } else {
                sb.append(unit);
            }
        }
        return sb.toString();
    }
    /**
     * 将单个汉字转成拼音
     *
     * @param hanzi 汉字字符
     * @return 拼音
     */
    private static String convertSingleHanzi2Pinyin(char hanzi) {
        HanyuPinyinOutputFormat outputFormat = new HanyuPinyinOutputFormat();
        outputFormat.setToneType(HanyuPinyinToneType.WITHOUT_TONE);
        String[] res;
        StringBuffer sb = new StringBuffer();
        try {
            res = PinyinHelper.toHanyuPinyinStringArray(hanzi, outputFormat);
            sb.append(res[0]);//对于多音字，只用第一个拼音
        } catch (Exception e) {
            e.printStackTrace();
            return "";
        }
        return sb.toString();
    }
    /***
     * 匹配
     * <P>
     * 根据字符和正则表达式进行匹配
     *
     * @param str 源字符串
    4.1.3 mingrui-shop-service-xxx
    4.1.3.1 BrandServiceImpl
     * @param regex 正则表达式
     *
     * @return true：匹配成功 false：匹配失败
     */
    private static boolean match(String str, String regex) {
        Pattern pattern = Pattern.compile(regex);
        Matcher matcher = pattern.matcher(str);
        return matcher.find();
    }

}
```

mingrui-shop-service-xxx

com.baidu.shop.service.impl

```java
@Override
public Result<JSONObject> save(BrandDTO brandDTO) {
    //str.charAt(0)获取当前字符串第一个字符
    //String.valueOf()将对象转换为String类型的字符串
    //
    // char c = brandDTO.getName().charAt(0);
    // String s = String.valueOf(c);
    // String upperCase = PinyinUtil.getUpperCase(s,
    PinyinUtil.TO_FIRST_CHAR_PINYIN);
    // char c1 = upperCase.charAt(0);
    // brandDTO.setLetter(c1);
    brandDTO.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandDTO.getName().ch
    arAt(0)),PinyinUtil.TO_FIRST_CHAR_PINYIN).charAt(0));
    try {
        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO,
        BrandEntity.class);
        //通用mapper新增返回主键
        brandMapper.insertSelective(brandEntity);
            //绑定关系
            if(StringUtils.isEmpty(brandDTO.getCategories())){
            	return this.setResultError("分类数据不能为空");
            }
            if(brandDTO.getCategories().contains(",")){
                List<CategoryBrandEntity> list = new ArrayList<>();
                String[] categoryArr = brandDTO.getCategories().split(",");
                Arrays.asList(categoryArr).stream().forEach(str -> {
                    CategoryBrandEntity categoryBrandEntity = new
                    CategoryBrandEntity();
                    categoryBrandEntity.setBrandId(brandEntity.getId());
                    categoryBrandEntity.setCategoryId(Integer.parseInt(str));
                    list.add(categoryBrandEntity);
            	});
   	 		categoryBrandMapper.insertList(list);
    		}
    } catch (Exception e) {
   	 	e.printStackTrace();
    }
    return this.setResultSuccess();
}
```

#### 前台

将MrBrandForm.vue组件中所有关于首字母的内容删除掉

```html
<template>
    <div>
            <v-form v-model="valid" ref="form">
                <v-text-field v-model="brand.name" label="品牌名称" :rules="nameRules" required></v-text-field>
                <v-cascader url="/category/list" required v-model="brand.categories" multiple label="商品分类"/>
                <!-- 文件上传 -->
                <v-layout row>
                    <v-flex xs3>
                      <span style="font-size: 16px; color: #444">品牌LOGO:</span>
                    </v-flex>
                    <v-flex>
                        <v-upload
                          v-model="brand.image"
                          url="/upload"
                          :multiple="false"
                          :pic-width="250"
                          :pic-height="100"
                        />
                    </v-flex>
                </v-layout> 
            </v-form>
         <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn small @click="cancel()">取消</v-btn>
          <v-btn small color="red"  @click="submitForm">确认</v-btn>
        </v-card-actions>
    </div>
</template>
<script>
  export default {
    name:"MrBrandForm",
    props:{
      //父组件传递过来的模态框状态
      dialog: Boolean,
      brandDetail: Object,
      isEdit: Boolean
    },
    watch:{
      dialog(val){
        if(val) this.$refs.form.reset();
      },
      brandDetail(val){
        if(this.isEdit){
            this.$http.get('category/getByBrand',{
              params:{
                brandId:val.id
              }
            }).then(resp =>{
              console.log(resp);
              let brand = val;
              brand.categories = resp.data.data;
              this.brand = brand;
            }).catch(error => console.log(error))
            // this.brand=val;
        }
      }
    },
    data () {
      //在js中 null == false , '' == false , undefined == false , 0 == false
      return {
        valid: true,
        nameRules:[
          (v) => !!v || '品牌名称不能为空',
          (v) => (v && v.length <= 10) || '品牌名称长度最长10'
        ],
        brand:{
            name:"",
            letter:"",
            categories:[],
          
        }
      }
    },
    methods:{
        cancel(){
            this.$emit("closeDialog");
        },
        submitForm(){
            if(!this.$refs.form.validate()){
                return;
            }
            let fromData = this.brand;
            let categoryIdArr = this.brand.categories.map(category =>category.id);
            fromData.categories = categoryIdArr.join();

            //$.ajax() 和 $.get() | $.post()方法的区别?
            this.$http({
              url:'/brand/save',
              data:fromData,
              method:this.isEdit ? 'put':'post'
              }).then(resp=>{
                if(resp.data.code != 200){
                    return;
                }
                   //关闭模态框
                    this.cancel();
            }).catch(error => console.log(error))
        }
    }   
  }
</script>
```

### 清空form和表单验证的问题

#### 前台

MrBrand.vue

```html
<mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail"/>
```

MrBrandFrom.vue

```html
<template>
    <div>
            <v-form v-model="valid" ref="form">
                <v-text-field v-model="brand.name" label="品牌名称" :rules="nameRules" required></v-text-field>
                <v-cascader url="/category/list" required v-model="brand.categories" multiple label="商品分类"/>
                <!-- 文件上传 -->
                <v-layout row>
                    <v-flex xs3>
                      <span style="font-size: 16px; color: #444">品牌LOGO:</span>
                    </v-flex>
                    <v-flex>
                        <v-upload
                          v-model="brand.image"
                          url="/upload"
                          :multiple="false"
                          :pic-width="250"
                          :pic-height="100"
                        />
                    </v-flex>
                </v-layout> 
            </v-form>
         <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn small @click="cancel()">取消</v-btn>
          <v-btn small color="red"  @click="submitForm">确认</v-btn>
        </v-card-actions>
    </div>
</template>
<script>
  export default {
    name:"MrBrandForm",
    props:{
      //父组件传递过来的模态框状态
      dialog: Boolean,
      brandDetail: Object,
      isEdit: Boolean
    },
    watch:{
      dialog(val){
        if(val) this.$refs.form.reset();
      },
      brandDetail(val){
        if(this.isEdit){
            this.$http.get('category/getByBrand',{
              params:{
                brandId:val.id
              }
            }).then(resp =>{
              console.log(resp);
              let brand = val;
              brand.categories = resp.data.data;
              this.brand = brand;
            }).catch(error => console.log(error))
            // this.brand=val;
        }
      }
    },
    data () {
      //在js中 null == false , '' == false , undefined == false , 0 == false
      return {
        valid: true,
        nameRules:[
          (v) => !!v || '品牌名称不能为空',
          (v) => (v && v.length <= 10) || '品牌名称长度最长10'
        ],
        brand:{
            name:"",
            letter:"",
            categories:[],
          
        }
      }
    },
    methods:{
        cancel(){
            this.$emit("closeDialog");
        },
        submitForm(){
            if(!this.$refs.form.validate()){
                return;
            }
            let fromData = this.brand;
            let categoryIdArr = this.brand.categories.map(category =>category.id);
            fromData.categories = categoryIdArr.join();

            //$.ajax() 和 $.get() | $.post()方法的区别?
            this.$http({
              url:'/brand/save',
              data:fromData,
              method:this.isEdit ? 'put':'post'
              }).then(resp=>{
                if(resp.data.code != 200){
                    return;
                }
                   //关闭模态框
                    this.cancel();
            }).catch(error => console.log(error))
        }
    }   
  }
</script>
```

Cascader.vue(bug) line:162

```java
 if(val && this.showAllLevels && !this.multiple){
            this.selected = [val.map(o => o[this.itemText]).join("/")]
          } else if (this.multiple && typeof val == 'object') {
            this.selected = val.map(o => {
              return {
                label: o[this.itemText],
                value: o[this.itemValue]
              }
            })
          } else {
            if(typeof val == 'object'){
              this.selected = [val[this.itemText]]
            }
          }
```

### 上传图片

#### 后台

在mingrui-shop-basics下新建mingrui-shop-basic-uploadserver

![image-20210105151108725](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105151108725.png)

![image-20210105151126126](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105151126126.png)

pom.xml

```html
<dependencies>
    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>com.baidu</groupId>
        <artifactId>mingrui-shop-common-core</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
</dpendencies>
```

![image-20210105151217064](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105151217064.png)

application.yml

```yml
server:
  port: 8200
spring:
  application:
    name: upload-server
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
mingrui:
  upload:
    path:
      windows: E:\\images
      linux: /lihuimin/images
    img:
      host: http://image.mrshop.com
```

com.baidu新建启动类RunBasicUploadServer

```java

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

@SpringBootApplication
@EnableEurekaClient
public class RunBasicUploadServer {
    public static void main(String[] args) {
        SpringApplication.run(RunBasicUploadServer.class);
    }
}
```

新建包com.baidu.shop.upload.controller新建UploadController

```java
package com.baidu.shop.upload.controller;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import java.io.File;
import java.io.IOException;
import java.util.UUID;


@RestController
@RequestMapping(value = "upload")
public class UploadController extends BaseApiService {

    //linux系统的上传目录
    @Value(value = "${mingrui.upload.path.windows}")
    private String windowsPath;
    //window系统的上传目录
    @Value(value = "${mingrui.upload.path.linux}")
    private String linuxPath;
    //图片服务器的地址
    @Value(value = "${mingrui.upload.img.host}")
    private String imgHost;

    @PostMapping
    public Result<String> uploadImg(@RequestParam MultipartFile file) {
        if(file.isEmpty()) return this.setResultError("上传的文件为空");//判断上传的文件是否为空
        String filename = file.getOriginalFilename();//获取文件名
        String path = "";
        String os = System.getProperty("os.name").toLowerCase();
        if(os.indexOf("win") != -1){
            path = windowsPath;
        }else if(os.indexOf("lin") != -1){
            path = linuxPath;
        }
        filename = UUID.randomUUID() + filename;//防止文件名重复
//创建文件 路径+分隔符(linux和window的目录分隔符不一样)+文件名
        File dest = new File(path + File.separator + filename);
//判断文件夹是否存在,不存在的话就创建
        if(!dest.getParentFile().exists()) dest.getParentFile().mkdirs();
        try {
            file.transferTo(dest);//上传
        } catch (IllegalStateException e) {
// TODO Auto-generated catch block
            e.printStackTrace();
        } catch (IOException e) {
// TODO Auto-generated catch block
            e.printStackTrace();
        }
        return this.setResult(HTTPStatus.OK,"upload success!!!",imgHost + "/" +
                filename);//将文件名返回页面用于页面回显
    }
}
```

新建包:com.baidu.global新建GlobalCorsConfig

```java
package com.baidu.global;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;


@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);
        //3.返回新的CorsFilter.
        return new CorsFilter(source);
    }

}
```

使用postman测试上传

post请求localhost:8200(端口)/upload(UploadController方法名)/file(UploadController参数)

![image-20210105151831167](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105151831167.png)upload

![image-20210105151927370](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105151927370.png)file

![image-20210105151632327](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105151632327.png)

hosts文件中新增

```c
127.0.0.1 image.mrshop.com
```

nginx-home/conf/nginx.conf新增

```c

server { 
	listen 80; 
	server_name image.mrshop.com; 
	
	proxy_set_header X-Forwarded-Host $host; 
	proxy_set_header X-Forwarded-Server $host; 
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
	location ~ .*\.(gif|jpg|pdf|jpeg|png)$ { 
        #root D:/nginx-1.15.5/temp/images/;#指定图片存放路径(可以放在nginx文件夹路 径里也可以放其他p盘) root 				E:\images; 
	} 
		location / { 
			root html; 
			index index.html index.htm; 
		} 
	}
```

重启nginx

```
nginx.exe -s reload
```

浏览器输入http://image.mrshop.com/imageName.jpg测试

![image-20210105152325586](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105152325586.png)

启动vue项目测试能否成功 ？

不能成功,还是请求了网关,

网关会吧api-xxx的请求转发到service-xxx的服务中,而service-xxx并没有 upload服务 

**![image-20210105152409310](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105152409310.png)**

所以我想只要包含/upload请求的我都不进行路由

mingrui-shop-basic-zuul-server的application.yml

```yml


zuul:
  # 声明路由
  routes:
    # 路由名称
    api-xxx:
      # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
      path: /api-xxx/**
      serviceId: xxx-server
  # 启用重试
  retryable: true
  # 包含此路径的不进行路由
  ignored-patterns: /upload/**
  # 忽略上传服务
  ignored-services:
    -upload-server
```

在nginx-home/conf/nginx.conf 添加api.mrshop.com的代理配置

```c
# 上传路径的映射 
# 只要包含/api-xxx/upload 都会把请求映射到8200服务 
# rewrite "^/api-xxx/(.*)$" /$1 break;
# 将/api-xxx 替换成/ 
location /api-xxx/upload { 
	proxy_pass http://127.0.0.1:8200; 
	proxy_connect_timeout 600; 
	proxy_read_timeout 600; rewrite "^/api-xxx/(.*)$" /$1 break; 
}
```

重启nginx

![image-20210105152721612](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105152721612.png)

## 3.品牌修改

### 回显

#### 后台

mingrui-shop-service-api-xxx

Service：CategoryService

```java
@ApiOperation(value = "通过品牌id查询商品分类")
@GetMapping(value = "category/getByBrand")
Result<List<CategoryEntity>> getByBrand (Integer brandId);
```

mingrui-shop-service-xxx

com.baidu.shop.mapper：CategoryMapper

```java
@Select(value = "select id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
```

com.baidu.shop.service.impl：CategoryServiceImpl

```java
//通过品牌查询商品id
@Override
public Result<List<CategoryEntity>> getByBrand(Integer brandId) {
    List<CategoryEntity> byBrandId = categoryMapper.getByBrandId(brandId);
    return this.setResultSuccess(byBrandI);
}
```

#### 前台

 MrBrand.vue

```html
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info" @click="dialog = true">新增</v-btn>
      <div class="text-xs-center">
        <v-dialog v-model="dialog" width="500">
          <v-card>
            <v-card-title class="headline grey lighten-2" primary-title>
            品牌 {{isEdit?'修改':'新增'}}
           </v-card-title>
            <mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail"/>
          </v-card>
        </v-dialog>
      </div>
      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />
      <!--append-icon : 图标 label : input默认值-->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <!-- 注意此处不能只能用官网的属性,应当参照Brand.vue的写法 -->
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <!-- :src 给元素绑定src属性 属性的值为props.item.image -->
        <td class="text-xs-center">
          <img width="200" :src="props.item.image" />
          </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="text-xs-center">
            <v-btn falt icon  @click="editDialog(props.item)" color="green">
                <v-icon>edit</v-icon>
            </v-btn>
            <v-btn falt icon @click="delDialog(props.item.id)" color="red">
                <v-icon>delete</v-icon>
            </v-btn>
        </td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from './MrBrandForm';
export default {
  name: "MrBrand",
  components:{
    MrBrandForm
  },
  data() {
    return {
      brandDetail:{},
      isEdit:false,
      dialog:false,
      pagination: {},
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
        {
          text: "操作",
          align: "center",
          sortable: false,
          value: "id",
        }
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    closeDialog(){
      this.dialog = false;
      this.getTableData()
    },
    addDialog(){
      this.isEdit = false;
      this.dialog = true;
    },
    editDialog(obj){
      this.brandDetail = obj;
      this.isEdit = true;
      this.dialog = true;
    },
    delDialog(id){
      this.$http.delete('brand/del?id=' + id).then(resp =>{
        if(resp.data.code == 200){
            this.getTableData()
            this.$message.success('删除成功')
        }else{
          this.$message.error(resp.data.msg)
        }
      }).catch(error => console.log(error))
    },
    getTableData() {
      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search,
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    },
  },
  watch: {
    pagination() {
      this.getTableData();
    },
  },
};
</script>
 
```

MrBrandForm.vue

```html
<template>
    <div>
            <v-form v-model="valid" ref="form">
                <v-text-field v-model="brand.name" label="品牌名称" :rules="nameRules" required></v-text-field>
                <v-cascader url="/category/list" required v-model="brand.categories" multiple label="商品分类"/>
                <!-- 文件上传 -->
                <v-layout row>
                    <v-flex xs3>
                      <span style="font-size: 16px; color: #444">品牌LOGO:</span>
                    </v-flex>
                    <v-flex>
                        <v-upload
                          v-model="brand.image"
                          url="/upload"
                          :multiple="false"
                          :pic-width="250"
                          :pic-height="100"
                        />
                    </v-flex>
                </v-layout> 
            </v-form>
         <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn small @click="cancel()">取消</v-btn>
          <v-btn small color="red"  @click="submitForm">确认</v-btn>
        </v-card-actions>
    </div>
</template>
<script>
  export default {
    name:"MrBrandForm",
    props:{
      //父组件传递过来的模态框状态
      dialog: Boolean,
      brandDetail: Object,
      isEdit: Boolean
    },
    watch:{
      dialog(val){
        if(val) this.$refs.form.reset();
      },
      brandDetail(val){
        if(this.isEdit){
            this.$http.get('category/getByBrand',{
              params:{
                brandId:val.id
              }
            }).then(resp =>{
              console.log(resp);
              let brand = val;
              brand.categories = resp.data.data;
              this.brand = brand;
            }).catch(error => console.log(error))
            // this.brand=val;
        }
      }
    },
    data () {
      //在js中 null == false , '' == false , undefined == false , 0 == false
      return {
        valid: true,
        nameRules:[
          (v) => !!v || '品牌名称不能为空',
          (v) => (v && v.length <= 10) || '品牌名称长度最长10'
        ],
        brand:{
            name:"",
            letter:"",
            categories:[],
          
        }
      }
    },
    methods:{
        cancel(){
            this.$emit("closeDialog");
        },
        submitForm(){
            if(!this.$refs.form.validate()){
                return;
            }
            let fromData = this.brand;
            let categoryIdArr = this.brand.categories.map(category =>category.id);
            fromData.categories = categoryIdArr.join();

            //$.ajax() 和 $.get() | $.post()方法的区别?
            this.$http({
              url:'/brand/save',
              data:fromData,
              method:this.isEdit ? 'put':'post'
              }).then(resp=>{
                if(resp.data.code != 200){
                    return;
                }
                   //关闭模态框
                    this.cancel();
            }).catch(error => console.log(error))
        }
    }   
  }
</script>
```

### 修改

#### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.service：BrandService

```java
@PutMapping(value = "brand/save")
@ApiOperation(value = "修改品牌")
Result<JsonObject> eidt(@RequestBody BrandDto brandDto);
```

mingrui-shop-service-xxx

com.baidu.shop.service.impl：BrandServiceImpl

```java
//修改品牌
@Transactional
@Override
public Result<JsonObject> eidt(BrandDto brandDto) {


    BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDto, BrandEntity.class);

    brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
    brandMapper.updateByPrimaryKeySelective(brandEntity);
    //先通过brandId删除中间表的数据
    this.delteCategoryByBrandId(brandEntity.getId());
    //批量新增 / 新增
    this.insetrCategoryBrandList(brandDto.getCategories(),brandEntity.getId());
    return this.setResultSuccess();
}
```

```java
//新增修改整合
private void insetrCategoryBrandList (String categories,Integer brandId){
    if (StringUtils.isEmpty(categories))throw new RuntimeException("分类信息不能为空");

    //判断分类集合字符串中是否包含,
    if(categories.contains(",")){
        categoryBrandMapper.insertList(
            //数组转list
            Arrays.asList(categories.split(","))
                    //获取stream流，流：对一次数据进行操作
                    .stream()
                    //遍历list中所有数据
                    .map(categoryById->new CategoryBrandEntity(Integer.valueOf(categoryById),brandId))
                    //最终转换成list
                    .collect(Collectors.toList())
        );
    }else{
        CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
        categoryBrandEntity.setCategoryId(Integer.valueOf(categories));
        categoryBrandEntity.setBrandId(brandId);

        categoryBrandMapper.insertSelective(categoryBrandEntity);
    }
}
```

#### 前台

```html
submitForm(){
            if(!this.$refs.form.validate()){
                return;
            }
            let fromData = this.brand;
            let categoryIdArr = this.brand.categories.map(category =>category.id);
            fromData.categories = categoryIdArr.join();

            //$.ajax() 和 $.get() | $.post()方法的区别?
            this.$http({
              url:'/brand/save',
              data:fromData,
              method:this.isEdit ? 'put':'post'
              }).then(resp=>{
                if(resp.data.code != 200){
                    return;
                }
                   //关闭模态框
                    this.cancel();
            }).catch(error => console.log(error))
        }
```

## 4.品牌删除

### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.service：BrandService

```java
@DeleteMapping(value = "brand/del")
@ApiOperation(value = "删除品牌")
Result<JsonObject> del( Integer id);
```

mingrui-shop-service-xxx：BrandServiceImpl

```java
//删除品牌
@Override
public Result<JsonObject> del(Integer id) {
    //删除品牌信息
    brandMapper.deleteByPrimaryKey(id);
    this.delteCategoryByBrandId(id);
    return this.setResultSuccess();
}

private void  delteCategoryByBrandId (Integer brandId){
    Example example = new Example(CategoryBrandEntity.class);
    example.createCriteria().andEqualTo("brandId",brandId);
    categoryBrandMapper.deleteByExample(example);
}
```

### 前台

```vue
<v-btn falt icon @click="delDialog(props.item.id)" color="red">
                <v-icon>delete</v-icon>
            </v-btn>
```

```js
delDialog(id){
      this.$http.delete('brand/del?id=' + id).then(resp =>{
        if(resp.data.code == 200){
            this.getTableData()
            this.$message.success('删除成功')
        }else{
          this.$message.error(resp.data.msg)
        }
      }).catch(error => console.log(error))
    },
```

# 四，规格参数

##  1.规格组(查询)

### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.entity新建：SpecGroupEntity

```java
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

@Table(name = "tb_spec_group")
@Data
public class SpecGroupEntity {
    @Id
    private Integer id;

    private Integer cid;

    private String name;
}
```

com.baidu.shop.dto新建：SpecGroupDto

```java
import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

@ApiModel(value = "规格分组")
@Data
public class SpecGroupDto extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "类型id",example = "1")
    @NotNull(message = "类型id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid;

    @ApiModelProperty(value = "规格组名称",example = "1")
    @NotEmpty(message = "规格组名称不能为空",groups = {MingruiOperation.Add.class})
    private String name;
}
```

com.baidu.shop.service新建：SpecGroupService

```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpecGroupDto;
import com.baidu.shop.entity.SpecGroupEntity;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiModelProperty;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Api(value ="规格组接口")
public interface SpecGroupService {

    @ApiModelProperty(value = "规格组查询")
    @GetMapping(value = "specGroup/getSpecGroupInfo")
    Result<List<SpecGroupEntity>> getSpecGroupInfo(SpecGroupDto specGroupDto);
}
```

mingrui-shop-service-xxx

com.baidu.shop.mapper新建：SpecGroupMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpecGroupEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecGroupMapper extends Mapper<SpecGroupEntity> {
}
```

com.baidu.shop.service.impl新建：SpecGroupServiceImpl

```java
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpecGroupDTO;
import com.baidu.shop.entity.SpecGroupEntity;
import com.baidu.shop.mapper.SpecGroupMapper;
import com.baidu.shop.service.SpecificationService;
import com.baidu.shop.utils.ObjectUtil;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;
import javax.annotation.Resource;
import java.util.List;

@RestController
public class SpecGroupServiceImpl extends BaseApiService implements SpecGroupService {

    @Resource
    private SpecGroupMapper specGroupMapper;
    
    //规格组查询
    @Override
    public Result<List<SpecGroupEntity>> getSpecGroupInfo(SpecGroupDto specGroupDto) {
        Example example = new Example(SpecGroupEntity.class);

        if (ObjectUtil.isNotNull(specGroupDto.getCid()))
                example
                .createCriteria()
                .andEqualTo("cid", BaiduBeanUtil.copyProperties(specGroupDto,SpecGroupEntity.class).getCid());

        List<SpecGroupEntity> specGroupExample = specGroupMapper.selectByExample(example);
        return this.setResultSuccess(specGroupExample);
    }
}
```

### 前台

加载分类信息

index.js line:29

```html
route("/item/specification",'/item/specification/Specification',"Specification"),
```

 specification/Specification.vue

```
<v-tree url="/specGroup/getSpecGroupInfo" :isEdit="false" @handleClick="handleClick"/>
```

![image-20210105191020247](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105191020247.png)

规格组(查询)

SpecGroup.vue

```js
loadData(){
          this.$http.get("/specGroup/getSpecGroupInfo",{
              params:{
                  cid:this.cid
              }
          })
          .then((resp) => {
              this.groups = resp.data.data;
          })
          .catch(() => {
              this.groups = [];
          })
      },
```

## 2.规格组(新增,删除,修改)

### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.service：SpecGroupService

```java
@ApiModelProperty(value = "新增规格组")
@PostMapping(value = "specGroup/save")
Result<JsonObject> saveSpecGroup(@RequestBody SpecGroupDto specGroupDto);

@ApiModelProperty(value = "修改规格组")
@PutMapping(value = "specGroup/save")
Result<JsonObject> editSpecGroup(@RequestBody SpecGroupDto specGroupDto);

@ApiModelProperty(value = "删除规格组")
@DeleteMapping("specGroup/delete/{id}")
Result<JsonObject> delSpecRoupById(@PathVariable Integer id);
```

mingrui-shop-service-xxx

com.baidu.shop.service.impl：SpecGroupServiceImpl

```java
//规格组新增
@Transactional
@Override
public Result<JsonObject> saveSpecGroup(SpecGroupDto specGroupDto) {
    specGroupMapper.insertSelective(BaiduBeanUtil.copyProperties(specGroupDto,SpecGroupEntity.class));
    return this.setResultSuccess();
}

//规格组修改
@Override
public Result<JsonObject> editSpecGroup(SpecGroupDto specGroupDto) {
    specGroupMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specGroupDto,SpecGroupEntity.class));
    return this.setResultSuccess();
}

//规格组删除

@Override
public Result<JsonObject> delSpecRoupById(Integer id) {
    //删除规格组之前要先判断一下当前规格组下是否有规格参数
    //true : 不能被删除
    //false -->
    Example example = new Example(SpecParamEntity.class);
    example.createCriteria().andEqualTo("groupId",id);
    List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
    if (specParamEntities.size() >0){
        return this.setResultError("当前规格组有数据不能被删除");
    }

    specGroupMapper.deleteByPrimaryKey(id);
    return this.setResultSuccess();
}
```

### 前台

 SpecGroup.vue

```js
 save(){
           this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: 'specGroup/save',
            data: this.group
          }).then((resp) => {
            // 关闭窗口
            if(resp.data.code == 200){
                this.show = false;
                this.$message.success("保存成功！");
                this.loadData();
            }
           
          }).catch(() => {
              this.$message.error("保存失败！");
            });
      },
      deleteGroup(id){
          this.$message.confirm("确认要删除分组吗？")
          .then(() => {
            this.$http.delete("/specGroup/delete/ " + id)
                .then((resp) => {
                    if(resp.data.code!=200){
                        this.$message.error(resp.data.message);
                        this.loadData();
                        return
                    }
                    this.loadData();
                    this.$message.success("删除成功")
                })
          })
      },
```

## 3. 规格参数(查询)

### 后台



mingrui-shop-service-api-xxx

com.baidu.shop.entity新建:SpecParamEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Column;
import javax.persistence.Id;
import javax.persistence.Table;

@Table(name = "tb_spec_param")
@Data
public class SpecParamEntity {

    @Id
    private Integer id;

    private Integer cid;

    private Integer groupId;

    private String name;

    @Column(name = "`numeric`")
    private Boolean numeric;

    private String unit;

    private Boolean generic;

    private Boolean searching;

    private String segments;
}
```

com.baidu.shop.dto新建:SpecParamDto

```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;


import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

@Data
@ApiModel(value = "规格参数")
public class SpecParamDto extends BaseDTO {
    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类id",example = "1")
    @NotNull(message = "分类id不能为空",groups = {MingruiOperation.Update.class})
    private Integer cid;

    @ApiModelProperty(value = "规格组id",example = "1")
    @NotNull(message = "规格组id不能为空",groups = {MingruiOperation.Update.class})
    private Integer groupId;

    @ApiModelProperty(value = "规格组参数名称",example = "1")
    @NotEmpty(message = "规格组参数名称不能为空",groups = {MingruiOperation.Add.class})
    private String name;

    @ApiModelProperty(value = "是否是数字类型参数，1->true或0->false",example = "0")
    @NotNull(message = "是否是数字类型参数不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean numeric;

    @ApiModelProperty(value = "数字类型参数的单位，非数字类型可以为空",example = "1")
    @NotEmpty(message = "数字类型参数的单位不能为空",groups = {MingruiOperation.Add.class})
    private String unit;

    @ApiModelProperty(value = "是否是sku通用属性，1->true或0->false",example = "0")
    @NotNull(message = "是否是sku通用属性不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean generic;

    @ApiModelProperty(value = "是否用于搜索过滤，true或false",example = "0")
    @NotNull(message = "是否用于搜索过滤不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean searching;

    @ApiModelProperty(value = "数值类型参数",example = "1")
    @NotEmpty(message = "数值类型参数不能为空",groups = {MingruiOperation.Add.class})
    private String segments;
}
```

com.baidu.shop.service新建:SpecParamService

```java
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Api(value = "规格参数接口")
public interface SpecParamService {
    @ApiOperation(value = "查询规格参数")
    @GetMapping(value = "specParam/getSpecParamInfo")
    Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDto specParamDto);
}
```

mingrui-shop-service-xxx

com.baidu.shop.mapper包下新建SpecParamMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpecParamEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecParamMapper extends Mapper<SpecParamEntity> {
    
}
```

com.baidu.shop.service.impl新建:SpecParamServiceImpl

```java
@RestController
public class SpecParamServiceImpl extends BaseApiService implements SpecParamService {

    @Resource
    private SpecParamMapper specParamMapper;

    //查询规格参数
    @Override
    public Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDto specParamDto) {
        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",specParamDto.getGroupId());
        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
        return this.setResultSuccess(specParamEntities);
    }
}
```

### 前台

SpecParam.vue

```js
 loadData() {
      this.$http
        .get("/specParam/getSpecParamInfo",{
           params:{
             groupId:this.group.id
           }
        })
        .then((resp) => {
          resp.data.data.forEach(p => {
              p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
          })
      
          this.params =resp.data.data;
        })
        .catch(() => {
          this.params = [];
        });
    },
```

## 4.规格参数(增,删,改)

#### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.service：SpecParamService

```java
@ApiOperation(value = "新增规格参数")
@PostMapping(value = "specParam/save")
Result<JsonObject> saveSpecParam(@RequestBody SpecParamDto specParamDto);

@ApiOperation(value = "修改规格参数")
@PutMapping(value = "specParam/save")
Result<JsonObject> editSpecParam(@RequestBody SpecParamDto specParamDto);

@ApiOperation(value = "删除规格参数")
@DeleteMapping(value = "specParam/delete")
Result<JsonObject> delSpecParam(Integer id);
```

mingrui-shop-service-xxx

com.baidu.shop.service.impl：SpecParamServiceImpl

```java

//新增规格参数
@Transactional
@Override
public Result<JsonObject> saveSpecParam(SpecParamDto specParamDto) {
    specParamMapper.insertSelective(BaiduBeanUtil.copyProperties(specParamDto,SpecParamEntity.class));
    return this.setResultSuccess();
}

//修改规格参数
@Transactional
@Override
public Result<JsonObject> editSpecParam(SpecParamDto specParamDto) {
    specParamMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specParamDto,SpecParamEntity.class));
    return this.setResultSuccess();
}

//删除规格参数
@Transactional
@Override
public Result<JsonObject> delSpecParam(Integer id) {
    specParamMapper.deleteByPrimaryKey(id);
    return this.setResultSuccess();
}
```



#### 前台

SpecParam.vue

```js
methods: {
    loadData() {
      this.$http
        .get("/specParam/getSpecParamInfo",{
           params:{
             groupId:this.group.id
           }
        })
        .then((resp) => {
          resp.data.data.forEach(p => {
              p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
          })
      
          this.params =resp.data.data;
        })
        .catch(() => {
          this.params = [];
        });
    },
    editParam(param) {
        this.param = param;
        this.isEdit = true;
        this.show = true;
    },
    addParam() {
      this.param = {
          cid: this.group.cid,
          groupId: this.group.id,
          segments:[],
          numeric:false,
          searching:false,
          generic:false}
      this.show = true;
    },
    deleteParam(id) {
        this.$message.confirm("确认要删除该参数吗？")
        .then(() => {
            this.$http.delete("/specParam/delete?id=" + id)
            .then((resp) => {
              if(resp.data.code == 200){
                  this.$message.success("删除成功");
                  this.loadData();
              } 
              
            })
            .catch(() => {
                this.$message.error("删除失败");
            })
        })
    },
    formatBoolean(boo) {
      return boo ? "是" : "否";
    },
    save(){
        const p = {};
        Object.assign(p, this.param);
        p.segments = p.segments.map(s => s.join("-")).join(",")
        this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/specParam/save',
            data: p,
        }).then((resp) => {
            // 关闭窗口
            if(resp.data.code == 200){
                this.show = false;
                this.$message.success("保存成功！");
                this.loadData();
            }
          }).catch(() => {
              this.$message.error("保存失败！");
            });
    }
  }
```

# 五,商品管理

## 1.商品查询

### 后台

新建GoodsEntity

```java
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

/**
 * 2 * @ClassName GoodsEntity
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/5
 * 6 * @Version V1.0
 * 7
 **/
@Table(name = "tb_spu")
@Data
public class GoodsEntity {
    @Id
    private Integer id;


    private String title;

    private String subTitle;


    private Integer cid1;

    private Integer cid2;

    private Integer cid3;

    private Integer brandId;

    private Integer saleable;

    private Integer valid;

    private Date createTime;

    private Date lastUpdateTime;
}
```

新建GoodsDTO

```java
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;

/**
 * 2 * @ClassName GoodsEntity
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/5
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "商品参数DTO")
@Data
public class GoodsDTO  extends  BaseDTO{
    @ApiModelProperty(value = "spuId")
    @NotNull(groups = {MingruiOperation.update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotEmpty(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "一级类目id")
    @NotNull(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private Integer cid1;

    @ApiModelProperty(value = "二级类目id")
    @NotNull(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private Integer cid2;

    @ApiModelProperty(value = "三级类目id")
    @NotNull(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id")
    @NotNull(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private Integer brandId;

    @ApiModelProperty(value = "是否上架，0下架，1上架")
    @NotNull(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private Integer saleable;

    @ApiModelProperty(value = "是否有效，0已删除，1有效")
    @NotNull(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private Integer valid;

    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    @ApiModelProperty(value = "最后修改时间")
    private Date lostUpdateTime;
    
    private String categoryName;
    
    private String brandName;
    
     private  SpecDetailDTO spuDetail;

    private List<SpecSkuDTO> skus;
}
```

新建GoodsService

```java
/**
 * 2 * @ClassName GoodsService
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/5
 * 6 * @Version V1.0
 * 7
 **/
@Api(tags = "商品管理接口")
public interface GoodsService {
    @ApiOperation(value = "获取商品列表")
    @GetMapping("goods/list")
    Result<List<GoodsEntity>> getGoodsList(GoodsDTO goodsDTO);
}
```

新建GoodsServiceImpl

```java
package com.baidu.shop.service.impl;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.GoodsDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.entity.GoodsEntity;
import com.baidu.shop.mapper.BrandMapper;
import com.baidu.shop.mapper.CategoryMapper;
import com.baidu.shop.mapper.GoodsMapper;
import com.baidu.shop.service.GoodsService;
import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.ObjectEqUtil;
import com.baidu.shop.utils.TenXunBeanUtil;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;

import javax.annotation.Resource;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

/**
 * 2 * @ClassName GoodsServiceImpl
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/5
 * 6 * @Version V1.0
 * 7
 **/
@RestController
public class GoodsServiceImpl extends BaseApiService implements GoodsService {
    @Resource
    private GoodsMapper goodsMapper;

    @Resource
    private BrandMapper brandMapper;

    @Resource
    private CategoryMapper categoryMapper;


    @Override
    public Result<List<GoodsEntity>> getGoodsList(GoodsDTO goodsDTO) {

        if(ObjectEqUtil.isNull(goodsDTO.getPage())|| ObjectEqUtil.isNull(goodsDTO.getRows())) return this.setResultError("分页参数错误");
            if(!StringUtils.isEmpty(goodsDTO.getSort()) && !StringUtils.isEmpty(goodsDTO.getOrder())){
                PageHelper.orderBy(goodsDTO.getSort()+"  "+(Boolean.valueOf(goodsDTO.getOrder())?"desc":"asc"));
        }

        PageHelper.startPage(goodsDTO.getPage(),goodsDTO.getRows());
        Example example = new Example(GoodsEntity.class);
        Example.Criteria criteria = example.createCriteria();
        if(ObjectEqUtil.isNotNull(goodsDTO.getSaleable()) && goodsDTO.getSaleable() <2){
            criteria.andEqualTo("saleable",goodsDTO.getSaleable());
        }
        if(StringUtils.isEmpty(goodsDTO.getTitle())){
            criteria.andLike("title","%"+goodsDTO.getTitle()+"%");
        }



        List<GoodsEntity> goodsEntities = goodsMapper.selectByExample(example);


        List<GoodsDTO> collect = goodsEntities.stream().map(goodsEntity -> {

            String categroyName=categoryMapper.selectCategoryNameById(Arrays.asList(goodsEntity.getCid1(), goodsEntity.getCid2(), goodsEntity.getCid3()));
            GoodsDTO goodsDTO1 = TenXunBeanUtil.copyProperties(goodsEntity, GoodsDTO.class);

            BrandEntity brandEntity = brandMapper.selectByPrimaryKey(goodsEntity.getBrandId());
            goodsDTO1.setBrandName(brandEntity.getName());
            goodsDTO1.setCategoryName(categroyName);

            return goodsDTO1;
        }).collect(Collectors.toList());
        PageInfo<GoodsEntity> pageInfo =new PageInfo<>(goodsEntities);
        return this.setResult(HTTPStatus.OK,pageInfo.getTotal()+"",collect);
    }
}

```

新建GoodsMapper

```java
import com.baidu.shop.entity.GoodsEntity;
import tk.mybatis.mapper.common.Mapper;

public interface GoodsMapper extends Mapper<GoodsEntity> {
}
```

### 前台

修改goods.vue line  7

![image-20210105203448220](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210105203448220.png)

修改 204

![image-20210106141638487](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210106141638487.png)

## 2.商品新增

### 后台



新建SpecDetailEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

/**
 * 2 * @ClassName SpecDetailEntity
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/7
 * 6 * @Version V1.0
 * 7
 **/
@Table(name = "tb_spu_detail")
@Data
public class SpecDetailEntity {
    @Id
    private Integer spuId;

    private String description;

    private String genericSpec;

    private String specialSpec;

    private  String packingList;

    private String afterService;

}
```

新建SpecDetailDTO

```java
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * 2 * @ClassName SpecDetailEntity
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/7
 * 6 * @Version V1.0
 * 7
 **/

@Data
@ApiModel(value = "商品标题传输DTO")
public class SpecDetailDTO extends BaseDTO {
    @ApiModelProperty(value = "商品spuId")
    private Integer spuId;
    @ApiModelProperty(value = "商品描述信息")
    private String description;
    @ApiModelProperty(value = "通用规格参数数据")
    private String genericSpec;
    @ApiModelProperty(value = "特有规格参数及可选值信息，json格式")
    private String specialSpec;
    @ApiModelProperty(value = "包装清单")
    private  String packingList;
    @ApiModelProperty(value = "售后服务")
    private String afterService;

}
```

新建SpecSkuEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

/**
 * 2 * @ClassName SpecSkuEntity
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/7
 * 6 * @Version V1.0
 * 7
 **/
@Table(name ="tb_sku")
@Data
public class SpecSkuEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Integer spuId;

    private String title;

    private String images;

    private Integer price;

    private  String indexes;

    private String ownSpec;

    private Boolean enable;

    private Date  createTime;

    private Date lastUpdateTime;
}
```



新建SpecSkuDTO

```java
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import java.util.Date;

/**
 * 2 * @ClassName SpecSkuEntity
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/7
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "商品sku传输DTO")
@Data
public class SpecSkuDTO extends BaseDTO {
    @ApiModelProperty(value = " sku id ")
    private Long id;
    @ApiModelProperty(value = "商品spuId ")
    private Integer spuId;
    @ApiModelProperty(value = " 商品标题 ")
    private String title;
    @ApiModelProperty(value = " 商品的图片，多个图片以‘,’分割")
    private String images;
    @ApiModelProperty(value = "销售价格，单位为分")
    private Integer price;
    @ApiModelProperty(value = " 特有规格属性在spu属性模板中的对应下标组合 ")
    private  String indexes;
    @ApiModelProperty(value = " sku的特有规格参数键值对，json格式，反序列化时请使用linkedHashMap，保证有序 ")
    private String ownSpec;
    @ApiModelProperty(value = " 是否有效，0无效，1有效 ")
    private Boolean enable;
    @ApiModelProperty(value = " 添加时间 ")
    private Date  createTime;
    @ApiModelProperty(value = " 最后修改时间 ")
    private Date lastUpdateTime;
     @ApiModelProperty(value= "库存剩余")
    private Integer stock;
}
```



新建SpecStockEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

/**
 * 2 * @ClassName SpecStockEntity
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/7
 * 6 * @Version V1.0
 * 7
 **/
@Table(name = "tb_stock")
@Data
public class SpecStockEntity {
    @Id
    private Long skuId;

    private Integer seckillStock;

    private Integer seckillTotal;

    private Integer stock;
    



}
```

新建SpecStockDTO

```java
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;

/**
 * 2 * @ClassName SpecStockEntity
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/7
 * 6 * @Version V1.0
 * 7
 **/

@Data
@ApiModel(value = "库存传输DTO")
public class SpecStockDTO {
    @Id
    @ApiModelProperty(value = "库存对应的商品sku id")
    private Long skuId;
    @ApiModelProperty(value = "可秒杀库存")
    private Integer seckillStock;
    @ApiModelProperty(value = "秒杀总数量")
    private Integer seckillTotal;
    @ApiModelProperty(value = "库存数量")
    private Integer stock;
    



}
```

修改goodsDTO

```java
package com.baidu.shop.dto;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;
import java.util.List;

/**
 * 2 * @ClassName GoodsEntity
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/5
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "商品参数DTO")
@Data
public class GoodsDTO  extends  BaseDTO{
    @ApiModelProperty(value = "spuId")
    @NotNull(groups = {MingruiOperation.update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotEmpty(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "一级类目id")
    @NotNull(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private Integer cid1;

    @ApiModelProperty(value = "二级类目id")
    @NotNull(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private Integer cid2;

    @ApiModelProperty(value = "三级类目id")
    @NotNull(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id")
    @NotNull(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private Integer brandId;

    @ApiModelProperty(value = "是否上架，0下架，1上架")
    @NotNull(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private Integer saleable;

    @ApiModelProperty(value = "是否有效，0已删除，1有效")
    @NotNull(groups = {MingruiOperation.update.class,MingruiOperation.add.class})
    private Integer valid;

    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    @ApiModelProperty(value = "最后修改时间")
    private Date lostUpdateTime;

    private String categoryName;


    private String brandName;

    private  SpecDetailDTO spuDetail;

    private List<SpecSkuDTO> skus;
}

```





新建SpecDetailMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpecDetailEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecDetailMapper extends Mapper<SpecDetailEntity> {
}
```

新建SpecSkuMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpecSkuEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecSkuMapper extends Mapper<SpecSkuEntity> {
}
```

新建SpecStockMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpecStockEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecStockMapper extends Mapper<SpecStockEntity> {
}
```

新建goods新增接口

```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.GoodsDTO;
import com.baidu.shop.entity.GoodsEntity;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;

import java.util.List;

/**
 * 2 * @ClassName GoodsService
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/5
 * 6 * @Version V1.0
 * 7
 **/
@Api(tags = "商品管理接口")
public interface GoodsService {
    @ApiOperation(value = "获取商品列表")
    @GetMapping("goods/list")
    Result<List<GoodsEntity>> getGoodsList(GoodsDTO goodsDTO);

    @ApiOperation(value = "新增商品")
    @PostMapping("goods/save")
    Result<JsonObject>  saveGoods(@RequestBody GoodsDTO goodsDTO);
}
```



实现新增商品接口

```java
package com.baidu.shop.service.impl;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.GoodsDTO;
import com.baidu.shop.dto.SpecDetailDTO;
import com.baidu.shop.dto.SpecSkuDTO;
import com.baidu.shop.entity.*;
import com.baidu.shop.mapper.*;
import com.baidu.shop.service.GoodsService;
import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.ObjectEqUtil;
import com.baidu.shop.utils.TenXunBeanUtil;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.google.gson.JsonObject;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;

import javax.annotation.Resource;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.stream.Collectors;

/**
 * 2 * @ClassName GoodsServiceImpl
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/1/5
 * 6 * @Version V1.0
 * 7
 **/
@RestController
public class GoodsServiceImpl extends BaseApiService implements GoodsService {
    @Resource
    private GoodsMapper goodsMapper;

    @Resource
    private BrandMapper brandMapper;

    @Resource
    private CategoryMapper categoryMapper;

    @Resource
    private SpecSkuMapper specSkuMapper;


    @Resource
    private SpecStockMapper specStockMapper;

    @Resource
    private  SpecDetailMapper specDetailMapper;


    @Override
    public Result<List<GoodsEntity>> getGoodsList(GoodsDTO goodsDTO) {
        //判断分页参数是否正确
        if(ObjectEqUtil.isNull(goodsDTO.getPage())|| ObjectEqUtil.isNull(goodsDTO.getRows())) return this.setResultError("分页参数错误");
        PageHelper.startPage(goodsDTO.getPage(),goodsDTO.getRows());
        if(!StringUtils.isEmpty(goodsDTO.getSort()) && !StringUtils.isEmpty(goodsDTO.getOrder())){
                PageHelper.orderBy(goodsDTO.getSort()+"  "+(Boolean.valueOf(goodsDTO.getOrder())?"desc":"asc"));
        }
        //创建example对象进行条件查询
        Example example = new Example(GoodsEntity.class);
        Example.Criteria criteria = example.createCriteria();
        if(ObjectEqUtil.isNotNull(goodsDTO.getSaleable()) && goodsDTO.getSaleable() <2){
            criteria.andEqualTo("saleable",goodsDTO.getSaleable());
        }
        if(StringUtils.isEmpty(goodsDTO.getTitle())){
            criteria.andLike("title","%"+goodsDTO.getTitle()+"%");
        }




        List<GoodsEntity> goodsEntities = goodsMapper.selectByExample(example);


        List<GoodsDTO> collect = goodsEntities.stream().map(goodsEntity -> {
            //根据分类id查询分类名称
            String categroyName=categoryMapper.selectCategoryNameById(Arrays.asList(goodsEntity.getCid1(), goodsEntity.getCid2(), goodsEntity.getCid3()));

            GoodsDTO goodsDTO1 = TenXunBeanUtil.copyProperties(goodsEntity, GoodsDTO.class);
            //根据品牌id查询品牌名称
            BrandEntity brandEntity = brandMapper.selectByPrimaryKey(goodsEntity.getBrandId());
            goodsDTO1.setBrandName(brandEntity.getName());
            goodsDTO1.setCategoryName(categroyName);

            return goodsDTO1;
        }).collect(Collectors.toList());

        PageInfo<GoodsEntity> pageInfo =new PageInfo<>(goodsEntities);

        return this.setResult(HTTPStatus.OK,pageInfo.getTotal()+"",collect);
    }

    @Override
    @Transactional
    public Result<JsonObject> saveGoods(GoodsDTO goodsDTO) {

        final Date date = new Date();
        GoodsEntity spuEntity = TenXunBeanUtil.copyProperties(goodsDTO, GoodsEntity.class);
        spuEntity.setSaleable(1);
        spuEntity.setValid(1);
        spuEntity.setCreateTime(date);
        spuEntity.setLastUpdateTime(date);
        //新增spu数据
        goodsMapper.insertSelective(spuEntity);


        SpecDetailDTO specDetailDTO = goodsDTO.getSpuDetail();
        SpecDetailEntity specDetailEntity = TenXunBeanUtil.copyProperties(specDetailDTO, SpecDetailEntity.class);
        specDetailEntity.setSpuId(spuEntity.getId());
            //新增detail
        specDetailMapper.insertSelective(specDetailEntity);


        List<SpecSkuDTO> specSkuDTOS = goodsDTO.getSkus();
        specSkuDTOS.stream().forEach(sku ->{
            SpecSkuEntity specSkuEntity = TenXunBeanUtil.copyProperties(sku, SpecSkuEntity.class);
            specSkuEntity.setSpuId(spuEntity.getId());
            specSkuEntity.setCreateTime(date);
            specSkuEntity.setLastUpdateTime(date);
            //新增sku
            specSkuMapper.insertSelective(specSkuEntity);
            SpecStockEntity specStockEntity = new SpecStockEntity();
            specStockEntity.setSkuId(specSkuEntity.getId());
            specStockEntity.setStock(sku.getStock());
            //新增stock
            specStockMapper.insertSelective(specStockEntity);
        });

        return this.setResultSuccess();
    }
}

```

### 前台



修改line 221

![image-20210107140345695](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210107140345695.png)

修改line 208

![image-20210107140429715](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210107140429715.png)

## 3.修改商品

### 前台

修改goodForm.vue

![image-20210108142841396](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210108142841396.png)

修改goods.vue

![image-20210108142759364](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210108142759364.png)

### 后台

创建通过spuId查询detail和查询sku的接口

```java
@ApiOperation(value="通过spuId查询detail数据")
@GetMapping("/goods/spu/detail")
Result<SpecDetailDTO> getSpecDetailBySpuId(Integer spuId);
```

```java
@GetMapping("/goods/spu/getSku")
@ApiOperation(value = "通过spuId查询sku参数")
Result<List<SpecSkuDTO>> getSkuBySpu(Integer spuId);
```





创建修改接口

```java
@ApiOperation(value = "修改商品")
@PutMapping("goods/save")
Result<JsonObject>  editGoods( @Validated( {MingruiOperation.update.class}) @RequestBody GoodsDTO goodsDTO);
```

新建修改接口实现

```java
@Transactional
public Result<JsonObject> editGoods(GoodsDTO goodsDTO) {
    final Date date = new Date();
    //通过id删除spu数据
    GoodsEntity goodsEntity = TenXunBeanUtil.copyProperties(goodsDTO, GoodsEntity.class);
    goodsEntity.setLastUpdateTime(date);
    goodsMapper.updateByPrimaryKeySelective(goodsEntity);
    //通过spuId删除detail中的数据
    SpecDetailEntity specDetailEntity = TenXunBeanUtil.copyProperties(goodsDTO.getSpuDetail(), SpecDetailEntity.class);
    specDetailMapper.updateByPrimaryKeySelective(specDetailEntity);
    ////根据spuId查询出skuId通过skuId删除sku信息和stock信息
    deleteSkuAndStockBySpuId(goodsDTO.getId());
    //通过前台传来的数据新增sku列表以及库存
    saveSkuAndStockFunction(goodsDTO,goodsDTO.getId(),date);

    return this.setResultSuccess();
}


    private void deleteSkuAndStockBySpuId(Integer spuId){
        //根据spuId查询sku信息.
        Example example = new Example(SpecSkuEntity.class);
        example.createCriteria().andEqualTo("spuId",spuId);
        List<SpecSkuEntity> specSkuEntityList = specSkuMapper.selectByExample(example);
        //获取skuId列表
        List<Long> longList = specSkuEntityList.stream().map(sku -> sku.getId()).collect(Collectors.toList());
        //通过skuId列表删除sku数据
        specSkuMapper.deleteByIdList(longList);
        //通过skuId列表删除stock数据
        specStockMapper.deleteByIdList(longList);
    }


 private  void saveSkuAndStockFunction(GoodsDTO goodsDTO,Integer spuId, Date date){
        List<SpecSkuDTO> specSkuDTOS = goodsDTO.getSkus();
        specSkuDTOS.stream().forEach(sku ->{
            SpecSkuEntity specSkuEntity = TenXunBeanUtil.copyProperties(sku, SpecSkuEntity.class);
            specSkuEntity.setSpuId(spuId);
            specSkuEntity.setCreateTime(date);
            specSkuEntity.setLastUpdateTime(date);
            //新增sku
            specSkuMapper.insertSelective(specSkuEntity);
            SpecStockEntity specStockEntity = new SpecStockEntity();
            specStockEntity.setSkuId(specSkuEntity.getId());
            specStockEntity.setStock(sku.getStock());
            //新增stock
            specStockMapper.insertSelective(specStockEntity);
        });
    }

 @Override
    public Result<SpecDetailDTO> getSpecDetailBySpuId(Integer spuId) {
        SpecDetailEntity specDetailEntity = specDetailMapper.selectByPrimaryKey(spuId);
        return this.setResultSuccess(specDetailEntity);
    }

    @Override
    public Result<List<SpecSkuDTO>> getSkuBySpu(Integer spuId) {
       List<SpecSkuDTO> list= specSkuMapper.getSkuAndStockBySpuId(spuId);
        return this.setResultSuccess(list);
    }
```

goodsMapper接口

```java
import com.baidu.shop.dto.SpecSkuDTO;
import com.baidu.shop.entity.SpecSkuEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

public interface SpecSkuMapper extends Mapper<SpecSkuEntity>, DeleteByIdListMapper<SpecSkuEntity,Long> {
    @Select(value = "select sku.*,stock.stock from tb_sku sku,tb_stock stock where sku.id=stock.sku_id and sku.spu_id=#{spuId}")
    List<SpecSkuDTO> getSkuAndStockBySpuId(Integer4 spuId);
}
```

## 4.删除商品

### 前台

![image-20210108151814602](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210108151814602.png)

### 后台

接口

```java
@ApiOperation(value = "通过spuId删除商品")
@DeleteMapping("goods/delete")
Result<JsonObject>  deleteGoods(Integer spuId);
```

接口实现

```
@Override
@Transactional
public Result<JsonObject> deleteGoods(Integer spuId) {
    //根据id删除spu数据
    goodsMapper.deleteByPrimaryKey(spuId);
    //根据spuId删除detail数据
    specDetailMapper.deleteByPrimaryKey(spuId);
    //根据spuId查询出skuId通过skuId删除sku信息和stock信息
    deleteSkuAndStockBySpuId(spuId);
    return this.setResultSuccess();
}
```

## 5.上下商品

### 前台

goods.vue新建

![image-20210108152218484](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210108152218484.png)

![image-20210108152140054](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210108152140054.png)

### 后台

新建xiajia接口

```java
@ApiOperation(value = "修改商品上下架")
@PutMapping("goods/xiaJia")
Result<JsonObject>  xiaJiaGoods( @Validated( {MingruiOperation.update.class}) @RequestBody GoodsDTO goodsDTO);
```

新建接口实现

```java
@Override
public Result<JsonObject> xiaJiaGoods(GoodsDTO goodsDTO) {
    GoodsEntity goodsEntity = TenXunBeanUtil.copyProperties(goodsDTO, GoodsEntity.class);
    goodsMapper.updateByPrimaryKeySelective(goodsEntity);
    return this.setResultSuccess();
}
```

# 六.**简介**

## 6.1.1 Elastic

Elastic官网：https://www.elastic.co/cn/

![image-20210304200053417](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200053417.png)

Elastic有一条完整的产品线：Elasticsearch、Kibana、Logstash(处理分布式微服务日志)等，前面说的

三个就是大家常说的ELK技术栈。

![image-20210304200128084](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200128084.png)

![image-20210304200140827](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200140827.png)

## **6.1.2 Elasticsearch**

Elasticsearch官网：https://www.elastic.co/cn/products/elasticsearch

![image-20210304200207531](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200207531.png)

## **6.2** **安装和配置**

为了模拟真实场景，我们将在linux下安装Elasticsearch。

**2.2.1** **安装****es**

将压缩包上传到linux系统中

![image-20210304200256145](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200256145.png)

```shell
tar -zxvf elasticsearch-7.5.1-linux-x86_64.tar.gz #解压压缩包 
groupadd esgroup #创建用户组 
useradd esuser -g esgroup -p 123456 #在用户组下新建用户 
cd elasticsearch-7.5.1/config/ #进入配置文件目录 
vi jvm.options #修改JVM参数(默认1G) 
-Xms512m 
-Xmx512m
```

![image-20210304200339409](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200339409.png)

保存并退出

```shell
vi elasticsearch.yml 
cluster.name: my-application #集群名称 
node.name: node-1 #当前节点名称 
path.data: /shenyaqi/es/elasticsearch-7.5.1/data #数据存放目录
path.logs: /shenyaqi/es/elasticsearch-7.5.1/logs #日志目录 
network.host: 0.0.0.0 #允许任意ip访问
discovery.seed_hosts: ["119.45.191.248"] #所有节点ip,由于当前环境采用单节点,所以只写当 前节点ip地址 
cluster.initial_master_nodes: ["node-1"] #声明master节点,由于当前是单节点环境所以 master节点就是当前节点[此处可以写ip:9200也可以写node.name]
```

![image-20210304200439924](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200439924.png)

![image-20210304200448297](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200448297.png)

![image-20210304200459364](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200459364.png)

![image-20210304200507980](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200507980.png)

保存并退出

```shell
cd ../../ #进入es的上级目录
```

![image-20210304200548783](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200548783.png)

```shell
chown -R esuser:esgroup elasticsearch-7.5.1 #给用户授权 s
su esuser #切换用户
```

![image-20210304200610590](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200610590.png)

```shell
cd elasticsearch-7.5.1/bin/ #进入bin目录s
./elasticsearch 启动es
```

![image-20210304200635120](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200635120.png)

如果出现上图错误

```shell
su root
sysctl -w vm.max_map_count=262144 
sysctl -a|grep vm.max_map_count 
su esuser
```

浏览器访问ip:9200

![image-20210304200722568](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200722568.png)

**2.2.2** **安装ik分词器**

进入es目录下的plugins目录

![image-20210304200802698](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200802698.png)

```shell
mkdir ik 
cd ik
```

将elasticsearch-analysis-ik-7.5.1.zip上传到ik目录

```shell
unzip elasticsearch-analysis-ik-7.5.1.zip #解压压缩包 
# 解压完成之后最好切换回root 用户重新给文件夹授权
```

![image-20210304200843028](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200843028.png)

```shell
rm -rf elasticsearch-analysis-ik-7.5.1.zip #删除压缩包
```

![image-20210304200910062](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304200910062.png)

```shell
cd ../bin/ 
./elasticsearch 
./elasticsearch -d #后台启动
```

分词器安装成功

**2.2.3** **安装kibana(可视化工具)**

**2.2.3.1** **什么是kibana**

![image-20210304201012615](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304201012615.png)

Kibana是一个基于Node.js的Elasticsearch索引库数据统计工具，可以利用Elasticsearch的聚合功能，

生成各种图表，如柱形图，线状图，饼图等。

而且还提供了操作Elasticsearch索引数据的控制台，并且提供了一定的API提示，非常有利于我们学习

Elasticsearch的语法。

**2.2.3.2** **安装**

因为Kibana依赖于node，我们的虚拟机没有安装node，而window中安装过。所以我们选择在window

下使用kibana。

版本与elasticsearch保持一致

![image-20210304202127670](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202127670.png)

**2.2.3.3** **配置运行**

配置

进入安装目录下的config目录，修改kibana.yml文件：

![image-20210304202152538](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202152538.png)

进入安装目录下的bin目录：

![image-20210304202212558](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202212558.png)

**2.2.4** **测试分词器和kibana**

浏览器输入ip:5601

![image-20210304202247578](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202247578.png)

```js
GET _search 
{ 
	"query": { 
		"match_all": {} 
	} 
}
POST _analyze 
{ 
	"analyzer": "ik_max_word", 
	"text": "我爱北京天安门" 
}
```

![image-20210304202409498](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202409498.png)

![image-20210304202424301](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202424301.png)

**2.2.5** **倒排索引**

![image-20210304202442224](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202442224.png)

**2.3 API**

Elasticsearch提供了Rest风格的API，即http请求接口，而且也提供了各种语言的客户端API

**2.3.1 Rest风格API**

https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started.html

![image-20210304202522015](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202522015.png)

![image-20210304202531968](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202531968.png)

**2.3.2** **客户端API**

https://www.elastic.co/guide/en/elasticsearch/client/index.html

![image-20210304202555043](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202555043.png)

![image-20210304202628952](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202628952.png)

![image-20210304202640046](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202640046.png)

**3** **操作索引**

**3.1** **基本概念**

elasticsearch也是基于Lucene的全文检索库，本质也是存储数据，很多概念与MySQL类似的

**3.2** **创建索引**

**3.2.1** **语法**

![image-20210304202805292](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202805292.png)

```js
{ 
	"settings": { 
		"number_of_shards": 1, 
		"number_of_replicas": 0
        } 
 }
```

![image-20210304202901860](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202901860.png)

**3.2.3** **使用kibana创建**

![image-20210304202936719](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304202936719.png)

**3.3** **查看索引设置**

语法

Get请求可以帮我们查看索引信息，格式：

```js
GET /索引库名
```

![image-20210304203020238](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304203020238.png)

**3.4** **删除索引**

删除索引使用DELETE请求

语法

```
DELETE /索引库名
```

![image-20210304203113443](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304203113443.png)

**3.5** **创建mapping**

https://www.elastic.co/guide/en/elasticsearch/reference/7.5/index.html

**3.5.1** **语法**

```
PUT /student
{
	"mappings": {
		"properties": {
			"name":{
				"type": "text",
				"index": true,
				"store": true,
				"analyzer": "ik_max_word"
		},
			"age":{
				"type": "integer"
		},
		"birthday":{
			"type": "date",
			"format": "yyyy-MM-dd"
		}
	}
},
  "settings": {
	"number_of_shards": 1,
	"number_of_replicas": 0
	}
}
```

![image-20210304203436625](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304203436625.png)

![image-20210304203450751](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304203450751.png)

![image-20210304203502464](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304203502464.png)

```
GET /indexName/_settings
```

![image-20210304203520292](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304203520292.png)

```
GET /indexName/_mapping
```

![image-20210304203539205](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304203539205.png)

```
GET /_all/_mapping
```

![image-20210304203558605](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304203558605.png)

```js
POST /student/_doc/1
{ 
	"name":"赵俊浩", 
	"age":18, 
	"birthday":"2020-09-02"
}
```

![image-20210304203656799](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304203656799.png)

```js
POST /student/_doc
{ 
	"name":"赵俊浩", 
	"age":18, 
	"birthday":"2020-09-02"
}
```

<img src="D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304203743521.png" alt="image-20210304203743521" style="zoom:200%;" />

如果在增加数据时有 没有提前定义的属性字段，根据属性值自动创建

```
POST /student/_doc/3
{ 
	"name":"赵俊浩222", 
	"age":18, 
	"birthday":"2020-09-02"
	"sex":"男"
}
```

![image-20210304203914112](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304203914112.png)

```
GET /student/_doc/3
```

![image-20210304203931608](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304203931608.png)

```js
POST /student/_doc/1
{ 
	"name":"赵俊浩1", 
	"age":18, 
	"birthday":"2020-09-02"
}
```

![image-20210304204006124](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304204006124.png)

```js
DELETE /student/_doc/1
```

![image-20210304204020798](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304204020798.png)

**4.1** **基本查询**

基本语法

```js
GET /索引库名/_search 
{ 
	"query":{ 
		"查询类型":{ 
		"查询条件":"查询条件值" 
		} 
	} 
}
```

这里的query代表一个查询对象，里面可以有不同的查询属性

查询类型：

例如： match_all ， match ， term ， range 等等

查询条件：查询条件会根据类型的不同，写法也有差异，后面详细讲解

**4.1.1** **查询所有（match_all)**

实例

```js
GET /student/_search 
{ 
	"query":{
    	"match_all": {}
     } 
}
```

query ：代表查询对象

match_all ：代表查询所有

![image-20210304204304766](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304204304766.png)

数据准备

```js
# 创建索引
PUT /goods
{
	"mappings": {
		"properties": {
			"title":{
				"type": "text",
				"index": true,
				"store": true,
				"analyzer": "ik_max_word"
		},
		"description":{
		"type": "text",
		"index": true,
		"store": true,
		"analyzer": "ik_max_word"
	},
	"price":{
		"type": "double"
	},
	"stock":{
		"type": "integer"
		}
	}
},
	"settings": {
		"number_of_shards": 1,
		"number_of_replicas": 0
	}
}
# 批量新增数据
POST /goods/_doc/_bulk
{"index":{}}
{"title":"华为手机","description":"这个是华为 mate 30 pro手
机","price":5000.00,"stock":100}
{"index":{}}
{"title":"苹果手机","description":"这个是apple 11 手机","price":5800.00,"stock":67}
{"index":{}}
{"title":"oppo手机","description":"这个是oppo xxxx手
机","price":2000.00,"stock":55}

# 查询数据
GET /goods/_search
{
	"query":{
		"match_all": {}
	}
}

```

or关系 

match 类型查询，会把查询条件进行分词，然后进行查询,多个词条之间是or的关系

```js
GET /goods/_search
{
	"query": {
		"match": {
			"title": "华为手机 "
		}
	}
}
```

![image-20210304204625639](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304204625639.png)

```js
GET /goods/_search
{
	"query": {
		"match": {
			"title": {"query": "华为手机","operator": "and"}
		}
	}
}
```

![image-20210304204703790](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304204703790.png)

```js
GET /goods/_search
{
	"query": {
		"match": {
			"title": {"query": "华为5g手机","minimum_should_match": "50%"}
		}
	}
}

```

![image-20210304204730841](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304204730841.png)

![image-20210304204741701](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304204741701.png)

```js
#新增测试数据
POST /goods/_doc
{
	"title":"戴尔电脑",
	"description":"手机可以通过usb接口连接电脑",
	"price":5000.00,
	"stock":100
}
GET /goods/_search
{
	"query": {
		"multi_match": {
			"query": "手机",
			"fields": ["title","description"]
		}
	}
}
```

![image-20210304204910156](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304204910156.png)

> *`**4.1.4 词条匹配(term)***`

term 查询被用于精确值 匹配，这些精确值可能是数字、时间、布尔或者那些未分词的字符串

```js
GET /goods/_search
{
	"query":{
		"term":{
			"price":2000
		}
	}
}
```

![image-20210304205032391](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304205032391.png)

```js
GET /goods/_search
{
	"query":{
		"terms": {
			"price": [
				2000,
				5000
			]
		}
	}
}
```

![image-20210304205107018](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304205107018.png)

```js
GET /goods/_search
{
	"_source": ["title","description"],
	"query":{
		"terms": {
			"price": [
				2000,
				5000
			]
		}
	}
}
```

![image-20210304205203515](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304205203515.png)

```js
GET /goods/_search
{
	"_source": {
		"excludes":["title","stock"]
	},
	"query":{
		"terms": {
			"price": [
				5000,
				2000
			]
		}
	}
}
```

![image-20210304205252052](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304205252052.png)

```js
GET /goods/_search
{
	"query": {
		"bool": {
			"must": [
			{
				"match": {
					"title": "华为"
			}
			},
			{
				"match": {
					"description": "pro"
					}
				}
			]
		}
	}
}

```

![image-20210304205531587](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304205531587.png)

```js
GET /goods/_search
{
	"query": {
		"bool": {
			"must_not": [
			{
				"match": {
					"title": "oppo"
					}
				}
			]
		}
	}
}
```

![image-20210304205659127](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304205659127.png)

```js
GET /goods/_search
{
	"query": {
		"bool": {
			"should": [
			{
				"match": {
					"description": "华为"
				}
			},
			{
				"match": {
					"description": "apple"
					}
				}
			]
		}
	}
}

```

![image-20210304205805268](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304205805268.png)

```js
GET /goods/_search
{
	"query": {
		"bool": {
		"must": [
		{
			"match": {
				"title": "华为"
			}
		},
		{
			"match": {
				"description": "pro"
			}
		}
	],
		"must_not": [
		{
			"match": {
				"title": "oppo"
			}
		}
	],
		"should": [
		{
			"match": {
				"description": "华为"
			}
		},
		{
			"match": {
				"description": "apple"
					}
				}
			]
		}
	}
}
```

![image-20210304210054861](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304210054861.png)

4.3.2 范围查询(range)

range 区间查询，值 >= 条件 <= 值

 例如：2000-4999之间的价格

```js
GET /goods/_search
{
		"query": {
			"range": {
				"price": {
					"gte": 2000,
					"lte": 4999
			}
		}
	}
}

```

![image-20210304210203260](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304210203260.png)

4.3.3 模糊查询(fuzzy)

我们新增一个商品：

```js
#新增测试数据
POST /goods/_doc
{
	"title":"huawei手机升级版",
	"description":"这个是huawei 手机的升级版",
	"price":6000.00,
	"stock":100
}
```

fuzzy 查询是 term 查询的模糊等价。它允许用户搜索词条与实际词条的拼写出现偏差，但是偏差的 编辑距离不得超过2：

```js
GET /goods/_search
{
	"query": {
		"fuzzy": {
			"title":"华为路"
		}
	}
}

```

```js
GET /goods/_search
{
	"query": {
	"fuzzy": {
		"title":{
			"value":"华为路由",
			"fuzziness": 2
			}
		}
	}
}
```

4.4 过滤(filter)

```js
GET /goods/_search
{
	"query": {
		"bool": {
			"must":
				{
					"match": {
						"title": "华为手机"
					}
				}
				,
			"filter": {
				"range": {
					"price": {
						"gte": 2000,
						"lte": 5000
						}
					}
				}
			}
		}
	}
```

![image-20210304211125726](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304211125726.png)

```js
GET /goods/_search
{
	"query": {
		"constant_score": {
			"filter": {
				"range": {
					"price": {
						"gte": 2000,
						"lte": 5000
						}
					}
				},
					"boost": 1
			}
		}
	}
//boost 为权重 决定了当前查询结果能的多少分
```

![image-20210304211356235](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304211356235.png)

```js
GET /goods/_search
{
	"query": {
		"match": {
			"title": "华为手机"
		}
	},
	"sort": [
		{
			"price": {
			"order": "desc"
			}
		}
	]
}
```

![image-20210304211559817](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304211559817.png)

```js
GET /goods/_search
{
	"query": {
		"match": {
			"title": "华为手机"
		}
	},
	"sort": [
		{
			"_score": {
				"order": "desc"
			}
		},
		{
			"price": {"order": "desc"}
		}
	]
}
```

![image-20210304212603310](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210304212603310.png)

**5.1 基本概念**

```js
PUT /cars
{
	"settings": {
		"number_of_shards": 1,
		"number_of_replicas": 0
	},
	"mappings": {
		"properties": {
			"color": {
				"type": "keyword"
			},
			"make": {
			"type": "keyword"
			}
		}
	}
}
POST /cars/_doc/_bulk
{ "index": {}}
{ "price" : 800000, "color" : "red", "make" : "大众", "sold" : "2020-10-28" }
{ "index": {}}
{ "price" : 1300000, "color" : "red", "make" : "大众", "sold" : "2020-11-05" }
{ "index": {}}
{ "price" : 300000, "color" : "green", "make" : "奔驰", "sold" : "2020-05-18" }
{ "index": {}}
{ "price" : 150000, "color" : "blue", "make" : "丰田", "sold" : "2020-07-02" }
{ "index": {}}
{ "price" : 120000, "color" : "green", "make" : "大众", "sold" : "2020-08-19" }
{ "index": {}}
{ "price" : 250000, "color" : "red", "make" : "大众", "sold" : "2020-11-05" }
{ "index": {}}
{ "price" : 350000, "color" : "red", "make" : "宝马", "sold" : "2020-01-01" }
{ "index": {}}
{ "price" : 650000, "color" : "blue", "make" : "奔驰", "sold" : "2014-02-12" }
```

**5.2 聚合为桶**

```js
GET /cars/_search
{
	"size": 0,
	"aggs": {
		"gro_color": {
			"terms": {
			"field": "color",
			"size": 10
			}
		}
	}
}
```

![image-20210311204725225](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311204725225.png)

**5.3 桶内度量**

```js
GET /cars/_search
{
	"size": 0,
	"aggs": {
		"gro_color": {
			"terms": {
				"field": "color"
		},
		"aggs": {
			"max_price": {
				"max": {
					"field": "price"
					}
				}
          	}
		}
	}
}
```

![image-20210311204854261](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311204854261.png)

**5.4 桶内嵌套桶**

```js
GET /cars/_search
{
	"size": 0,
	"aggs": {
		"gro_color": {
			"terms": {
				"field": "color"
				},
				"aggs": {
					"max_price": {
						"max": {
							"field": "price"
							}
						},
						"brand":{
							"terms":{
								"field":"make"
							}
						}
					}
				}
			}
	}
```

![image-20210311205030489](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311205030489.png)

**5.5 划分桶的其它方式**

**5.5.1 阶梯分桶Histogram**

```js
GET /cars/_search
{
	"size": 0,
	"aggs": {
		"price": {
			"histogram": {
				"field": "price",
				"interval": 100000,
				"min_doc_count": 1
			}
		}
	}
}
```

![image-20210311205201422](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311205201422.png)

**5.5.2 范围分桶range**

范围分桶与阶梯分桶类似，也是把数字按照阶段进行分组，只不过range方式需要你自己指定每一组的 起始和结束大小。

**6 Spring Data Elasticsearch**

**6.1 简介**

Spring Data Elasticsearch是Spring Data项目下的一个子模块。

 查看 Spring Data的官网：https://spring.io/projects/spring-data

![image-20210311205343175](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311205343175.png)

![image-20210311205400682](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311205400682.png)

![image-20210311205433425](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311205433425.png)

![image-20210311205451339](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311205451339.png)

**6.2 ESDemo**

**6.2.1 新建项目**

**6.2.2 pom.xml**

```xml
<parent>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-parent</artifactId>
	<version>2.3.1.RELEASE</version>
</parent>

<dependencies>
	<dependency>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-data-elasticsearch</artifactId>
	</dependency>
	<dependency>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-test</artifactId>
		<scope>test</scope>
	</dependency>
</dependencies>
```

**6.2.3 application.yml**

```yml
spring:
	elasticsearch:
		rest:
			uris: 119.45.191.248:9200
```

**6.2.4 启动类**

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
/**
* @ClassName RunTestEsApplication
* @Description: TODO
* @Author shenyaqi
* @Date 2020/9/3
* @Version V1.0
**/
@SpringBootApplication
public class RunTestEsApplication {
	public static void main(String[] args) {
		SpringApplication.run(RunTestEsApplication.class);
	}
}

```

**6.2.5 entity**

```java
import org.springframework.data.annotation.Id;
import org.springframework.data.elasticsearch.annotations.Document;
import org.springframework.data.elasticsearch.annotations.Field;
import org.springframework.data.elasticsearch.annotations.FieldType;

/**
* @ClassName entity
* @Description: TODO
* @Author shenyaqi
* @Date 2020/9/3
* @Version V1.0
**/
//声明当前类是一个文档(indexName="索引名称", shards="索引的分片数",replicas="索引的副本数")
@Document(indexName = "goods",shards = 1,replicas = 0)
public class GoodsEntity {
		@Id
		private Long id;
		
		@Field(type = FieldType.Text, analyzer = "ik_max_word")
		private String title; //标题
		
		@Field(type = FieldType.Keyword)
		private String category;// 分类
		
		@Field(type = FieldType.Keyword)
        private String brand; // 品牌
        
        @Field(type = FieldType.Double)
		private Double price; // 价格
		
		//index = false 不参与索引搜索
/*
* 设置index为false的好处是，当您为文档建立索引时，Elasticsearch将不必为该字段构建反向
索引。结果，索引文档将稍快一些。同样，由于该字段在磁盘上将没有持久化的反向索引，因此您将使用更少
的磁盘空间。*/

			@Field(index = false,type = FieldType.Keyword)
            private String images; // 图片地址
            public Long getId() {
           	 return id;
            }
            
            public void setId(Long id) {
           	 this.id = id;
            }
            
            public String getTitle() {
            	return title;
            }
            
            public void setTitle(String title) {
           	 this.title = title;
            }
            
            public String getCategory() {
            	return category;
            }
            
            public void setCategory(String category) {
            	this.category = category;
            }
            
            public String getBrand() {
            	return brand;
            }
            
            public void setBrand(String brand) {
            	this.brand = brand;
			}
			
			public Double getPrice() {
				return price;
			}
			public void setPrice(Double price) {
				this.price = price;
			}
			public String getImages() {
				return images;
			}
			public void setImages(String images) {
				this.images = images;
			}
			@Override
			public String toString() {
					return "GoodsEntity{" +
							"id=" + id +
							", title='" + title + '\'' +
                            ", category='" + category + '\'' +
                            ", brand='" + brand + '\'' +
                            ", price=" + price +
                            ", images='" + images + '\'' +
                     '}';
		}
}

```

**6.2.6 新建测试类**

**6.2.6.1 测试类上的注解**

```java
//让测试在Spring容器环境下执行
@RunWith(SpringRunner.class)
//声明启动类,当测试方法运行的时候会帮我们自动启动容器
@SpringBootTest(classes = { RunTestEsApplication.class})
```

**6.2.7 测试** 

**6.2.7.1 创建索引**

```java
@Autowired
private ElasticsearchRestTemplate elasticsearchRestTemplate;
/*
创建索引
*/
@Test
public void createGoodsIndex(){
		IndexOperations indexOperations = elasticsearchRestTemplate.indexOps(IndexCoordinates.of("indexn	ame"));
		indexOperations.create();//创建索引
		//indexOperations.exists() 判断索引是否存在
		System.out.println(indexOperations.exists()?"索引创建成功":"索引创建失败");
}

```

**6.2.7.2 创建映射**

```java
/*
创建映射
*/
@Test
public void createGoodsMapping(){
		//此构造函数会检查有没有索引存在,如果没有则创建该索引,如果有则使用原来的索引
		IndexOperations indexOperations = elasticsearchRestTemplate.indexOps(GoodsEntity.class);
		indexOperations.createMapping();//创建映射,不调用此函数也可以创建映射,这就是高版本的强大之处
		System.out.println("映射创建成功");
}

```

**6.2.7.3 删除索引**

```java
/*
删除索引
*/
@Test
public void deleteGoodsIndex(){
		IndexOperations indexOperations = elasticsearchRestTemplate.indexOps(GoodsEntity.class);
			indexOperations.delete();
			System.out.println("索引删除成功");
}
```

**6.2.7.4 新增文档** 

**6.2.7.4.1 新建GoodsEsRepository**

```java
import com.mr.entity.GoodsEntity;
import
org.springframework.data.elasticsearch.repository.ElasticsearchRepository;
/**
* @ClassName GoodsEsRepository
* @Description: TODO
* @Author shenyaqi
* @Date 2020/9/3
* @Version V1.0
**/
public interface GoodsEsRepository extends
	ElasticsearchRepository<GoodsEntity,Long> {
}
```

**6.2.7.4.2 注入repository**

```java
@Resource
private GoodsEsRepository goodsEsRepository;
```

**6.2.7.4.3 新增**

```java
/*
新增文档
*/
@Test
public void saveData(){

	GoodsEntity entity = new GoodsEntity();
	entity.setId(1L);
	entity.setBrand("小米");
	entity.setCategory("手机");
	entity.setImages("xiaomi.jpg");
	entity.setPrice(1000D);
	entity.setTitle("小米3");
	
	goodsEsRepository.save(entity);
	
	System.out.println("新增成功");
}

```

**6.2.7.5 批量新增**

```java
/*
批量新增文档
*/
@Test
public void saveAllData(){

	GoodsEntity entity = new GoodsEntity();
	entity.setId(2L);
	entity.setBrand("苹果");
	entity.setCategory("手机");
	entity.setImages("pingguo.jpg");
	entity.setPrice(5000D);
	entity.setTitle("iphone11手机");
	
	
    GoodsEntity entity2 = new GoodsEntity();
    entity2.setId(3L);
    entity2.setBrand("三星");
    entity2.setCategory("手机");
    entity2.setImages("sanxing.jpg");
    entity2.setPrice(3000D);
    entity2.setTitle("w2019手机");
    
    
    GoodsEntity entity3 = new GoodsEntity();
    entity3.setId(4L);
    entity3.setBrand("华为");
    entity3.setCategory("手机");
    entity3.setImages("huawei.jpg");
    entity3.setPrice(4000D);
    entity3.setTitle("华为mate30手机");
    						       							goodsEsRepository.saveAll(Arrays.asList(entity,entity2,entity3));
    						       							
		System.out.println("批量新增成功");
}

```

**6.2.7.6 更新文档**

```java
/*
更新文档
*/
@Test
public void updateData(){

	GoodsEntity entity = new GoodsEntity();
    entity.setId(1L);
    entity.setBrand("小米");
    entity.setCategory("手机");
    entity.setImages("xiaomi.jpg");
    entity.setPrice(1000D);
    entity.setTitle("小米3");
    
	goodsEsRepository.save(entity);
	
	System.out.println("修改成功");
}
```

**6.2.7.7 删除文档**

```java
/*
删除文档
*/
@Test
public void delData(){

	GoodsEntity entity = new GoodsEntity();
	entity.setId(1L);
	
    goodsEsRepository.delete(entity);

    System.out.println("删除成功");
}
```

**6.2.7.8 查询所有**

```java
/*
查询所有
*/
@Test
public void searchAll(){
    //查询总条数
    long count = goodsEsRepository.count();
    System.out.println(count);
    //查询所有数据
    Iterable<GoodsEntity> all = goodsEsRepository.findAll();
    all.forEach(goods -> {
   		 System.out.println(goods);
	});
}

```

**6.2.7.9 条件查询** 

**6.2.7.9.1 GoodsEsRepository**

```java
List<GoodsEntity> findAllByAndTitle(String title);


List<GoodsEntity> findByAndPriceBetween(Double start,Double end);
```

**6.2.7.9.2 条件查询**

```java
/*
条件查询
*/
@Test
public void searchByParam(){
    List<GoodsEntity> allByAndTitle = goodsEsRepository.findAllByAndTitle("手机");
    System.out.println(allByAndTitle);
   
   System.out.println("===============================");
    List<GoodsEntity> byAndPriceBetween =
    goodsEsRepository.findByAndPriceBetween(1000D, 3000D);
    
    System.out.println(byAndPriceBetween);
   }
```

**6.2.7.10 自定义查询**

```java
/*
自定义查询
*/
@Test
public void customizeSearch(){
		NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
		queryBuilder.withQuery(
			QueryBuilders.boolQuery()
				.must(QueryBuilders.matchQuery("title","华为"))
.must(QueryBuilders.rangeQuery("price").gte(1000).lte(10000))
);


	//排序
queryBuilder.withSort(SortBuilders.fieldSort("price").order(SortOrder.DESC));


            //分页
            //当前页 -1
           queryBuilder.withPageable(PageRequest.of(0,10));


			SearchHits<GoodsEntity> search = elasticsearchRestTemplate.search(queryBuilder.build(), GoodsEntity.class);


			search.getSearchHits().stream().forEach(hit -> {
				System.out.println(hit.getContent());
		});
}

```

**6.2.7.11 高亮**

```java
/*
高亮
*/
@Test
public void customizeSearchHighLight(){


        NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
        
        //构建高亮查询
        HighlightBuilder highlightBuilder = new HighlightBuilder();
        HighlightBuilder.Field title = new HighlightBuilder.Field("title");
        title.preTags("<span style='color:red'>");
        title.postTags("</span>");
        highlightBuilder.field(title);
        
        
        queryBuilder.withHighlightBuilder(highlightBuilder);//设置高亮
        queryBuilder.withQuery(
        QueryBuilders.boolQuery()
        .must(QueryBuilders.matchQuery("title","华为手机"))
        .must(QueryBuilders.rangeQuery("price").gte(1000).lte(10000))
        );
        queryBuilder.withSort(SortBuilders.fieldSort("price").order(SortOrder.DESC));
        queryBuilder.withPageable(PageRequest.of(0,2));
        
        SearchHits<GoodsEntity> search =
        elasticsearchRestTemplate.search(queryBuilder.build(), GoodsEntity.class);
        
        List<SearchHit<GoodsEntity>> searchHits = search.getSearchHits();
       
       //重新设置title
        List<SearchHit<GoodsEntity>> result = searchHits.stream().map(hit -> {
        Map<String, List<String>> highlightFields =
        hit.getHighlightFields();
        hit.getContent().setTitle(highlightFields.get("title").get(0));
       	 return hit;
        }).collect(Collectors.toList());
       	 System.out.println(result);
    }

```

****

**6.2.7.12 高亮工具类封装**

```java
package com.baidu.shop.utils;

import org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;
import org.springframework.data.elasticsearch.core.SearchHit;

import java.lang.reflect.Array;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;


public class HighLightUtil {

    public static HighlightBuilder getHighlightBuilder(String ...field){

        HighlightBuilder highlightBuilder = new HighlightBuilder();

        Arrays.asList(field).stream().forEach(f ->{
            highlightBuilder.field(f);//设置需要高亮的字段
            highlightBuilder.preTags("<span style='color:red'>");//前置标签
            highlightBuilder.postTags("</span>");//后置标签
        });

        return highlightBuilder;
    }

    public static <T> List<T> getHighlightList(List<SearchHit<T>> searchHits){

        return searchHits.stream().map(searchHit -> {
            T content = searchHit.getContent();
            Map<String, List<String>> highlightFields = searchHit.getHighlightFields();
            highlightFields.forEach((key, value) -> {

                try {

                    Method method = content.getClass().getMethod("set" + firstCharUpper(key), String.class);
                    //执行方法
                    method.invoke(content, value.get(0));
                } catch (NoSuchMethodException e) {
                    e.printStackTrace();
                } catch (IllegalAccessException e) {
                    e.printStackTrace();
                } catch (InvocationTargetException e) {
                    e.printStackTrace();
                }
            });
            return content;
        }).collect(Collectors.toList());
    }

    public static String firstCharUpper(String str){

        char[] chars = str.toCharArray();
        chars[0] -= 32;
        return String.valueOf(chars);
    }
}

```

```java
/*
使用工具类
*/

@Test
public void customizeSearchHighLightUtil(){
        NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
        //构建高亮查询
        queryBuilder.withHighlightBuilder(ESHighLightUtil.getHighlightBuilder("title"))
        ;//设置高亮
        queryBuilder.withQuery(
        QueryBuilders.boolQuery()
        .must(QueryBuilders.matchQuery("title","华为手机"))
        .must(QueryBuilders.rangeQuery("price").gte(1000).lte(10000))
        );
        SearchHits<GoodsEntity> search =
        elasticsearchRestTemplate.search(queryBuilder.build(), GoodsEntity.class);
        List<SearchHit<GoodsEntity>> searchHits = search.getSearchHits();
        //重新设置title
        List<SearchHit<GoodsEntity>> highLightHit =
        ESHighLightUtil.getHighLightHit(searchHits);
        
        System.out.println(highLightHit);
}


```

**6.2.7.13 聚合**

 **6.2.7.13.1 聚合为桶**

 **桶就是分组，比如这里我们按照品牌brand进行分组**：

```java
@Test
public void searchAgg(){

            NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
            queryBuilder.addAggregation(
            AggregationBuilders.terms("brand_agg").field("brand")
            );
            SearchHits<GoodsEntity> search =
            elasticsearchRestTemplate.search(queryBuilder.build(), GoodsEntity.class);
            Aggregations aggregations = search.getAggregations();
            //terms 是Aggregation的子接口
            //Aggregation brand_agg = aggregations.get("brand_agg");/
            Terms terms = aggregations.get("brand_agg");
            List<? extends Terms.Bucket> buckets = terms.getBuckets();
            buckets.forEach(bucket -> {
            System.out.println(bucket.getKeyAsString() + ":" +
            bucket.getDocCount());
            });
            System.out.println(search);
     }

```

**6.2.7.13.2 嵌套聚合，聚合函数值**

```java
/*
聚合函数
*/
@Test
public void searchAggMethod(){

          NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
          queryBuilder.addAggregation(
               AggregationBuilders.terms("brand_agg")
                .field("brand")
                //聚合函数
                .subAggregation(AggregationBuilders.max("max_price").field("price"))
                );
                
                
           SearchHits<GoodsEntity> search =
                elasticsearchRestTemplate.search(queryBuilder.build(), GoodsEntity.class);
                Aggregations aggregations = search.getAggregations();
                
                
        Terms terms = aggregations.get("brand_agg");
                List<? extends Terms.Bucket> buckets = terms.getBuckets();
                
                buckets.forEach(bucket -> {
                System.out.println(bucket.getKeyAsString() + ":" +
                bucket.getDocCount());
                //获取聚合
                
                
                Aggregations aggregations1 = bucket.getAggregations();
                
                
                //得到map
                Map<String, Aggregation> map = aggregations1.asMap();
                
                map.forEach((key,value) -> {
                //需要强转,为什么?
                //通过debug我们知道这个value的值是ParsedMax,ParsedMax是一个类(实现类),
                通过层层关系查找到最后他实现的接口是Aggregation,
                //接口类型转实现类需要强转
                //上面的Terms是Aggregation的子接口,所以Terms不需要强转
                ParsedMax v = (ParsedMax) value;
                System.out.println("key:" + key + "value:" + v.getValue());
            });
    });
}
```





# 七:搜索

## 1 学习目标

 独立编写数据导入功能 

独立实现基本搜索 

独立实现页面分页

 独立实现结果排序

## 2 门户网站

在vs-code工作空间下解压mrshop-internet-portal.zip

 vscode打开刚刚解压的项目 

VScode设置

![image-20210311204552728](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311204552728.png)

![image-20210311204606559](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311204606559.png)

![image-20210311204611746](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311204611746.png)

```java
"liveServer.settings.port": 9002
```

​	hosts文件

```java
127.0.0.1 www.mrshop.com
```

​	nginx.conf

```java
server {

 listen 80; server_name www.mrshop.com;

 location / { proxy_pass http://127.0.0.1:9002;

 proxy_connect_timeout 600; proxy_read_timeout 600;

} 

error_page 500 502 503 504 /50x.html; 

location = /50x.html {

 	root html; 

​	} 

}
```

## 3 后台项目搭建

注意spring-boot版本必须为2.3.1

### 3.1 mingrui-shop-service-api

#### 3.1.1 pom.xml

<!--2.3版本之后web删除了验证插件-->
<dependency>

<groupId>org.springframework.boot</groupId>

<artifactId>spring-boot-starter-validation<</artifactId>

</dependency>

<!--feign get请求需要使用@SpringQueryMap注解-->

<dependency>

<groupId>org.springframework.cloud</groupId>

<artifactId>spring-cloud-starter-openfeign<</artifactId>

</dependency>

### 3.1.2 新建项目mingrui-shop-service-api-search

#### 3.1.2.1 pom.xml

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

#### 3.1.2.2 新建包com.baidu.shop.document

#### 3.1.2.3 在包下新建类GoodsDoc

```java
package com.baidu.shop.document;

import lombok.Data;
import org.springframework.data.elasticsearch.annotations.Document;
import org.springframework.data.elasticsearch.annotations.Field;
import org.springframework.data.elasticsearch.annotations.FieldType;

import javax.persistence.Id;
import java.util.Date;
import java.util.List;
import java.util.Map;


@Document(indexName = "goods",shards = 1,replicas = 0)
@Data
public class GoodsDoc {
    @Id
    private Long id;
    @Field(type = FieldType.Text, analyzer = "ik_max_word")
    private String title;
    @Field(type = FieldType.Text, analyzer = "ik_max_word")
    private String brandName;
    @Field(type = FieldType.Text, analyzer = "ik_max_word")
    private String categoryName;
    @Field(type = FieldType.Keyword, index = false)
    private String subTitle;
    private Long brandId;
    private Long cid1;
    private Long cid2;
    private Long cid3;
    private Date createTime;
    private List<Long> price;
    @Field(type = FieldType.Keyword, index = false)
    private String skus;
    //规格
    private Map<String, Object> specs;
}
```

#### 3.1.2.4 com.baidu.shop下新建包service

#### 3.1.2.5 在service包下新建ShopElasticsearchService

```java
package com.baidu.shop.service;

import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.Result;
import com.baidu.shop.response.GoodsDocResponse;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;


@Api(tags = "elasticsearch接口")
public interface ShopElasticsearchService {

    @ApiOperation(value = "获取商品信息测试")
    @GetMapping(value = "es/goodsInfo")
    Result<JSONObject> esGoodsInfo();
ES数据初始化-->索引创建,映射创建,mysql数据同步
}

```

#### 3.1.2.6 在com.baidu.shop下新建config/MrSwagger2Config

```java
package com.baidu.shop.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;


@Configuration
@EnableSwagger2
public class BaiduSwaggerConfig {

    @Bean
    public Docket createRestApi(){
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(this.apiInfo())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.baidu"))
                .paths(PathSelectors.any())
                .build();
    }
    private ApiInfo apiInfo(){
        return new ApiInfoBuilder()
                //标题
                .title("明瑞SWAGGER2标题")
                //条款地址
                .termsOfServiceUrl("http://www.baidu.com")
                //联系方式-->有String参数的方法但是已经过时，所以不推荐使用
                .contact(new
                        Contact("11","baidu.com","111@163.com"))
                //版本
                .version("v1.0")
                //项目描述
                .description("描述")
                //创建API基本信息
                .build();
    }

}
```

### 3.2 mingrui-shop-common-core

#### 3.2.1 pom.xml

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

#### 3.2.2 utils包下新建ESHighLightUtil

```java
package com.baidu.shop.utils;

import org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;
import org.springframework.data.elasticsearch.core.SearchHit;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

public class EsUtils {

    public static HighlightBuilder getHighlightSetField(String ...field){


        if(field.length==0){
            return new HighlightBuilder();
        }
        HighlightBuilder highlightBuilder = new HighlightBuilder();

        Arrays.asList(field).stream().forEach(fields ->{
            highlightBuilder.field(fields);
        });
        highlightBuilder.preTags("<font color='red'>");
        highlightBuilder.postTags("</font>");

        return highlightBuilder;
    }


    //将返回的内容替换成高亮
    public static <T> List<SearchHit<T>> getHighLightHit(List<SearchHit<T>> list){
        return list.stream().map(hit -> {

            Map<String, List<String>> highlightFields =
                    hit.getHighlightFields();
            highlightFields.forEach((key,value) -> {
                try {
                    T content = hit.getContent();


                    Method method = content.getClass().getMethod("set" +
                            firstCharUpperCase(key),String.class);

                    method.invoke(content,value.get(0));
                } catch (NoSuchMethodException e) {
                    e.printStackTrace();
                } catch (IllegalAccessException e) {
                    e.printStackTrace();
                } catch (InvocationTargetException e) {
                    e.printStackTrace();
                }
            });
            return hit;
        }).collect(Collectors.toList());
    }


    //首字母大写,效率最高!
    private static String firstCharUpperCase(String name){
        char[] chars = name.toCharArray();
        chars[0] -= 32;
        return String.valueOf(chars);
    }






}
```

## 3.3 mingrui-shop-service

### 3.3.1 新建项目mingrui-shop-service-search

### 3.3.2 pom.xml

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
    </dependency>
   
    <dependency>
        <groupId>com.baidu</groupId>
        <artifactId>mingrui-shop-service-api-search</artifactId>
        <version>1.0-SNAPSHOT</version>
        <scope>compile</scope>
    </dependency>

</dependencies>
```

### 3.3.3 application.yml



```yml
spring:
  elasticsearch:
    rest:
      uris: 121.4.77.146:9200
  application:
    name: es-server
  jackson:
    default-property-inclusion: non_null
server:
  port: 8300
```

### 3.3.4 新建包com.baidu

### 3.3.5 新建启动类RunSearchServerApplication

```java
package com.baidu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.openfeign.EnableFeignClients;


//将自动配置数据源 剔除
@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})
@EnableEurekaClient
@EnableFeignClients
public class RunEsServerApplication {
    public static void main(String[] args) {

        SpringApplication.run(RunEsServerApplication.class,args);
    }
}
```

### 3.3.5 新建com.baidu.shop.feign

### 3.3.6 包下新建GoodsFeign

```java
package com.baidu.shop.feign;

import com.baidu.shop.service.GoodsService;
import org.springframework.cloud.openfeign.FeignClient;


@FeignClient(value = "xxx-server",contextId = "GoodsService")
public interface GoodsFeign extends GoodsService {


}
```

### 3.3.7 新建com.baidu.shop.service.impl

### 3.3.8 在包下新建ShopElasticsearchServiceImpl

```java
package com.baidu.shop.service.impl;
import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpuDTO;
import com.baidu.shop.feign.GoodsFeign;
import com.baidu.shop.service.ShopElasticsearchService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;

import java.util.*;


@RestController
public class ShopEsServiceImpl extends BaseApiService implements ShopElasticsearchService {

    @Autowired
    private GoodsFeign goodsFeign;

 

	@Override
    public Result<JSONObject> esGoodsInfo(  ) {

		SpuDTO good = new SpuDTO();

        good.setPage(1);
        good.setRows(10);
     goodsFeign.getSpuInfo(spuDTO);
     
    System.out.println(spuInfo);

        return null;
    }

 

}
```

### 3.4 mingrui-shop-service-xxx

### 3.4.1 GoodsServiceImpl

getSpuInfo需要增加分页信息的判断

```java
if(spuDTO.getPage() != null && spuDTO.getRows() != null) PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());
```

## 4 mysql数据迁移到es(数据准备)

## 4.1 spu和sku数据填充

### 4.1.1 GoodsService

```java
@ApiOperation(value = "获取spu详情信息")
@GetMapping(value = "goods/getSpuDetailBydSpu")
public Result<SpuDetailEntity> getSpuDetailBydSpu(@RequestParam Integer
spuId);

@ApiOperation(value = "获取sku信息")
@GetMapping(value = "goods/getSkuBySpuId")
Result<List<SkuDTO>> getSkuBySpuId(@RequestParam Integer spuId);

```

### 4.1.2 ShopElasticsearchServiceImpl

```java
        @Override
        public Result<JSONObject> esGoodsInfo() {

             SpuDTO spuDTO = new SpuDTO();
            spuDTO.setPage(1);
            spuDTO.setRows(5);
        Result<List<GoodsDTO>> goodsList = goodsFeign.getGoodsList(good);
        //获取spu数据.并填充数据.
        if(goodsList.isStartsSuccess()){
            //获取spu列表
            List<GoodsDTO> spuList = goodsList.getData();
            List<GoodsDoc> collect = spuList.stream().map(goods -> {
                //填充spu数据
                GoodsDoc goodsDoc = new GoodsDoc();
                goodsDoc.setId(goods.getId().longValue());
                goodsDoc.setBrandId(goods.getBrandId().longValue());
                goodsDoc.setTitle(goods.getTitle());
                goodsDoc.setBrandName(goods.getBrandName());
                goodsDoc.setCategoryName(goods.getCategoryName());
                goodsDoc.setCid1(goods.getCid1().longValue());
                goodsDoc.setCid2(goods.getCid2().longValue());
                goodsDoc.setCid3(goods.getCid3().longValue());
                goodsDoc.setSubTitle(goods.getSubTitle());
                goodsDoc.setCreateTime(goods.getCreateTime());
                //通过spuId查询多条sku数据.
                Result<List<SpecSkuDTO>> skuBySpuList = goodsFeign.getSkuBySpu(goods.getId());
                //判断查询是否成功
                if (skuBySpuList.isStartsSuccess()) {
                    Map<List<Long>, List<Map<String, Object>>> priceAndSku = this.getPriceAndSku(skuBySpuList);
                    priceAndSku.forEach((price,sku) ->{
                        //将sku数据填入到GoodsDoc中
                        goodsDoc.setSkus(JSONUtil.toJsonString(sku));
                        //将当前spu下的所有sku的价格存入GoodsDoc中
                        goodsDoc.setPrice(price) ;
                    });
                    //创建规格参数DTO
                    SpecParamDTO specParamDTO = new SpecParamDTO();
                    //通过分类的最后一级id查询规格参数.
                    specParamDTO.setCid(goods.getCid3());
                    //只查询支持搜索的
                    specParamDTO.setSearching(true);
                    //通过分类id查询规格参数数据
                    Result<List<SpectParamEntity>> specParamList = specificationFeign.getSpecParamList(specParamDTO);
                    if (specParamList.isStartsSuccess()) {
                     //获取specParam数据
                        Map<String, Object> paramsMap = this.getParamsMap(goods.getId(), specParamList);
                        goodsDoc.setSpecs(paramsMap);
                    }

                }
                return goodsDoc;

            }).collect(Collectors.toList());
            return collect;

        }

        return null;
    }
```

## 4.2 规格数据填充

现在会出现一个问题,那就是feign 重复的问题 

多个feign的name相同肯定是不行的,这个问题就相当于有多个相同的@RequestMapping一样 

理论上如果大家的电脑内存足够大,然后我们每一个模块就是一个服务,是绝对不会出现这个问题的

就比如说category-service,brand-service,....... 

但是我们得尊重现实 

所以我们需要解决一下这个问题 

在@FeignClient注解上增加属性contextId声明一下上下文的id,不管value属性的值是否一样,只要 contextId不一样就没有问题 

但是强烈不推荐大家这么做,如果大家在公司搭建springcloud框架的话,一定是将模块服务化

```java
@FeignClient(value = "xxx-server",contextId = "SpecificationService") public interface SpecificationFeign extends SpecificationService { }
```

```java
@FeignClient(contextId = "GoodsService", value = "xxx-server") @FeignClient(contextId = "SpecificationService", value = "xxx-server")
```

### 4.2.1 SpecificationService

```java
@ApiOperation(value = "查询规格参数")
@GetMapping(value = "specparam/getSpecParamInfo")
public Result> getSpecParamInfo(@SpringQueryMap SpecParamDTO specParamDTO);
```

### 4.2.2 JSONUtil

```java
  public static Map<String, String> toMapValueString(String json) {
        Map<String, String> map = gson.fromJson(json, new TypeToken<Map<String,
                String>>() {
        }.getType());
        return map;
    }
    public static Map<String, List<String>> toMapValueStrList(String json) {
        Map<String, List<String>> map = gson.fromJson(json, new
                TypeToken<Map<String, List<String>>>() {}.getType());
        return map;
    }
```

### 4.3.3 ShopElasticsearchServiceImpl

 @Override
        public Result<JSONObject> esGoodsInfo() {

```java
         SpuDTO spuDTO = new SpuDTO();
        spuDTO.setPage(1);
        spuDTO.setRows(5);
    Result<List<GoodsDTO>> goodsList = goodsFeign.getGoodsList(good);
    //获取spu数据.并填充数据.
    if(goodsList.isStartsSuccess()){
        //获取spu列表
        List<GoodsDTO> spuList = goodsList.getData();
        List<GoodsDoc> collect = spuList.stream().map(goods -> {
            //填充spu数据
            GoodsDoc goodsDoc = new GoodsDoc();
            goodsDoc.setId(goods.getId().longValue());
            goodsDoc.setBrandId(goods.getBrandId().longValue());
            goodsDoc.setTitle(goods.getTitle());
            goodsDoc.setBrandName(goods.getBrandName());
            goodsDoc.setCategoryName(goods.getCategoryName());
            goodsDoc.setCid1(goods.getCid1().longValue());
            goodsDoc.setCid2(goods.getCid2().longValue());
            goodsDoc.setCid3(goods.getCid3().longValue());
            goodsDoc.setSubTitle(goods.getSubTitle());
            goodsDoc.setCreateTime(goods.getCreateTime());
            //通过spuId查询多条sku数据.
            Result<List<SpecSkuDTO>> skuBySpuList = goodsFeign.getSkuBySpu(goods.getId());
            //判断查询是否成功
            if (skuBySpuList.isStartsSuccess()) {
                Map<List<Long>, List<Map<String, Object>>> priceAndSku = this.getPriceAndSku(skuBySpuList);
                priceAndSku.forEach((price,sku) ->{
                    //将sku数据填入到GoodsDoc中
                    goodsDoc.setSkus(JSONUtil.toJsonString(sku));
                    //将当前spu下的所有sku的价格存入GoodsDoc中
                    goodsDoc.setPrice(price) ;
                });
                //创建规格参数DTO
                SpecParamDTO specParamDTO = new SpecParamDTO();
                //通过分类的最后一级id查询规格参数.
                specParamDTO.setCid(goods.getCid3());
                //只查询支持搜索的
                specParamDTO.setSearching(true);
                //通过分类id查询规格参数数据
                Result<List<SpectParamEntity>> specParamList = specificationFeign.getSpecParamList(specParamDTO);
                if (specParamList.isStartsSuccess()) {
                 //获取specParam数据
                    Map<String, Object> paramsMap = this.getParamsMap(goods.getId(), specParamList);
                    goodsDoc.setSpecs(paramsMap);
                }

            }
            return goodsDoc;

        }).collect(Collectors.toList());
        return collect;

    }

    return null;
}
```
## 4.3 数值范围数据处理

![image-20210311211845038](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311211845038.png)

处理带有范围的属性值

```java
     SpuDTO spuDTO = new SpuDTO();
    spuDTO.setPage(1);
    spuDTO.setRows(5);
Result<List<GoodsDTO>> goodsList = goodsFeign.getGoodsList(good);
//获取spu数据.并填充数据.
if(goodsList.isStartsSuccess()){
    //获取spu列表
    List<GoodsDTO> spuList = goodsList.getData();
    List<GoodsDoc> collect = spuList.stream().map(goods -> {
        //填充spu数据
        GoodsDoc goodsDoc = new GoodsDoc();
        goodsDoc.setId(goods.getId().longValue());
        goodsDoc.setBrandId(goods.getBrandId().longValue());
        goodsDoc.setTitle(goods.getTitle());
        goodsDoc.setBrandName(goods.getBrandName());
        goodsDoc.setCategoryName(goods.getCategoryName());
        goodsDoc.setCid1(goods.getCid1().longValue());
        goodsDoc.setCid2(goods.getCid2().longValue());
        goodsDoc.setCid3(goods.getCid3().longValue());
        goodsDoc.setSubTitle(goods.getSubTitle());
        goodsDoc.setCreateTime(goods.getCreateTime());
        //通过spuId查询多条sku数据.
        Result<List<SpecSkuDTO>> skuBySpuList = goodsFeign.getSkuBySpu(goods.getId());
        //判断查询是否成功
        if (skuBySpuList.isStartsSuccess()) {
            Map<List<Long>, List<Map<String, Object>>> priceAndSku = this.getPriceAndSku(skuBySpuList);
            priceAndSku.forEach((price,sku) ->{
                //将sku数据填入到GoodsDoc中
                goodsDoc.setSkus(JSONUtil.toJsonString(sku));
                //将当前spu下的所有sku的价格存入GoodsDoc中
                goodsDoc.setPrice(price) ;
            });
            //创建规格参数DTO
            SpecParamDTO specParamDTO = new SpecParamDTO();
            //通过分类的最后一级id查询规格参数.
            specParamDTO.setCid(goods.getCid3());
            //只查询支持搜索的
            specParamDTO.setSearching(true);
            //通过分类id查询规格参数数据
            Result<List<SpectParamEntity>> specParamList = specificationFeign.getSpecParamList(specParamDTO);
            if (specParamList.isStartsSuccess()) {
             //获取specParam数据
                Map<String, Object> paramsMap = this.getParamsMap(goods.getId(), specParamList);
                goodsDoc.setSpecs(paramsMap);
            }

        }
        return goodsDoc;

    }).collect(Collectors.toList());
    return collect;

}

return null;
}
```
```java
private String chooseSegment(String value, String segments, String unit) {
    double val = NumberUtils.toDouble(value);
    String result = "其它";
    // 保存数值段
    for (String segment : segments.split(",")) {
        String[] segs = segment.split("-");
    // 获取数值范围
        double begin = NumberUtils.toDouble(segs[0]);
        double end = Double.MAX_VALUE;
        if(segs.length == 2){
            end = NumberUtils.toDouble(segs[1]);
        }
    // 判断是否在范围内
        if(val >= begin && val < end){
            if(segs.length == 1){
                result = segs[0] + unit + "以上";
            }else if(begin == 0){
                result = segs[1] + unit + "以下";
            }else{
                result = segment + unit;
            }
            break;
        }
    }
    return result;
}
```

至此所有的查询已经全部完毕,但是查询的函数已经太多代码

```java
import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.document.GoodsDoc;
import com.baidu.shop.dto.GoodsDTO;
import com.baidu.shop.dto.SpecDetailDTO;
import com.baidu.shop.dto.SpecParamDTO;
import com.baidu.shop.dto.SpecSkuDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.entity.SpectParamEntity;
import com.baidu.shop.feign.BrandFeign;
import com.baidu.shop.feign.CategoryFeign;
import com.baidu.shop.feign.GoodsFeign;
import com.baidu.shop.feign.SpecificationFeign;
import com.baidu.shop.response.GoodsDocResponse;
import com.baidu.shop.service.ShopElasticsearchService;
import com.baidu.shop.utils.EsUtils;
import com.baidu.shop.utils.JSONUtil;
import com.baidu.shop.utils.ObjectEqUtil;
import org.apache.commons.lang.StringUtils;
import org.apache.commons.lang.math.NumberUtils;
import org.elasticsearch.index.query.BoolQueryBuilder;
import org.elasticsearch.index.query.MatchQueryBuilder;
import org.elasticsearch.index.query.QueryBuilders;
import org.elasticsearch.search.aggregations.AggregationBuilders;
import org.elasticsearch.search.aggregations.Aggregations;
import org.elasticsearch.search.aggregations.bucket.terms.Terms;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;
import org.springframework.data.elasticsearch.core.IndexOperations;
import org.springframework.data.elasticsearch.core.SearchHit;
import org.springframework.data.elasticsearch.core.SearchHits;
import org.springframework.data.elasticsearch.core.query.FetchSourceFilter;
import org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder;
import org.springframework.web.bind.annotation.RestController;

import java.util.*;
import java.util.stream.Collectors;

/**
 * 2 * @ClassName ShopEsServiceImpl
 * 3 * @Description: TODO
 * 4 * @Author zzx
 * 5 * @Date 2021/3/4
 * 6 * @Version V1.0
 * 7
 **/
@RestController
public class ShopEsServiceImpl extends BaseApiService implements ShopElasticsearchService {

    @Autowired
    private GoodsFeign goodsFeign;

    @Autowired
    private SpecificationFeign specificationFeign;

    @Autowired
    private ElasticsearchRestTemplate elasticsearchRestTemplatel;

    @Autowired
    private CategoryFeign categoryFeign;

    @Autowired
    private BrandFeign brandFeign;



    @Override
    public GoodsDocResponse queryEs(String value, Integer page,String filter) {
        List<CategoryEntity> categoryEntities=null;
        Integer homCid=null;
        SearchHits<GoodsDoc> search = elasticsearchRestTemplatel.search(this.getQueryBuilder(value, page,filter).build(), GoodsDoc.class);
        List<SearchHit<GoodsDoc>> goodsList = EsUtils.getHighLightHit(search.getSearchHits());
        List<GoodsDoc> collect = goodsList.stream().map(goods -> {
            GoodsDoc content = goods.getContent();
            return content;
        }).collect(Collectors.toList());
        long total = search.getTotalHits();
        Double a = Math.ceil(Double.valueOf(total) / 10);
        long totalPage = a.longValue();
        Map<Integer, List<CategoryEntity>> categoryEntity = this.getCategoryEntity(search);
        for(Map.Entry<Integer, List<CategoryEntity>> entry:categoryEntity.entrySet()){
            categoryEntities=entry.getValue();
            homCid= entry.getKey();
        }


        return new GoodsDocResponse(total,totalPage,categoryEntities,this.getBrandEntity(search),collect,this.getSpecMap(homCid,value));
    }

    private NativeSearchQueryBuilder getQueryBuilder(String value,Integer page,String filter){
        NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();
        if(!StringUtils.isEmpty(filter) && filter.length()>2){
            Map<String, String> filterMap = JSONUtil.toMapValueString(filter);

            filterMap.forEach((k,v) -> {
                MatchQueryBuilder matchQueryBuilder=null;
                if(k.equals("brandId") || k.equals("cid3")){
                    matchQueryBuilder= QueryBuilders.matchQuery(k, v);
                }else{
                    matchQueryBuilder=QueryBuilders.matchQuery("specs."+k+".keyword", v);
                }
                boolQueryBuilder.must(matchQueryBuilder);
            });
            queryBuilder.withFilter(boolQueryBuilder);

        }
       // queryBuilder.withFilter(QueryBuilders.boolQuery().must(QueryBuilders.matchQuery(k, v)))

        queryBuilder.withQuery(QueryBuilders.multiMatchQuery(value,"title"));
        queryBuilder.withHighlightBuilder(EsUtils.getHighlightSetField(value));
        queryBuilder.withPageable(PageRequest.of(page-1,10));
        //设置查询出来的内容,页面上做多只需要id,title,skus
        queryBuilder.withSourceFilter(new FetchSourceFilter(new String[]{"id","title","skus"}, null));
        //设置聚合.

        queryBuilder.addAggregation(AggregationBuilders.terms("agg_category").field("cid3"));
        queryBuilder.addAggregation(AggregationBuilders.terms("agg_brand").field("brandId"));
        return queryBuilder;
    }
    private Map<String, List<String>> getSpecMap(Integer hotCid,String search){
        SpecParamDTO specParamDTO = new SpecParamDTO();
        specParamDTO.setCid(hotCid);
        specParamDTO.setSearching(true);
        Result<List<SpectParamEntity>> specParamInfo = specificationFeign.getSpecParamList(specParamDTO);
        Map<String, List<String>> specMap = new HashMap<>();


        List<SpectParamEntity> specParamList = specParamInfo.getData();

        NativeSearchQueryBuilder nativeSearchQueryBuilder = new NativeSearchQueryBuilder();
            nativeSearchQueryBuilder.withQuery(
                    QueryBuilders.multiMatchQuery(search,"title","brandName","categoryName")
            );
            nativeSearchQueryBuilder.withPageable(PageRequest.of(0,1));
            specParamList.stream().forEach(specParam -> {
                nativeSearchQueryBuilder.addAggregation(AggregationBuilders.terms(specParam.getName())
                        .field("specs." + specParam.getName() + ".keyword"));
            });

            SearchHits<GoodsDoc> searchHits = elasticsearchRestTemplatel.search(nativeSearchQueryBuilder.build(), GoodsDoc.class);
            Aggregations aggregations = searchHits.getAggregations();

            specParamList.stream().forEach(specParam -> {

                Terms aggregation = aggregations.get(specParam.getName());
                List<? extends Terms.Bucket> buckets = aggregation.getBuckets();
                List<String> valueList = buckets.stream().map(bucket -> bucket.getKeyAsString()).collect(Collectors.toList());

                specMap.put(specParam.getName(),valueList);
            });


        return specMap;
    }

    private Map<Integer, List<CategoryEntity>> getCategoryEntity(SearchHits<GoodsDoc>  search){
        Terms agg_category = search.getAggregations().get("agg_category");
        List<Integer> homCid = Arrays.asList(0);
        List<Integer> DocCount = Arrays.asList(0);
        Map<Integer, List<CategoryEntity>> map = new HashMap<>();
        List<String> categoryIdList = agg_category.getBuckets().stream().map(a ->{
            if(a.getDocCount() > DocCount.get(0)){
                DocCount.set(0,Integer.parseInt(a.getDocCount()+""));
                homCid.set(0, a.getKeyAsNumber().intValue());
            }
                return a.getKeyAsString();
        }).collect(Collectors.toList());


        Result<List<CategoryEntity>> categoryList=categoryFeign.getCategoryListById(String.join(",",categoryIdList));
        List<CategoryEntity> categoryEntities=null;
        if(categoryList.isStartsSuccess()){
            categoryEntities= categoryList.getData();
        }
        map.put(homCid.get(0), categoryEntities);


        return  map;
    }

    private List<BrandEntity> getBrandEntity(SearchHits<GoodsDoc>  search ){
        Terms agg_brand = search.getAggregations().get("agg_brand");
        List<String> brandIdList = agg_brand.getBuckets().stream().map(a -> a.getKeyAsString()).collect(Collectors.toList());
        Result<List<BrandEntity>> brandList=brandFeign.getBrandListById(String.join(",",brandIdList));
        List<BrandEntity> brandEntities=null;
        if(brandList.isStartsSuccess()){
            brandEntities = brandList.getData();
        }
        return brandEntities;
    }


    @Override
    public Result<JSONObject> initGoodsEsData() {
        IndexOperations indexOperations = elasticsearchRestTemplatel.indexOps(GoodsDoc.class);
        if(!indexOperations.exists()){
            indexOperations.create();
            indexOperations.createMapping();
        }
        List<GoodsDoc> goodsDocs = this.esGoodsInfo(new GoodsDTO());
        if(!goodsDocs.isEmpty()){
           goodsDocs.forEach( a ->{
               System.out.println(a);
           });
            elasticsearchRestTemplatel.save(goodsDocs);
        }
        return this.setResultSuccess();
    }

    @Override
    public Result<JSONObject> saveData(Integer spuId) {
        GoodsDTO goodsDTO = new GoodsDTO();
        goodsDTO.setId(spuId);
        List<GoodsDoc> goodsDocs = this.esGoodsInfo(goodsDTO);
        elasticsearchRestTemplatel.save(goodsDocs.get(0));
        return this.setResultSuccess();
    }

    @Override
    public Result<JSONObject> delData(Integer spuId) {
        GoodsDoc goodsDoc = new GoodsDoc();
        goodsDoc.setId(spuId.longValue());
        elasticsearchRestTemplatel.delete(goodsDoc);
        return this.setResultSuccess();
    }

    @Override
    public Result<JSONObject> clearGoodsEsData() {
        IndexOperations indexOperations = elasticsearchRestTemplatel.indexOps(GoodsDoc.class);
        indexOperations.delete();
        return this.setResultSuccess();
    }



    private List<GoodsDoc> esGoodsInfo(GoodsDTO good ) {


//        good.setPage(1);
//        good.setRows(10);
        Result<List<GoodsDTO>> goodsList = goodsFeign.getGoodsList(good);
        //获取spu数据.并填充数据.
        if(goodsList.isStartsSuccess()){
            //获取spu列表
            List<GoodsDTO> spuList = goodsList.getData();
            List<GoodsDoc> collect = spuList.stream().map(goods -> {
                //填充spu数据
                GoodsDoc goodsDoc = new GoodsDoc();
                goodsDoc.setId(goods.getId().longValue());
                goodsDoc.setBrandId(goods.getBrandId().longValue());
                goodsDoc.setTitle(goods.getTitle());
                goodsDoc.setBrandName(goods.getBrandName());
                goodsDoc.setCategoryName(goods.getCategoryName());
                goodsDoc.setCid1(goods.getCid1().longValue());
                goodsDoc.setCid2(goods.getCid2().longValue());
                goodsDoc.setCid3(goods.getCid3().longValue());
                goodsDoc.setSubTitle(goods.getSubTitle());
                goodsDoc.setCreateTime(goods.getCreateTime());
                //通过spuId查询多条sku数据.
                Result<List<SpecSkuDTO>> skuBySpuList = goodsFeign.getSkuBySpu(goods.getId());
                //判断查询是否成功
                if (skuBySpuList.isStartsSuccess()) {
                    Map<List<Long>, List<Map<String, Object>>> priceAndSku = this.getPriceAndSku(skuBySpuList);
                    priceAndSku.forEach((price,sku) ->{
                        //将sku数据填入到GoodsDoc中
                        goodsDoc.setSkus(JSONUtil.toJsonString(sku));
                        //将当前spu下的所有sku的价格存入GoodsDoc中
                        goodsDoc.setPrice(price) ;
                    });
                    //创建规格参数DTO
                    SpecParamDTO specParamDTO = new SpecParamDTO();
                    //通过分类的最后一级id查询规格参数.
                    specParamDTO.setCid(goods.getCid3());
                    //只查询支持搜索的
                    specParamDTO.setSearching(true);
                    //通过分类id查询规格参数数据
                    Result<List<SpectParamEntity>> specParamList = specificationFeign.getSpecParamList(specParamDTO);
                    if (specParamList.isStartsSuccess()) {
                     //获取specParam数据
                        Map<String, Object> paramsMap = this.getParamsMap(goods.getId(), specParamList);
                        goodsDoc.setSpecs(paramsMap);
                    }

                }
                return goodsDoc;

            }).collect(Collectors.toList());
            return collect;

        }

        return null;
    }

    private  Map<List<Long>,List<Map<String, Object>>> getPriceAndSku(Result<List<SpecSkuDTO>> skuBySpuList){
        Map<List<Long>,List<Map<String, Object>>> map = new HashMap<>();
        //获取sku列
        List<SpecSkuDTO> skuList = skuBySpuList.getData();

        //创建price列表准备加入数据
        List<Long> priceList = new ArrayList<>();

        //当前spu下的所有sku数据
        List<Map<String, Object>> skuAllList = skuList.stream().map(sku -> {
            //获取sku里需要的数据并放到map中.
            Map<String, Object> skuMap = new HashMap<>();
            skuMap.put("id", sku.getId());
            skuMap.put("title", sku.getTitle());
            skuMap.put("image", sku.getImages());
            skuMap.put("price", sku.getPrice());
            //价格加入到list
            priceList.add(sku.getPrice().longValue());
            return skuMap;

        }).collect(Collectors.toList());
        map.put(priceList,skuAllList);
        return map;
    }
    private Map<String,Object> getParamsMap(Integer goodsId,Result<List<SpectParamEntity>> specParamList){
        Result<SpecDetailDTO> specDetailBySpuId = goodsFeign.getSpecDetailBySpuId(goodsId);
        if (specDetailBySpuId.isStartsSuccess()) {
            SpecDetailDTO detailData = specDetailBySpuId.getData();
            //获取通用属性.
            Map<String, String> tongYo = JSONUtil.toMapValueString(detailData.getGenericSpec());
            //获取私有属性.
            Map<String, List<String>> siYo = JSONUtil.toMapValueStrList(detailData.getSpecialSpec());
            Map<String, Object> paramsMap = new HashMap<>();
            List<SpectParamEntity> specParam = specParamList.getData();
            specParam.stream().forEach(param -> {
              
                //判断是否是数值类型
                if (param.getGeneric()) {
                    //判断是否是数值类型.以及范围不为空
                    if (param.getNumeric() && ObjectEqUtil.isNotNull(param.getSegments())) {

                        paramsMap.put(param.getName(), chooseSegment(tongYo.get(param.getId() + ""), param.getSegments(), param.getUnit()));

                    } else {
                        paramsMap.put(param.getName(), tongYo.get(param.getId() + ""));

                    }
                } else {
                    paramsMap.put(param.getName(), siYo.get(param.getId() + ""));
                }



            });
            return paramsMap;

        }
        return null;
    }


    private String chooseSegment(String value, String segments, String unit) {
        double val = NumberUtils.toDouble(value);
        String result = "其它";
        // 保存数值段
        for (String segment : segments.split(",")) {
            String[] segs = segment.split("-");
        // 获取数值范围
            double begin = NumberUtils.toDouble(segs[0]);
            double end = Double.MAX_VALUE;
            if(segs.length == 2){
                end = NumberUtils.toDouble(segs[1]);
            }
        // 判断是否在范围内
            if(val >= begin && val < end){
                if(segs.length == 1){
                    result = segs[0] + unit + "以上";
                }else if(begin == 0){
                    result = segs[1] + unit + "以下";
                }else{
                    result = segment + unit;
                }
                break;
            }
        }
        return result;
    }


}
```

## 5 mysql数据迁移到es(入库)

### 5.1 提供操作ESApi

### 5.1.1 ShopElasticsearchService 

将查询数据的接口删除掉

 实现类中查询数据的@Override删除掉 

查询数据的返回值为List,注意函数需要返回数据(return)

```java
//ES数据初始化-->索引创建,映射创建,mysql数据同步
@ApiOperation(value = "ES商品数据初始化-->索引创建,映射创建,mysql数据同步")
@GetMapping(value = "es/initGoodsEsData") Result initGoodsEsData();

@ApiOperation(value = "清空ES中的商品数据") 
@GetMapping(value = "es/clearGoodsEsData") Result clearGoodsEsData();
```

### 5.1.2 新建repository包

### 5.1.3 新建GoodsRepository

```java
import com.baidu.shop.document.GoodsDoc;
import org.springframework.data.elasticsearch.repository.ElasticsearchRepository; 
public interface GoodsRepository extends ElasticsearchRepository<GoodsDoc,Long> { }
```

### 5.1.4 ShopElasticsearchServiceImpl

```java
@Resource
private ElasticsearchRestTemplate elasticsearchRestTemplate;
@Resource private GoodsRepository goodsRepository;
@Override
public Result clearGoodsEsData() {
    IndexOperations index = elasticsearchRestTemplate.indexOps(GoodsDoc.class);
    if(index.exists()){
        index.delete();
    } 
    return this.setResultSuccess();
}
```

```java
@Override 
public Result initGoodsEsData() { //创建索引和映射
    IndexOperations index = elasticsearchRestTemplate.indexOps(GoodsDoc.class);
    if(!index.exists()){
        index.create();
        index.createMapping(); 
    } //查询数据 
    List goodsDocs = this.esGoodsInfo(); 
    //将得到的结果入库
    goodsRepository.saveAll(goodsDocs);
    //elasticsearchRestTemplate.save(goodsDocs);
    return this.setResultSuccess();
}
```

## 5.2 mysql数据库全部迁移

上述入库操作也只是将部分数据入库了而已,

在真实的环境中我们需要考虑实际情况来进行数据迁移 查询全部mysql数据肯定是不合适的(数据库压力太大) 一次查询五条数据????(这样会增加数据库和es服务的io) 

所以得考虑硬件条件 以及 mysql 和 es的性能 当前我们是学习阶段,

数据量不是很大,所以可以直接将mysql的数据全部查询出来,然后全部入库

### 5.2.1 initGoodsEsData方法

```java
@Override
public Result<JSONObject> initGoodsEsData() {
    IndexOperations indexOperations = elasticsearchRestTemplatel.indexOps(GoodsDoc.class);
    if(!indexOperations.exists()){
        indexOperations.create();
        indexOperations.createMapping();
    }
    List<GoodsDoc> goodsDocs = this.esGoodsInfo(new GoodsDTO());
    if(!goodsDocs.isEmpty()){
       goodsDocs.forEach( a ->{
           System.out.println(a);
       });
        elasticsearchRestTemplatel.save(goodsDocs);
    }
    return this.setResultSuccess();
}
```

### 5.2.2 esGoodsInfo方法

将分页注释掉

### 5.2.3 重置es数据

swagger-ui调用clearGoodsEsData接口清空掉es数据 

swagger-ui调用initGoodsEsData重新初始化数据

## 6 搜索

### 6.1 top.js

top.html并没有什么用(在top.html写完代码后直接将这个html代码复制到了top.js的template中)

![image-20210311212744964](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311212744964.png)



![image-20210311212750413](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311212750413.png)



![image-20210311212755868](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311212755868.png)

我们将template属性的值改一下:将top.html中的html代码复制到template的值中,需要注意的是: 不要忘记加 <shortcut/> 标签

```vue
const b2cTop = {

  template: ` 

    <div class="nav-top">

  <shortcut/>

  <!--头部-->

    <div class="header" id="headApp">

        <div class="py-container">

            <div class="yui3-g Logo">

                <div class="yui3-u Left logoArea">

                    <a class="logo-bd" title="全品" href="index.html" target="_blank"></a>

​        </div>

                <div class="yui3-u Center searchArea">

                    <div class="search">

​            <form action="" class="sui-form form-inline">

​              <!--searchAutoComplete-->

                            <div class="input-append">

​                <input type="text" id="autocomplete" v-model="key"

​                    class="input-error input-xxlarge"/>

​                <button @click="search" class="sui-btn btn-xlarge btn-danger" type="button">搜索</button>

​              </div>

​            </form>

​          </div>

                    <div class="hotwords">

​            <ul>

​              <li class="f-item">全品首发</li>

​              <li class="f-item">亿元优惠</li>

​              <li class="f-item">9.9元团购</li>

​              <li class="f-item">每满99减30</li>

​              <li class="f-item">亿元优惠</li>

​              <li class="f-item">9.9元团购</li>

​              <li class="f-item">办公用品</li>



​            </ul>

​          </div>

​        </div>

                <div class="yui3-u Right shopArea">

                    <div class="fr shopcar">

                        <div class="show-shopcar" id="shopcar">

​              <span class="car"></span>

                            <a class="sui-btn btn-default btn-xlarge" href="cart.html" target="_blank">

​                <span>我的购物车</span>

​                <i class="shopnum">0</i>

​              </a>

                            <div class="clearfix shopcarlist" id="shopcarlist" style="display:none">

                                <p>"啊哦，你的购物车还没有商品哦！"</p>

                                <p>"啊哦，你的购物车还没有商品哦！"</p>

​              </div>

​            </div>

​          </div>

​        </div>

​      </div>



            <div class="yui3-g NavList">

                <div class="yui3-u Left all-sort">

​          <h4>全品精品</h4>

​        </div>

                <div class="yui3-u Center navArea">

​          <ul class="nav">

​            <li class="f-item">服装城</li>

​            <li class="f-item">美妆馆</li>

​            <li class="f-item">品优超市</li>

​            <li class="f-item">全球购</li>

​            <li class="f-item">闪购</li>

​            <li class="f-item">团购</li>

​            <li class="f-item">有趣</li>

​            <li class="f-item"><a href="seckill-index.html" target="_blank">秒杀</a></li>

​          </ul>

​        </div>

                <div class="yui3-u Right"></div>

​      </div>

​    </div>

  </div>

  </div>`,

  name:'b2c-top',

  data() {

​    return {

​      key: "",

​      query: location.search

​    }

  },

  methods: {

​    search() {

​      window.location = 'search.html?key=' + this.key;

​    },

​    getUrlParam: function (name) {

​      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");

​      var r = window.location.search.substr(1).match(reg);

​      if (r != null) {

​        return decodeURI(r[2]);

​      }

​      return null;

​    }

​    

  },

  created() {

​    this.key = this.getUrlParam("key");

  },

  components: {

​    shortcut:() => import('./shortcut.js')

  }

}

export default b2cTop;
```

### 6.2 search.html

![image-20210311213026077](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213026077.png)

![image-20210311213046746](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213046746.png)

```html
<!DOCTYPE html>

<html xmlns:v-bind="http://www.w3.org/1999/xhtml">



<head>

    <meta charset="utf-8"/>

    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>

  <title>全品商城--商品搜索结果页</title>

  <link rel="icon" href="assets/img/favicon.ico">

  <link href='./css/material.css' rel="stylesheet">

  <link href="./css/vuetify.min.css" rel="stylesheet">

    <script src="./js/vue/vue.js"></script>

    <script src="./js/vue/vuetify.js"></script>

    <script src="./js/axios.min.js"></script>

    <script src="./js/common.js"></script>

  <link rel="stylesheet" type="text/css" href="css/webbase.css"/>

  <link rel="stylesheet" type="text/css" href="css/pages-list.css"/>

  <link rel="stylesheet" type="text/css" href="css/widget-cartPanelView.css"/>

    <style type="text/css">

\* {

  box-sizing: unset;

}

​    .btn-arrow, .btn-arrow:visited, .btn-arrow:link, .btn-arrow:active {

​      width: 46px;

​      height: 23px;

​      border: 1px solid #DDD;

​      background: #FFF;

​      line-height: 23px;

​      font-family: "\5b8b\4f53";

​      text-align: center;

​      font-size: 16px;

​      color: #AAA;

​      text-decoration: none;

​      out-line: none

​    }



​    .btn-arrow:hover {

​      background-color: #1299ec;

​      color: whitesmoke;

​    }



​    .top-pagination {

​      display: block;

​      padding: 3px 15px;

​      font-size: 11px;

​      font-weight: 700;

​      line-height: 18px;

​      color: #999;

​      text-shadow: 0 1px 0 rgba(255, 255, 255, .5);

​      text-transform: uppercase;

​      float: right;

​      margin-top: 6px

​    }



​    .top-pagination span {

​      margin-right: 10px;

​    }

​    .logo-list li{

​      padding:8px;

​    }

​    .logo-list li:hover{

​      background-color: #f3f3f3;

​    }

​    .type-list a:hover{

​      color: #1299ec;

​    }

​    .skus {

​      list-style: none;

​    }

​    .skus li{

​      list-style: none;

​      display: inline-block;

​      float: left;

​      margin-left: 2px;

​      border: 2px solid #f3f3f3;

​    }

​    .skus li.selected{

​      border: 2px solid #dd1144;

​    }

​    .skus img{

​      width: 25px;

​      height: 25px;

​    }

  </style>

    <script type="text/javascript" src="plugins/jquery/jquery.min.js"></script>

</head>



<body >



<div id="searchApp">

<div id="nav-bottom">

  <b2c-top/>

</div>





<!--list-content-->

<div class="main" >

    <div class="py-container">



        <div class="bread">

​      <!--面包屑-->

​      <ul class="fl sui-breadcrumb">

​        <li><span>全部结果:</span></li>

​        <li ><a href="#">手机</a></li>

​        <li ><span>手机通讯</span></li>

​      </ul>

​      <!--已选择过滤项-->

​      <ul class="tags-choose">

​        <li class="tag" v-for="(value,key,index) in filter" :key="index">

​          {{key =='brandId'?'品牌':key=='cid3'?'分类':key}}<span style="color: red">{{ getValueFilter(key,value) }}</span>

​          <i class="sui-icon icon-tb-close" @click="deleteFilter(key)"></i>

​        </li>

​      </ul>

            <div class="clearfix"></div>

​    </div>

​    <!--selector-->

        <div class="clearfix selector">

            <div class="type-wrap">

                <div class="fl key">分类</div>

                <div class="fl value">

​          <ul class="type-list">

​            <li v-for="(value,index) in categoryList" @click="addFilter('cid3',value.id)" :key="index">

                            <a>{{value.name}}</a>

​            </li>

​          </ul>

​        </div>

                <div class="fl ext"></div>

​      </div>

            <div class="type-wrap logo">

                <div class="fl key brand">品牌</div>

                <div class="value logos">

​          <ul class="logo-list">

​            <li v-for="(value,index) in brandList" @click="addFilter('brandId',value.id)":key="index" v-if="value">

                            <img :src="value.image" />

​            </li>

​            

​            <li style="text-align: center" v-else><a style="line-height: 30px; font-size: 12px" href="#">xx</a></li>

​          </ul>

​        </div>

                <div class="fl ext">

                    <a href="javascript:void(0);" class="sui-btn">多选</a>

​        </div>

​      </div>

            <div class="type-wrap" v-for="(value,key,index) in specAggMap" v-show="index < 3 || isMore" :key="index">

                <div class="fl key">{{key}}</div>

                <div class="fl value">

​          <ul class="type-list">

​            <li v-for="(v,index) in value" @click="addFilter(key,v)" v-show="index <8">

                            <a>{{v}}</a>

​            </li>

​          </ul>

​        </div>

                <div class="fl ext"></div>

​      </div>

​      

            <div class="type-wrap" style="text-align: center">

​        <v-btn small flat @click="isMore= true" v-show="!isMore">

​          更多<v-icon>arrow_drop_down</v-icon>

​          </v-btn>

​          <v-btn small="" flat @click="isMore = false" v-show="isMore">

​          收起<v-icon>arrow_drop_up</v-icon>

​          </v-btn>

​      </div>

​    </div>

​    <!--details-->

        <div class="details">

            <div class="sui-navbar">

                <div class="navbar-inner filter">

​          <ul class="sui-nav">

​            <li class="active">

                            <a href="#">综合</a>

​            </li>

​            <li>

                            <a href="#">销量</a>

​            </li>

​            <li>

                            <a href="#">新品</a>

​            </li>

​            <li>

                            <a href="#">评价</a>

​            </li>

​            <li>

                            <a href="#">价格</a>

​            </li>

​          </ul>

                    <div class="top-pagination">

​            <span>共 <i style="color: #222;">{{total}}+</i> 商品</span>

​            <span><i style="color: red;">{{ page }}</i>/{{ totalPage }}</span>

                        <a class="btn-arrow" href="#" style="display: inline-block"  @click="page--" @click.prevent="zuzhishijian" >&lt;</a>

                        <a class="btn-arrow" href="#" style="display: inline-block"  @click="page++" @click.prevent="zuzhishijian">&gt;</a>

​          </div>

​        </div>

​      </div>

            <div class="goods-list">

​        <ul class="yui3-g">

​          <li class="yui3-u-1-5" v-for="(goods,index) in goodsList" :key="index">

                        <div class="list-wrap">

                            <div class="p-img">

                                <a :href="'/item/'+goods.id+'.html'" target="_blank"><img :src="goods.selected.image" height="200"/></a>

​                <ul class="skus">

​                  <li :class="{selected:sku.id=goods.selected.id}"

​                  @click="goods.selected=sku"

​                   v-for="(sku,index) in goods.skus"

​                   :key="index"

​                   

​                   \>

                                        <img :src="sku.image" >

​                  </li>

​                  

​                </ul>

​              </div>

                            <div class="clearfix"></div>

                            <div class="price">

​                <strong>

​                  <em>¥</em>

​                  <i>{{ mrshop.formatPrice(goods.selected.price) }}</i>

​                </strong>

​              </div>

                            <div class="attr">

​                <em v-html="goods.title"></em>

​              </div>

                            <div class="cu">

​                <em><span>促</span>满一件可参加超值换购</em>

​              </div>

                            <div class="commit">

​                <i class="command">已有2000人评价</i>

​              </div>

                            <div class="operate">

                                <a href="success-cart.html" target="_blank" class="sui-btn btn-bordered btn-danger">加入购物车</a>

                                <a href="javascript:void(0);" class="sui-btn btn-bordered">对比</a>

                                <a href="javascript:void(0);" class="sui-btn btn-bordered">关注</a>

​              </div>

​            </div>

​          </li>

​          

​        </ul>

​      </div>

            <div class="fr">

                <div class="sui-pagination pagination-large">

​          <ul>

​            <li class="prev disabled" @click="page--">

                            <a href="#" @click.prevent="zuzhishijian">«上一页</a>

​            </li>

​            <li :class="{active : value == page}"

​            @click="page = value"

​            v-for="(value,index) in totalPage"

​            v-if="value < 5"

​            :key="index">

                            <a href="#" @click.prevent="zuzhishijian">{{ value }}</a>

​            </li>

​            <li class="dotted" v-show="totalPage > 5"><span>...</span></li>

​            <li class="next" @click="page++">

                            <a href="#" @click.prevent="zuzhishijian">下一页»</a>

​            </li>

​          </ul>

                    <div><span>共{{ totalPage}}页&nbsp;</span><span>

   到第

   <input type="text" class="page-num">

   页 <button class="page-confirm" onclick="alert(1)">确定</button></span></div>

​        </div>

​      </div>

​    </div>

​    <!--hotsale-->

        <div class="clearfix hot-sale">

​      <h4 class="title">热卖商品</h4>

            <div class="hot-list">

​        <ul class="yui3-g">

​          <li class="yui3-u-1-4">

                        <div class="list-wrap">

                            <div class="p-img">

                                <img src="img/like_01.png"/>

​              </div>

                            <div class="attr">

​                <em>Apple苹果iPhone 6s (A1699)</em>

​              </div>

                            <div class="price">

​                <strong>

​                  <em>¥</em>

​                  <i>4088.00</i>

​                </strong>

​              </div>

                            <div class="commit">

​                <i class="command">已有700人评价</i>

​              </div>

​            </div>

​          </li>

​          <li class="yui3-u-1-4">

                        <div class="list-wrap">

                            <div class="p-img">

                                <img src="img/like_03.png"/>

​              </div>

                            <div class="attr">

​                <em>金属A面，360°翻转，APP下单省300！</em>

​              </div>

                            <div class="price">

​                <strong>

​                  <em>¥</em>

​                  <i>4088.00</i>

​                </strong>

​              </div>

                            <div class="commit">

​                <i class="command">已有700人评价</i>

​              </div>

​            </div>

​          </li>

​          <li class="yui3-u-1-4">

                        <div class="list-wrap">

                            <div class="p-img">

                                <img src="img/like_04.png"/>

​              </div>

                            <div class="attr">

​                <em>256SSD商务大咖，完爆职场，APP下单立减200</em>

​              </div>

                            <div class="price">

​                <strong>

​                  <em>¥</em>

​                  <i>4068.00</i>

​                </strong>

​              </div>

                            <div class="commit">

​                <i class="command">已有20人评价</i>

​              </div>

​            </div>

​          </li>

​          <li class="yui3-u-1-4">

                        <div class="list-wrap">

                            <div class="p-img">

                                <img src="img/like_02.png"/>

​              </div>

                            <div class="attr">

​                <em>Apple苹果iPhone 6s (A1699)</em>

​              </div>

                            <div class="price">

​                <strong>

​                  <em>¥</em>

​                  <i>4088.00</i>

​                </strong>

​              </div>

                            <div class="commit">

​                <i class="command">已有700人评价</i>

​              </div>

​            </div>

​          </li>

​        </ul>

​      </div>

​    </div>

  </div>

</div>



</div>



<script type="text/javascript">

  var vm = new Vue({

​    el: "#searchApp",

​    data: {

​      goodsList:[],

​      mrshop,

​      page:1,

​      total:0,

​      totalPage:0,

​      categoryList:[],

​      brandList:[],

​      specAggMap:{},

​      isMore:false,

​      filter:{}

​    },

   

​      watch: {

​      page () {

​        this.search();

​      }

​    



​    },

​    methods:{

​      deleteFilter(key){

​        delete this.filter[key]

​        this.search();

​      },

​      getValueFilter(key,value){

​        if(key == 'cid3'){

​          this.categoryList.forEach(category => {

​            if(category.id == value){

​            value = category.name;

​            }

​          })

​        }else if(key == 'brandId'){

​          this.brandList.forEach(brand => {

​            if(brand.id == value){

​              value = brand.name;

​            }

​          })

​        }

​        return value;



​        

​      },

​      addFilter(key,value){

​          this.filter[key]=value;

​          this.search();

​          

​      },

​      quxiaoshijian (){},

​      search(){

​        mrshop.http("/es/queryEs",{

​        params:{

​          value:mrshop.parse(location.search.substring(1)),

​          page:this.page,

​          filter:JSON.stringify(this.filter)

​        }

​      }).then(resp =>{

​        console.log(resp);

​       //处理sku

​      const dataList = resp.data.data.map(goods => {

​      goods.skus = JSON.parse(goods.skus);//将字符串转为json

​      goods.selected = goods.skus[0];//设置当前选中

​      return goods;

​      })

​      this.goodsList = dataList;

​      this.brandList=resp.data.brandEntityList;

​      this.categoryList=resp.data.categoryEntityList;

​     



​      this.total = resp.data.total;

​      this.totalPage = resp.data.totalPage;

​      this.specAggMap=resp.data.specAggMap;



​      //把json对象转为Object类型的对象; Object.assign();





​      }).catch(error =>console.log(error))



​      }





​    },

​    components:{

​      b2cTop: () => import("./js/pages/top.js")

​    },

​    created(){

​      this.search();

​      

​    }

  });

</script>

<!-- 底部栏位 -->

<!--页面底部，由js动态加载-->

<div class="clearfix footer"></div>

<script type="text/javascript">$(".footer").load("foot.html");</script>

<!--页面底部END-->



</body >

<!--购物车单元格 模板-->

<script type="text/template" id="tbar-cart-item-template">

    <div class="tbar-cart-item">

        <div class="jtc-item-promo">

​      <em class="promo-tag promo-mz">满赠<i class="arrow"></i></em>

            <div class="promo-text">已购满600元，您可领赠品</div>

​    </div>

        <div class="jtc-item-goods">

​      <span class="p-img"><a href="#" target="_blank"><img src="{2}" alt="{1}" height="50" width="50"/></a></span>

            <div class="p-name">

                <a href="#">{1}</a>

​      </div>

            <div class="p-price"><strong>¥{3}</strong>×{4}</div>

            <a href="#none" class="p-del J-del">删除</a>

​    </div>

  </div>

</script>

<!--侧栏面板结束-->

<script type="text/javascript" src="js/plugins/jquery/jquery.min.js"></script>

<script type="text/javascript">

  $(function () {

​    $("#service").hover(function () {

​      $(".service").show();

​    }, function () {

​      $(".service").hide();

​    });

​    $("#shopcar").hover(function () {

​      $("#shopcarlist").show();

​    }, function () {

​      $("#shopcarlist").hide();

​    });



  })

</script>

<script type="text/javascript" src="js/model/cartModel.js"></script>

<script type="text/javascript" src="js/czFunction.js"></script>

<script type="text/javascript" src="js/plugins/jquery.easing/jquery.easing.min.js"></script>

<script type="text/javascript" src="js/plugins/sui/sui.min.js"></script>

<script type="text/javascript" src="js/widget/cartPanelView.js"></script>





</html>
```

### 6.3 ShopElasticsearchService

```java
@ApiOperation(value = "搜索") 
@GetMapping(value = "es/search") 
<Result> search(@RequestParam String search);
```

### 6.4ShopElasticsearchServiceImpl

1 : 需要根据标题,分类名称,品牌名称进行查询

 2 : 需要设置高亮字段

```java
   @Override public <Result> search(String search) {
        NativeSearchQueryBuilder nativeSearchQueryBuilder = new NativeSearchQueryBuilder();
        if (StringUtils.isEmpty(search)) return this.setResultError("搜索内容不能为 空");

//多字段同时查询 

        nativeSearchQueryBuilder.withQuery(QueryBuilders.multiMatchQuery(search, "title", "brandName", "categoryName"));

//设置高亮字段 

        nativeSearchQueryBuilder.withHighlightBuilder(ESHighLightUtil.getHighlightBuild er("title"));
        SearchHits searchHits = elasticsearchRestTemplate.search(nativeSearchQueryBuilder.build(), GoodsDoc.class);

        List > highLightHit = ESHighLightUtil.getHighLightHit(searchHits.getSearchHits());
        List goodsDocs = highLightHit.stream().map(hit -> hit.getContent()).collect(Collectors.toList());
        return this.setResultSuccess(goodsDocs);
    }
```

### 6.4 mingrui-shop-basic-zuul-serer/application.yml

将search项目加入到zuul路由中

```yml
server:
  port: 8088

spring:
  application:
    name: eureka-zuul

zuul:
  # 声明路由
  routes:
    # 路由名称
    api-xxx:
      # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
      path: /api-xxx/**
      serviceId: xxx-server
    api-search:
     path: /api-search/**
     serviceId: es-server
  # 启用重试
  retryable: true
  # 包含此路径的不进行路由
  ignored-patterns: /upload/**
  # 忽略上传服务
  ignored-services:
    -upload-server

#配置负载
ribbon:
  ConnectTimeout: 250 # 连接超时时间(ms)
  ReadTimeout: 2000 # 通信超时时间(ms)
  OkToRetryOnAllOperations: true # 是否对所有操作重试
  MaxAutoRetriesNextServer: 2 # 同一服务不同实例的重试次数
  MaxAutoRetries: 1 # 同一实例的重试次数

hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000 # 熔断超时时长：6000ms

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

### 6.5 一点小小的问题

![image-20210311213732471](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213732471.png)

后台返回了好多没有用的数据,为了降低网络io的压力,所以我们处理一下

```java
//设置查询出来的内容,页面上做多只需要id,title,skus
queryBuilder.withSourceFilter(new FetchSourceFilter(new String[] {"id","title","skus"}, null));
```

![image-20210311213803156](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213803156.png)

```java
spring: jackson: default-property-inclusion: non_null #空值不返回
```

![image-20210311213818228](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213818228.png)

## 7 搜索分页

### 7.1 search.html

![image-20210311213834442](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213834442.png)

```vue


<div class="fr">
                <div class="sui-pagination pagination-large">
                    <ul>
                        <li class="prev disabled" @click="page--">
                            <a href="#" @click.prevent="zuzhishijian">«上一页</a>
                        </li>
                        <li :class="{active : value == page}"
                        @click="page = value"
                        v-for="(value,index) in totalPage"
                        v-if="value < 5"
                        :key="index">
                            <a href="#" @click.prevent="zuzhishijian">{{ value }}</a>
                        </li>
                        <li class="dotted" v-show="totalPage > 5"><span>...</span></li>
                        <li class="next" @click="page++">
                            <a href="#" @click.prevent="zuzhishijian">下一页»</a>
                        </li>
                    </ul>
                    <div><span>共{{ totalPage}}页&nbsp;</span><span>
      到第
      <input type="text" class="page-num">
      页 <button class="page-confirm" onclick="alert(1)">确定</button></span></div>
                </div>
            </div>

        </div>


```

![image-20210311214103824](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214103824.png)

![image-20210311214110155](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214110155.png)

![image-20210311214117495](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214117495.png)

```js
var vm = new Vue({

​    el: "#searchApp",

​    data: {

​      goodsList:[],

​      mrshop,

​      page:1,

​      total:0,

​      totalPage:0,

​      categoryList:[],

​      brandList:[],

​      specAggMap:{},

​      isMore:false,

​      filter:{}

​    },

   

​      watch: {

​      page () {

​        this.search();

​      }

​    



​    },

​    methods:{

​      deleteFilter(key){

​        delete this.filter[key]

​        this.search();

​      },

​      getValueFilter(key,value){

​        if(key == 'cid3'){

​          this.categoryList.forEach(category => {

​            if(category.id == value){

​            value = category.name;

​            }

​          })

​        }else if(key == 'brandId'){

​          this.brandList.forEach(brand => {

​            if(brand.id == value){

​              value = brand.name;

​            }

​          })

​        }

​        return value;



​        

​      },

​      addFilter(key,value){

​          this.filter[key]=value;

​          this.search();

​          

​      },

​      quxiaoshijian (){},

​      search(){

​        mrshop.http("/es/queryEs",{

​        params:{

​          value:mrshop.parse(location.search.substring(1)),

​          page:this.page,

​          filter:JSON.stringify(this.filter)

​        }

​      }).then(resp =>{

​        console.log(resp);

​       //处理sku

​      const dataList = resp.data.data.map(goods => {

​      goods.skus = JSON.parse(goods.skus);//将字符串转为json

​      goods.selected = goods.skus[0];//设置当前选中

​      return goods;

​      })

​      this.goodsList = dataList;

​      this.brandList=resp.data.brandEntityList;

​      this.categoryList=resp.data.categoryEntityList;

​     



​      this.total = resp.data.total;

​      this.totalPage = resp.data.totalPage;

​      this.specAggMap=resp.data.specAggMap;



​      //把json对象转为Object类型的对象; Object.assign();





​      }).catch(error =>console.log(error))



​      }





​    },

​    components:{

​      b2cTop: () => import("./js/pages/top.js")

​    },

​    created(){

​      this.search();

​      

​    }

  });
```

### 7.2 ShopElasticsearchService

```java
@ApiOperation(value = "搜索")
@GetMapping(value = "es/search") <Result> search(@RequestParam String search,@RequestParam Integer page);
```

### 7.3 ShopElasticsearchServiceImpl

```java
@Override public Result> search(String search, Integer page) {
NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder(); 
if (!StringUtils.isEmpty(search)) { 
    //多字段同时查询 
    queryBuilder.withQuery(QueryBuilders.multiMatchQuery(search,"title","brandName" ,"categoryName"));

} 
    queryBuilder.withPageable(PageRequest.of(page-1,10));
    //设置查询出来的内容,页面上做多只需要id,title,skus 
    queryBuilder.withSourceFilter(new FetchSourceFilter(new String[] {"id","title","skus"}, null));
    //设置高亮字段
    queryBuilder.withHighlightBuilder(ESHighLightUtil.getHighlightBuilder("title")) ; 
    SearchHits hits = elasticsearchRestTemplate.search(queryBuilder.build(), GoodsDoc.class);
    List> highLightHit = ESHighLightUtil.getHighLightHit(hits.getSearchHits()); 
    List goodsDocs = highLightHit.stream().map(searchHit -> 
                                               searchHit.getContent()).collect(Collectors.toList());
    // long total = hits.getTotalHits();
    //总条数 47 
    // Double totalD = Long.valueOf(total).doubleValue();
    //doule类型的总条数
    // double totalPageD = Math.ceil(totalD ;
    //如果有小数直接想上取整 
    // int totalPage = Double.valueOf(totalPageD).intValue();
    //将double类型的值 转为int类型
    Map map = new HashMap<>();
    map.put("total",Long.valueOf(hits.getTotalHits()).intValue()); map.put("totalPage",Double.valueOf(Math.ceil(Long.valueOf(hits.getTotalHits()). doubleValue()/ 10)).intValue());
    String message = JSONUtil.toJsonString(map);
    return this.setResult(HTTPStatus.OK,message,goodsDocs); }
```

当然,我知道这个页面代码有很多bug,我以流程为主,你们自己解决就可以了......







# 八.搜索过滤

## 1 学习目标 

- 了解过滤功能的基本思路 
- 独立实现分类和品牌展示 
- 了解规格参数展示 
- 实现过滤条件筛选 
- 实现已选过滤项回显 
- 实现取消选择过滤项

## 2 过滤功能分析

首先看下页面要实现的效果：

![image-20210311204951511](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311204951511.png)

整个过滤部分有3块： 

**顶部的导航，已经选择的过滤条件展示：** 

- ​	商品分类面包屑，根据用户选择的商品分类变化 
- ​	其它已选择过滤参数 

**过滤条件展示，又包含3部分** 

- ​	商品分类展示 
- ​	品牌展示 
- ​	其它规格参数 

**展开或收起的过滤条件的按钮** 

​	顶部导航要展示的内容跟用户选择的过滤条件有关。 

- ​	比如用户选择了某个商品分类，则面包屑中才会展示具体的分类 

- 比如用户选择了某个品牌，列表中才会有品牌信息。 

  所以，这部分需要依赖第二部分：过滤条件的展示和选择。因此我们先不着急去做。 

展开或收起的按钮是否显示，取决于过滤条件现在有多少，如果有很多，那么就没必要展示。所以也是 跟第二部分的过滤条件有关。 

这样分析来看，我们必须先做第二部分：过滤条件展示。

## 3.生成分类和品牌 筛选条件

先来看分类和品牌。在我们的数据库中已经有所有的分类和品牌信息。在这个位置，是不是把所有的分 类和品牌信息都展示出来呢？ 

显然不是，用户搜索的条件会对商品进行过滤，而在搜索结果中，不一定包含所有的分类和品牌，直接 展示出所有商品分类，让用户选择显然是不合适的。 无论是分类信息，还是品牌信息，都应该从e s搜索的结果商品中进行聚合得到。

### 聚合商品分类和品牌

我们修改搜索的业务逻辑，对分类和品牌聚合。 

因为索引库中只有id，所以我们根据id聚合，然后再根据id去查询完整数据。

### 后台：

### 实现

####  brandService和categoryService分别提供通过ids查询数据 的接口

##### BrandService

```java
@ApiOperation(value="通过品牌id集合获取品牌")
@GetMapping(value = "brand/getBrandByIds")
Result<List<BrandEntity>> getBrandByIds(@RequestParam String brandIds);
```

##### CategoryService

```java
@ApiOperation(value = "通过id集合查询分类信息")
@GetMapping(value = "category/getCateByIds")
Result<List<CategoryEntity>> getCateByIds(@RequestParam String cateIds);
```

##### BrandServiceImpl

```java
@Override
public Result<List<BrandEntity>> getBrandByIds(String brandIds) {
		List<Integer> brandIdsArr = Arrays.asList(brandIds.split(",")).stream().map(idStr ->
	Integer.parseInt(idStr)).collect(Collectors.toList());
		List<BrandEntity> list = brandMapper.selectByIdList(brandIdsArr);
		return this.setResultSuccess(list);
}
```

##### CategoryServiceImpl

```java
@Override
public Result<List<CategoryEntity>> getCateByIds(String cateIds) {
	List<Integer> cateIdsArr = Arrays.asList(cateIds.split(",")).stream().map(idStr ->
		Integer.parseInt(idStr)).collect(Collectors.toList());
	List<CategoryEntity> list = categoryMapper.selectByIdList(cateIdsArr);
	return this.setResultSuccess(list);
}

```

#### 提供扩展的response

原来我们查询的方法的返回值是Result,result里面封装了code,msg,和data 等信息 还需要total,totalPage(放在了meaage字段中) 现在还需要品牌和分类的信息,显然result已经支撑不住了 所以我们扩展一下result,顺便让大家继续学一下继承

#####  mingrui-shop-service-api-search/pom.xml

```xml
<!--需要api-xxx中的一些类-->
<dependency>
<groupId>com.baidu</groupId>
	<artifactId>mingrui-shop-service-api-xxx</artifactId>
	<version>1.0-SNAPSHOT</version>
</dependency>

```

##### api-search新建response包并新建GoodsResponse

```java
@Data
@NoArgsConstructor
public class GoodsResponse extends Result<List<GoodsDoc>> {
    private Integer total;
    private Integer totalPage;
    private List<BrandEntity> brandList;
    private List<CategoryEntity> categoryList;
    public GoodsResponse(Integer total, Integer totalPage, List<BrandEntity>
    brandList, List<CategoryEntity> categoryList, List<GoodsDoc> goodsDocs){
        super(HTTPStatus.OK,HTTPStatus.OK + "",goodsDocs);
        this.total = total;
        this.totalPage = totalPage;
        this.brandList = brandList;
        this.categoryList = categoryList;
    }
}
```

#### service-search项目新建BrandFeign和CategoryFeign

```java
@FeignClient(contextId = "BrandService", value = "xxx-service")
public interface BrandFeign extends BrandService {
}
```

```java
@FeignClient(contextId = "CategoryService", value = "xxx-service")
public interface CategoryFeign extends CategoryService {
}
```

#### ShopElasticsearchServiceImpl

```java
@Override
public GoodsResponse search(String search, Integer page) {
    NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
    if (!StringUtils.isEmpty(search)) {
        //多字段同时查询
        queryBuilder.withQuery(QueryBuilders.multiMatchQuery(search,"title","brandName"
        ,"categoryName"));
    }
    queryBuilder.withPageable(PageRequest.of(page-1,10));
    //设置查询出来的内容,页面上做多只需要id,title,skus
    queryBuilder.withSourceFilter(new FetchSourceFilter(new String[]{"id","title","skus"}, null));
    //设置高亮字段
    queryBuilder.withHighlightBuilder(ESHighLightUtil.getHighlightBuilder("title"));
    //聚合
    queryBuilder.addAggregation(AggregationBuilders.terms("cate_agg").field("cid3") );
    queryBuilder.addAggregation(AggregationBuilders.terms("brand_agg").field("brandId"));
    
    SearchHits<GoodsDoc> hits =elasticsearchRestTemplate.search(queryBuilder.build(), GoodsDoc.class);
    List<SearchHit<GoodsDoc>> highLightHit =ESHighLightUtil.getHighLightHit(hits.getSearchHits());
    
    List<GoodsDoc> goodsDocs = highLightHit.stream().map(searchHit ->
        searchHit.getContent()).collect(Collectors.toList());
        // long total = hits.getTotalHits();//总条数 47
        // Double totalD = Long.valueOf(total).doubleValue();//doule类型的总条数
        // double totalPageD = Math.ceil(totalD ;//如果有小数直接想上取整
        3.2.5 search.html
        // int totalPage = Double.valueOf(totalPageD).intValue();//将double类型的值
        转为int类型
        //获取聚合数据
        Aggregations aggregations = hits.getAggregations();
        Terms brand_agg = aggregations.get("brand_agg");
        Terms cate_agg = aggregations.get("cate_agg");
        
        List<? extends Terms.Bucket> brandBuckets = brand_agg.getBuckets();
        
        List<String> brandIdList = brandBuckets.stream().map(brandbuckt -> {
            Number keyAsNumber = brandbuckt.getKeyAsNumber();
            Integer brandId = Integer.valueOf(keyAsNumber.intValue());
            return brandId + "";//得到品牌id,并且且转为String类型,方便接下来的操作
        }).collect(Collectors.toList());
        
        List<? extends Terms.Bucket> cateBuckets = cate_agg.getBuckets();

        List<String> cateIdList = cateBuckets.stream().map(cateBucket -> {
            Number keyAsNumber = cateBucket.getKeyAsNumber();
            Integer cateId = Integer.valueOf(keyAsNumber.intValue());
            return cateId + "";
    	}).collect(Collectors.toList());
    	
    //通过brandid获取brand详细数据
    //String.join(分隔符,List<String>),将list集合转为,分隔的字符串
    Result<List<BrandEntity>> brandResult =brandFeign.getBrandByIds(String.join(",",brandIdList));
    
    //通过分类id获取分类详细数据
    Result<List<CategoryEntity>> cateResult =categoryFeign.getCateByIds(String.join(",",cateIdList));
    /*Map<String, Integer> map = new HashMap<>();
    map.put("total",Long.valueOf(hits.getTotalHits()).intValue());
    map.put("totalPage",Double.valueOf(Math.ceil(Long.valueOf(hits.getTotalHits()).
    doubleValue()/ 10)).intValue());
    String message = JSONUtil.toJsonString(map);*/
    
    GoodsResponse goodsResponse = new
    GoodsResponse(Long.valueOf(hits.getTotalHits()).intValue(),
    Double.valueOf(Math.ceil(Long.valueOf(hits.getTotalHits()).doubleValue() /10)).intValue(), brandResult.getData(), cateResult.getData(), goodsDocs);
    return goodsResponse;
}
```

### 前台：

search.html line：378,379

![image-20210311210743564](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311210743564.png)

line：450，451,454,455

![image-20210311210846523](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311210846523.png)

line：124，135,139

![image-20210311211006540](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311211006540.png)	line：57,60

![image-20210311211149248](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311211149248.png)

### 问题

#### 后台：ShopElasticsearchService

```java
@ApiOperation(value = "搜索")
@GetMapping(value = "es/search")
Result<List<GoodsDoc>> search(@RequestParam String search, @RequestParam
                              Integer page);

@ApiOperation(value = "品牌过滤")
@GetMapping(value = "es/searchBrand")
Result<List<BrandEntity>> getBrandInfo(String search);

@ApiOperation(value = "分类过滤")
@GetMapping(value = "es/searchCategory")
Result<List<CategoryEntity>> getCategoryInfo(String search);
```

#### ShopElasticsearchServiceImpl

```java
@Override
public Result<List<GoodsDoc>> search(String search, Integer page) {
    NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
        if (!StringUtils.isEmpty(search)) {
            //多字段同时查询
            queryBuilder.withQuery(QueryBuilders.multiMatchQuery(search,"title","brandName"
            ,"categoryName"));
        }
        
    	queryBuilder.withPageable(PageRequest.of(page-1,10));
        //设置查询出来的内容,页面上做多只需要id,title,skus
        queryBuilder.withSourceFilter(new FetchSourceFilter(new String[]{"id","title","skus"}, null));
        //设置高亮字段
        queryBuilder.withHighlightBuilder(ESHighLightUtil.getHighlightBuilder("title"));
        
        SearchHits<GoodsDoc> hits =elasticsearchRestTemplate.search(queryBuilder.build(), GoodsDoc.class);
        
        List<SearchHit<GoodsDoc>> highLightHit =ESHighLightUtil.getHighLightHit(hits.getSearchHits());
        
        List<GoodsDoc> goodsDocs = highLightHit.stream().map(searchHit ->
                searchHit.getContent()).collect(Collectors.toList());
                Map<String, Integer> map = new HashMap<>();
                map.put("total",Long.valueOf(hits.getTotalHits()).intValue());
                map.put("totalPage",Double.valueOf(Math.ceil(Long.valueOf(hits.getTotalHits())
            doubleValue()/10)).intValue());
            
            String message = JSONUtil.toJsonString(map);
            
        return this.setResult(HTTPStatus.OK,message,goodsDocs);
     }
    
    @Override
    public Result<List<BrandEntity>> getBrandInfo(String search){
        NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
        
        if (!StringUtils.isEmpty(search)) {
            //多字段同时查询
            queryBuilder.withQuery(QueryBuilders.multiMatchQuery(search,"title","brandName"
            ,"categoryName"));
        }
   	 	queryBuilder.addAggregation(AggregationBuilders.terms("brand_agg").field("brandId"));
   	 
   	 	SearchHits<GoodsDoc> hits =elasticsearchRestTemplate.search(queryBuilder.build(), GoodsDoc.class);

        Aggregations aggregations = hits.getAggregations();
        Terms brand_agg = aggregations.get("brand_agg");

        List<? extends Terms.Bucket> brandBuckets = brand_agg.getBuckets();
        List<String> brandIdList = brandBuckets.stream().map(brandbuckt -> {
            Number keyAsNumber = brandbuckt.getKeyAsNumber();
            Integer brandId = Integer.valueOf(keyAsNumber.intValue());
            return brandId + "";//得到品牌id,并且且转为String类型,方便接下来的操作
        }).collect(Collectors.toList());
        
    	Result<List<BrandEntity>> brandResult =brandFeign.getBrandByIds(String.join(",",brandIdList));
    	return this.setResultSuccess(brandResult.getData());
    }
    
    @Override
    public Result<List<CategoryEntity>> getCategoryInfo(String search){
    	NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
    	
        if (!StringUtils.isEmpty(search)) {
            //多字段同时查询
            queryBuilder.withQuery(QueryBuilders.multiMatchQuery(search,"title","brandName"
            ,"categoryName"));
        }
    	queryBuilder.addAggregation(AggregationBuilders.terms("cate_agg").field("cid3"));
    	
   	 	SearchHits<GoodsDoc> hits =elasticsearchRestTemplate.search(queryBuilder.build(), GoodsDoc.class);
   	 	
    	Aggregations aggregations = hits.getAggregations();
    	Terms cate_agg = aggregations.get("cate_agg");
    	
    	List<? extends Terms.Bucket> cateBuckets = cate_agg.getBuckets();
        List<String> cateIdList = cateBuckets.stream().map(cateBucket -> {
            Number keyAsNumber = cateBucket.getKeyAsNumber();
            Integer cateId = Integer.valueOf(keyAsNumber.intValue());
            return cateId + "";
        }).collect(Collectors.toList());
        
        Result<List<CategoryEntity>> cateResult =categoryFeign.getCateByIds(String.join(",",cateIdList));
        return this.setResultSuccess(cateResult.getData());
}

```

#### 前台：

search.html line：427

```js
searchEsData() {
    const search = mrshop.parse(location.search.substring(1));//将key=value转为key:value
    
    //查询请求
     mrshop.http.get('es/search', {
            params: {
            search: search.key,//将查询的内容传递到后台
            page: this.page//当前页
        }
    }).then(resp => {
    
        //处理sku
        const goodsList = resp.data.data.map(goods => {
            goods.skus = JSON.parse(goods.skus);//将字符串转为json
            goods.selected = goods.skus[0];//设置当前选中
            return goods;

        })
        
        // this.brandList = resp.data.brandList;
        // this.categoryList = resp.data.categoryList;
        var totalObj = JSON.parse(resp.data.message);
        this.total = totalObj.obj;//总条数
        this.totalPage = totalObj.totalPage//总页数
        this.goodsList = goodsList;
        
   	 }).catch(error => console.log(error));
   	 
    //查询品牌信息
    mrshop.http.get('es/searchBrand', {
        params: {
        search: search.key
        }
    }).then(resp => {
        this.brandList = resp.data.data;        
    }).catch(error => console.log(error));
    
    //查询分类信息
    mrshop.http.get('es/searchCategory', {
        params: {
        search: search.key
        }
    }).then(resp => {
        this.categoryList = resp.data.data;
    }).catch(error => console.log(error))
}

```

### 3.拆方法

search这个方法代码太多了...... 拆方法还是遵循一个原则-从后往前拆

```java
@Override
public GoodsResponse search(String search, Integer page) {
    NativeSearchQueryBuilder queryBuilder = this.getQueryBuilder(search,page);
    
    SearchHits<GoodsDoc> hits =elasticsearchRestTemplate.search(queryBuilder.build(), GoodsDoc.class);
    
    List<SearchHit<GoodsDoc>> highLightHit =ESHighLightUtil.getHighLightHit(hits.getSearchHits());
    List<GoodsDoc> goodsDocs = highLightHit.stream().map(searchHit ->
    searchHit.getContent()).collect(Collectors.toList());
    
    //通过品牌id获取品牌详细数据
    List<BrandEntity> brandResult =getBrandEntityList(hits.getAggregations());
    //通过分类id获取分类详细数据
    List<CategoryEntity> cateResult =getCategoryEntityList(hits.getAggregations());
    
    GoodsResponse goodsResponse = newGoodsResponse(Long.valueOf(hits.getTotalHits()).intValue(),
    Double.valueOf(Math.ceil(Long.valueOf(hits.getTotalHits()).doubleValue() /10)).intValue()
    , brandResult, cateResult, goodsDocs);
    
    return goodsResponse;
}
private NativeSearchQueryBuilder getQueryBuilder(String search, Integerpage){
	NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
	
    if (!StringUtils.isEmpty(search)) {
        //多字段同时查询
        queryBuilder.withQuery(QueryBuilders.multiMatchQuery(search,"title","brandName"
        ,"categoryName"));
    }
    
	queryBuilder.withPageable(PageRequest.of(page-1,10));
	//设置查询出来的内容,页面上做多只需要id,title,skus
    queryBuilder.withSourceFilter(new FetchSourceFilter(new String[]{"id","title","skus"}, null));
    //设置高亮字段
    queryBuilder.withHighlightBuilder(ESHighLightUtil.getHighlightBuilder("title"));
    //聚合
    queryBuilder.addAggregation(AggregationBuilders.terms("cate_agg").field("cid3") );
    queryBuilder.addAggregation(AggregationBuilders.terms("brand_agg").field("brandId"));
    
	return queryBuilder;
}
private List<BrandEntity> getBrandEntityList(Aggregations aggregations){
    Terms brand_agg = aggregations.get("brand_agg");
    List<? extends Terms.Bucket> brandBuckets = brand_agg.getBuckets();

    List<String> brandIdList = brandBuckets.stream().map(brandbuckt -> {
        Number keyAsNumber = brandbuckt.getKeyAsNumber();
        Integer brandId = Integer.valueOf(keyAsNumber.intValue());
        return brandId + "";//得到品牌id,并且且转为String类型,方便接下来的操作
    }).collect(Collectors.toList());
    
    Result<List<BrandEntity>> brandResult =brandFeign.getBrandByIds(String.join(",",brandIdList));
    
    return brandResult.getData();
}
private List<CategoryEntity> getCategoryEntityList(Aggregationsaggregations){
        Terms cate_agg = aggregations.get("cate_agg");
        List<? extends Terms.Bucket> cateBuckets = cate_agg.getBuckets();
        List<String> cateIdList = cateBuckets.stream().map(cateBucket -> {
            Number keyAsNumber = cateBucket.getKeyAsNumber();
            Integer cateId = Integer.valueOf(keyAsNumber.intValue());
            return cateId + "";
    	}).collect(Collectors.toList());
    Result<List<CategoryEntity>> cateResult =categoryFeign.getCateByIds(String.join(",",cateIdList));
    return cateResult.getData();
}

```

## 4 生成规格 筛选条件

```ABAP
GET /goods/_search
{
        "query": {
            "multi_match": {
                "query": "华为",
                "fields": ["title","brandName","categoryName"]
            }
        },
        "aggs": {
            "屏幕尺寸": {
                "terms": {
                    "field": "specs.主屏幕尺寸（英寸）.keyword",
                    "size": 10
            	}
        	},
            "内存":{
                "terms": {
                    "field": "specs.内存.keyword",
                    "size": 10
                }
            }
	}
}
```

```
问题 : 我们不可能将所有的规格参数全部取出来,规格参数是挂在某一个分类下的, 所以我们应该根据具体的分类id查询相应的规格参数 那我们怎么确定获取哪个分类下的id? 其实这个取决于公司,就比如说,我们可以查询热度最高的分类下的规格参数. 也可以查询分类下商品最多的分类下的规格参数 但是在学习阶段,热度最高我们现在没有办法实现 可以得到分类下商品最多的分类
```

###  后台：修改获取分类信息的方法获取热度最高的分类

![image-20210311213458102](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213458102.png)

热度最高的id为key 值为所有分类的数据

```java
private Map<Integer, List<CategoryEntity>>getCategoryEntityList(Aggregations aggregations){
    Map<Integer, List<CategoryEntity>> map = new HashMap<>();
    
    Terms cate_agg = aggregations.get("cate_agg");、
    
    List<? extends Terms.Bucket> cateBuckets = cate_agg.getBuckets();
    List<Integer> hotCidList = Arrays.asList(0); //热度最高的分类id
    List<Integer> maxCountList = Arrays.asList(0);
    List<String> cateIdList = cateBuckets.stream().map(cateBucket -> {
        Number keyAsNumber = cateBucket.getKeyAsNumber();
        Integer cateId = Integer.valueOf(keyAsNumber.intValue());
        if(maxCountList.get(0) < cateBucket.getDocCount()){
            maxCountList.set(0,Long.valueOf(cateBucket.getDocCount()).intValue());
            hotCidList.set(0,keyAsNumber.intValue());
        }
        return cateId + "";
    }).collect(Collectors.toList());
    
    Result<List<CategoryEntity>> cateResult = categoryFeign.getCateByIds(String.join(",",cateIdList));
    
    map.put(hotCidList.get(0),cateResult.getData());//key为热度最高的cid value为cid集合对应的数据
    return map;
}
```

###  response中新增规格参数属性

![image-20210311213703588](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213703588.png)

```java
import com.baidu.shop.base.Result;
import com.baidu.shop.document.GoodsDoc;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.status.HTTPStatus;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.util.List;
import java.util.Map;
/**
* @ClassName GoodsDTO
* @Description: TODO
* @Author shenyaqi
* @Date 2020/9/8
* @Version V1.0
**/
@Data
@NoArgsConstructor
public class GoodsResponse extends Result<List<GoodsDoc>> {
    private Integer total;

    private Integer totalPage;
    private List<BrandEntity> brandList;
    private List<CategoryEntity> categoryList;
    private Map<String, Object> specAggInfo;
    
    public GoodsResponse(Integer total, Integer totalPage, List<BrandEntity> brandList, List<CategoryEntity> categoryList, List<GoodsDoc> goodsDocs, Map<String, Object> specAggInfo){
        super(HTTPStatus.OK,HTTPStatus.OK + "",goodsDocs);
        this.total = total;
        this.totalPage = totalPage;
        this.brandList = brandList;
        this.categoryList = categoryList;
        this.specAggInfo = specAggInfo;
    }
}
@Override
public GoodsResponse search(String search, Integer page) {

    NativeSearchQueryBuilder queryBuilder = this.getQueryBuilder(search,page);
    
    SearchHits<GoodsDoc> hits =elasticsearchRestTemplate.search(queryBuilder.build(), GoodsDoc.class);
    
    List<SearchHit<GoodsDoc>> highLightHit =ESHighLightUtil.getHighLightHit(hits.getSearchHits());
    List<GoodsDoc> goodsDocs = highLightHit.stream().map(searchHit ->
    	searchHit.getContent()).collect(Collectors.toList());
    //通过品牌id获取品牌详细数据
    List<BrandEntity> brandResult =getBrandEntityList(hits.getAggregations());
    
    //通过分类id获取分类详细数据
    Map<Integer, List<CategoryEntity>> cateMap =this.getCategoryEntityList(hits.getAggregations());
    List<CategoryEntity> cateResult = null;
    Integer hotCid = null;
    
    //注意此处不能使用lambda表达式....
    for(Map.Entry<Integer,List<CategoryEntity>> entry : cateMap.entrySet()){
        hotCid = entry.getKey();
        cateResult = entry.getValue();
    }
    
    //通过cid获取规格参数
    Map<String, Object> specAggInfo = this.getSpecAggInfo(hotCid, search);
    GoodsResponse goodsResponse = newGoodsResponse(Long.valueOf(hits.getTotalHits()).intValue(),
    	Double.valueOf(Math.ceil(Long.valueOf(hits.getTotalHits()).doubleValue() /10)).intValue()
    	, brandResult, cateResult, goodsDocs,specAggInfo);
    return goodsResponse;
}

```

### 抽取出来的获取规格参数方法

![image-20210311214014370](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214014370.png)

```java
private Map<String, Object> getSpecAggInfo(Integer cid,String search){
    SpecParamDTO specParamDTO = new SpecParamDTO();
    specParamDTO.setCid(cid);
    specParamDTO.setSearching(1);//只查询用于搜索的
    
    Result<List<SpecParamEntity>> specParamInfo =specificationFeign.getSpecParamInfo(specParamDTO);
    List<SpecParamEntity> paramList = specParamInfo.getData();
    
    NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
    
    queryBuilder.withQuery(QueryBuilders.multiMatchQuery(search,"title","brandName","categoryName"));
    paramList.stream().forEach(params -> {
        queryBuilder.addAggregation(AggregationBuilders.terms(params.getName()).field("
        specs." + params.getName() + ".keyword"));
    });
    queryBuilder.withPageable(PageRequest.of(0,1));
    
    SearchHits<GoodsDoc> hits =elasticsearchRestTemplate.search(queryBuilder.build(), GoodsDoc.class);
    
    Aggregations aggregations = hits.getAggregations();
    
    Map<String, Object> map = new HashMap<>();
    
    paramList.stream().forEach(param -> {
        Terms terms = aggregations.get(param.getName());
        List<? extends Terms.Bucket> buckets = terms.getBuckets();
        List<String> value = buckets.stream().map(bucket ->
        bucket.getKeyAsString()).collect(Collectors.toList());
        map.put(terms.getName(),value);
    });
    return map;
}
```

### 前台：search.html

line：457

![image-20210311214310206](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214310206.png)

```html
<!--遍历规格参数数据-->
<div class="type-wrap" v-for="(val,key,index) inspecAggInfo">
    <div class="fl key">{{ key }}</div>
    <div class="fl value">
        <ul class="type-list">
            <!--遍历参数值-->
            <li v-for="(item,index) in val">
            	<a>{{ item }}</a>
            </li>
        </ul>
    </div>
    <div class="fl ext"></div>
</div>
```

### 更多 收起 功能实现

line：371

![image-20210311214455923](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214455923.png)

line：162

![image-20210311214540832](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214540832.png)

line：165

![image-20210311214552486](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214552486.png)

line：149

![image-20210311214734269](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214734269.png)

### 优化代码

上述代码中我们定义了一系列显示条件过滤的属性

line：371

![image-20210311214835828](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214835828.png)

还有一些赋值操作

line：452

![image-20210311214931636](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214931636.png)

这些其实都是过滤条件数据 所以我们将这些数据合并成一个对象

line：371

![image-20210311214951667](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214951667.png)

line：452

![image-20210311215011849](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311215011849.png)

那现在模板就必须得改了

line：119

![image-20210311215039357](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311215039357.png)

line：132

![image-20210311215044612](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311215044612.png)

line：149

![image-20210311215138508](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311215138508.png)

## 5 搜索过滤

### 前台：search.html

line：371

![image-20210311215235840](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311215235840.png)

line：412

![image-20210311215332400](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311215332400.png)

line：119

![image-20210311215408572](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311215408572.png)
line：132

![image-20210311215417126](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311215417126.png)

line：149

![image-20210311215423699](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311215423699.png)

### 后台

#### ShopElasticsearchService

```java
@ApiOperation(value = "搜索")
@GetMapping(value = "es/search")
GoodsResponse search(@RequestParam String search, @RequestParam Integer page , @RequestParam String filter);
```

#### ShopElasticsearchServiceImpl

![image-20210311215611915](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311215611915.png)

```java
private NativeSearchQueryBuilder getQueryBuilder(String search, Integerpage,String filter){
NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
    if (!StringUtils.isEmpty(search)) {
        //多字段同时查询
        queryBuilder.withQuery(QueryBuilders.multiMatchQuery(search,"title","brandName"
        ,"categoryName"));
    }
    if(!StringUtils.isEmpty(filter) && filter.length() > 2){
            BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();
            
            Map<String, String> filterMap = JSONUtil.toMapValueString(filter);
            
            for(Map.Entry<String,String> item : filterMap.entrySet()){
                MatchQueryBuilder matchQueryBuilder = null;
                //分类 品牌和 规格参数的查询方式不一样
                if(item.getKey().equals("cid3") ||
                item.getKey().equals("brandId")){
                matchQueryBuilder = QueryBuilders.matchQuery(item.getKey(),
                item.getValue());
            }else{
                matchQueryBuilder = QueryBuilders.matchQuery("specs." +
                item.getKey() + ".keyword",item.getValue());
            }
            boolQueryBuilder.must(matchQueryBuilder);
        }
        //添加过滤,过滤不会影响评分
        queryBuilder.withFilter(boolQueryBuilder);
    }
	queryBuilder.withPageable(PageRequest.of(page-1,10));
	//设置查询出来的内容,页面上做多只需要id,title,skus
	queryBuilder.withSourceFilter(new FetchSourceFilter(new String[]{"id","title","skus"}, null));
    //设置高亮字段
    queryBuilder.withHighlightBuilder(ESHighLightUtil.getHighlightBuilder("title"))	;
    //聚合
    queryBuilder.addAggregation(AggregationBuilders.terms("cate_agg").field("cid3"));

	queryBuilder.addAggregation(AggregationBuilders.terms("brand_agg").field("brandId"));
	return queryBuilder;
}

```

## 6面包屑

###  面包屑展示

line：109

![image-20210311220003670](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311220003670.png)

line:396

![image-20210311220041038](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311220041038.png)

### 点击×号取消过滤

```vue
<ul class="tags-choose">
    <li class="tag" v-for="(value,key,index) in filter">
        {{ key=='brandId'?'品牌' : key == 'cid3' ? '分类' :key }}:
        <span style="color: red">{{ getFilterValue(key,value) }}</span>
        <i @click="removeFilterItem(key)" class="sui-iconicon-tb-close"></i>
    </li>
</ul>
removeFilterItem(key){
    delete this.filter[key];
    this.searchEsData();
}
```



# 九.模板项目搭建

## 9.1 在mingrui-shop-service项目下新建mingrui-shop-service-template

## 9.2 pom.xml

```xml
<dependencies>
    <!--模板引擎-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-thymeleaf</artifactId>
    </dependency>
</dependencies>
```

## 9.3 application.yml

```yml
server:
  port: 8400
spring:
  application:
    name: template-server
  thymeleaf:
  # 配置前缀-->模板文件存储路径
  prefix: classpath:/templates/
  # 是否检查本地模板
  check-template-location: true
  # 配置模板文件后缀
  suffix: .html
  # 编码格式
  encoding: UTF-8
  servlet:
    # 模板类型
    content-type: text/html
  #模板模式
  mode: HTML5
  # 是否启用缓存
  cache: false

# eureka配置
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

## 9.4 启动类

```java
package com.baidu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.openfeign.EnableFeignClients;

@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})
@EnableFeignClients
@EnableEurekaClient
public class RunTemplateServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunTemplateServerApplication.class);
    }
}
```

## 9.5 在resource目录下新建templates文件夹

## 9.6 新建123.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
明瑞教育，世界第一
</body>
</html>
```

## 9.7 新建PageController

```java
import com.baidu.shop.service.PageService;
import com.netflix.discovery.converters.Auto;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;

import javax.servlet.http.HttpServletResponse;
import java.util.Map;

@Controller
public class PageController {

    @GetMapping(value = "123.html") 
    public String test(){ 
    return "123"; 
    }

}
```

## 9.8 浏览器输ip:port/123.html能正常访问到页面即可

![image-20210311205911561](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311205911561.png)

![image-20210311205931432](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311205931432.png)

![image-20210311205947798](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311205947798.png)

![image-20210311205959580](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311205959580.png)



![image-20210311210251008](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311210251008.png)

![image-20210311210304884](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311210304884.png)

```c
#如果请求路径带item我们就让nginx帮我们把请求转发到8400端口
location /item {
	proxy_pass http://127.0.0.1:8400;
	proxy_connect_timeout 600;
	proxy_read_timeout 600;
}

```

让图片的地址带上item

```html
<!--大图片 设置成当前选中的图片-->
<a :href="'/item/' +goods.id + '.html'" target="_blank"><img:src="goods.selected.image" height="200" /></a>
```

![image-20210311210442158](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311210442158.png)

## 10.1 PageController

```java
package com.baidu.shop.controller;

import com.baidu.shop.service.PageService;
import com.netflix.discovery.converters.Auto;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;

import javax.servlet.http.HttpServletResponse;
import java.util.Map;

@Controller
@RequestMapping(value = "item")
public class PageController {

    @GetMapping(value = "{spuId}.html")
    public String test(@PathVariable(value = "spuId") Integer spuId){
        return "item";
    }

}
```

## 10.2 复制item.html到templates下

重启项目

![image-20210311210721633](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311210721633.png)

## 10.3 后台数据准备

```java
@Override
    public Map<String, Object> getGoodsInfo(Integer spuId) {

        Map<String, Object> goodsInfoMap = new HashMap<>();

        //spu
        SpuDTO spuDTO = new SpuDTO();
        spuDTO.setId(spuId);
        Result<List<SpuDTO>> spuResult = goodsFeign.getSpuInfo(spuDTO);
        SpuDTO spuResultData = null;
        if(spuResult.isSuccess()){
            spuResultData = spuResult.getData().get(0);
            goodsInfoMap.put("spuInfo",spuResultData);
        }
        //spuDetail
        Result<SpuDetailEntity> spuDetailResult = goodsFeign.getSpuDetailBySpuId(spuId);
        if(spuDetailResult.isSuccess()){
            goodsInfoMap.put("spuDetail",spuDetailResult.getData());
        }
        //分类信息
        Result<List<CategoryEntity>> categoryResult = categoryFeign.getCategoryByIdList(
                String.join(
                        ","
                        , Arrays.asList(spuResultData.getCid1() + "", spuResultData.getCid2() + ""
                                , spuResultData.getCid3() + "")
                )
        );
        if(categoryResult.isSuccess()){
            goodsInfoMap.put("categoryInfo",categoryResult.getData());
        }
        //品牌信息
        BrandDTO brandDTO = new BrandDTO();
        brandDTO.setId(spuResultData.getBrandId());
        Result<PageInfo<BrandEntity>> brandResult = brandFeign.getBrandInfo(brandDTO);
        if(brandResult.isSuccess()){
            goodsInfoMap.put("brandInfo",brandResult.getData().getList().get(0));
        }
        //sku
        Result<List<SkuDTO>> skusResult = goodsFeign.getSkusBySpuId(spuId);
        if(skusResult.isSuccess()){
            goodsInfoMap.put("skus",skusResult.getData());
        }
        //规格组,规格参数(通用)
        SpecGroupDTO specGroupDTO = new SpecGroupDTO();
        specGroupDTO.setCid(spuResultData.getCid3());
        Result<List<SpecGroupEntity>> specGroupResult = specificationFeign.getSepcGroupInfo(specGroupDTO);
        if(specGroupResult.isSuccess()){

            List<SpecGroupEntity> specGroupList = specGroupResult.getData();
            List<SpecGroupDTO> specGroupAndParam = specGroupList.stream().map(specGroup -> {
                SpecGroupDTO specGroupDTO1 = BaiduBeanUtil.copyProperties(specGroup, SpecGroupDTO.class);

                SpecParamDTO specParamDTO = new SpecParamDTO();
                specParamDTO.setGroupId(specGroupDTO1.getId());
                specParamDTO.setGeneric(true);
                Result<List<SpecParamEntity>> specParamResult = specParamServiceFeign.getSpecParamInfo(specParamDTO);
                if (specParamResult.isSuccess()) {
                    specGroupDTO1.setSpecList(specParamResult.getData());
                }
                return specGroupDTO1;
            }).collect(Collectors.toList());
            goodsInfoMap.put("specGroupAndParam",specGroupAndParam);
        }
        //特殊规格
        SpecParamDTO specParamDTO = new SpecParamDTO();
        specParamDTO.setCid(spuResultData.getCid3());
        specParamDTO.setGeneric(false);
        Result<List<SpecParamEntity>> specParamResult = specParamServiceFeign.getSpecParamInfo(specParamDTO);
        if(specParamResult.isSuccess()){
            List<SpecParamEntity> specParamEntityList = specParamResult.getData();
            Map<Integer, String> specParamMap = new HashMap<>();
            specParamEntityList.stream().forEach(specParam -> specParamMap.put(specParam.getId(),specParam.getName()));
            goodsInfoMap.put("specParamMap",specParamMap);
        }

        return goodsInfoMap;
    }
```

## 10.4 展示分类/品牌/标题

![image-20210311211516336](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311211516336.png)

```html
<!--分类信息展示-->
<li th:each="cate : ${ cateList }">
	<a href="#" th:text="${ cate.name }"></a>
</li>
<!--品牌信息展示-->
<li>
	<a href="#" th:text="${ brandInfo.name }"></a>
</li>
<!--标题展示-->
<li class="active" th:text="${ spuInfo.title }"></li>
```

## 10.5 展示子标题

![image-20210311211624218](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311211624218.png)

```html
<!--子标题展示-->
<div class="news"><span th:utext="${ spuInfo.subTitle }">
</span></div>
```

## 10.6 sku信息展示

```js
const specParamMap = /*[[ ${specParamMap} ]]*/[];//得到 1:屏幕尺寸
const specialSpec = JSON.parse(/*[[ ${ spuDetailInfo.specialSpec } ]]*/); //得到
1:5.7
const skus = /*[[ ${ skuList } ]]*/[];

```

```js
<script th:inline="javascript">
	const specParamMap = /*[[ ${specParamMap} ]]*/[];
	const specialSpec = JSON.parse(/*[[ ${ spuDetailInfo.specialSpec } ]]*/);
	const skus = /*[[ ${ skuList } ]]*/[];
</script>
<script>
	var itemVm = new Vue({
		el:"#itemApp",
        data:{
            mrshop,
            specParamMap,
            specialSpec,
            skus,
            indexs
        },
		components:{
			b2cTop: () => import('/js/pages/top.js')
		}
	});
</script>
```

html代码

```html
<!--特有规格展示-->
<dl v-for="(value,key) in specialSpec">
    <dt>
        <div class="fl title">
        	<!--通过id得到特有规格的名称-->
        	<i>选择{{specParamMap[key]}}</i>
        </div>
    </dt>
    <dd v-for="(o,index) in value" >
    	<a href="javascript:;" class="selected">
    		{{ o }}<span title="点击取消选择">&nbsp;
    		</span>
    	</a>
    </dd>
</dl>
```

![image-20210311211942398](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311211942398.png)

解决特有规格全部被选中的问题

![image-20210311212007241](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311212007241.png)

```js
const indexs = {};
//得到所有特有属性的id所有的key对应的值设置为0
Object.keys(specialSpec).forEach(k => {
	indexs[k] = 0;
})

```

```vue
<!--点击某一项规格的时候讲将当前下标设置为被选中的下标--
>
<dd v-for="(o,index) in value" @click="indexs[key] = index">
<!--如果当前下标==设置的下标那么此项规格被选中剩下的则不选中-->
<a href="javascript:;" :class="{selected: index == indexs[key]}">
{{ o }}<span title="点击取消选择">&nbsp;
		</span>
	</a>
</dd>

```

显示当前选中规格的图片 价格 和标题

```js
computed:{
    //计算属性得到当前被选中的sku信息
    sku(){
        //获取到indexs中所有的值并且用_拼接起来
        const index = Object.values(indexs).join("_");
        //数组.find方法-->通过条件查找数组中的元素
        return this.skus.find(sku => sku.indexes == index);
    },
    //处理图片
    images(){
    	return this.sku.images ? this.sku.images.split(",") : [];
    }
}

```

```html
<!--sku标题-->
<div class="sku-name">
	<h4>{{ sku.title }}</h4>
</div>
```

```html
<!--sku价格-->
<div class="fl price">
	<i>¥</i><em>{{ mrshop.formatPrice(sku.price) }}</em><span>降价通知</span>
</div>
```

![image-20210311212310735](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311212310735.png)

```html
<div class="fl preview-wrap">
	<!--放大镜效果-->
	<div class="zoom">
		<!--默认第一个预览-->
		<div id="preview" class="spec-preview">
			<span class="jqzoom">
				<img :jqimg="images[0]" :src="images[0]" width="400px" height="400px"/>
			</span>
		</div>
		<!--下方的缩略图-->
		<div class="spec-scroll">
			<a class="prev">&lt;</a>
			<!--左右按钮-->
			<div class="items">
				<ul>
					<li v-for="(image, index) in images">
						<img :src="image" :bimg="image" onmousemove="preview(this)" />
					</li>
				</ul>
			</div>
			<a class="next">&gt;</a>
		</div>
	</div>
</div>

```

## 10.7 商品介绍

```html
<!--商品详情-->
<div class="intro-detail" th:utext="${spuDetailInfo.description }"></div>
```

## 10.8 规格与包装

### 10.8.1 规格

![image-20210311212757565](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311212757565.png)

![image-20210311212815590](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311212815590.png)

```js
const spuDetailInfo = /*[[ ${spuDetailInfo} ]]*/{}; //detail一并拿过来,后面有可
能会用
const genericSpec = JSON.parse(/*[[ ${ spuDetailInfo.genericSpec } ]]*/);//
通过规格参数
const specGroupAndParam = /*[[ ${specGroupAndParam} ]]*/[];//规格组合规格参数数
据

```

```vue
<!--
    规格组 规格参数展示
    v-if="group.specParams.length > 0" 如果当前规格组下没有规格参数则不展示
-->
<div class="Ptable-item"
	v-for="(group,index) in specGroupAndParam"
	:key="index">
	<h3>{{ group.name }}</h3>
	<dl v-for="(param,index) in group.specParams" :key="index">
		<dt >{{ param.name }}</dt>
		<dd>{{ genericSpec[param.id] || '无' }}</dd>
	</dl>
</div>
```

### 10.8.2 包装

```vue
<div class="package-list">
	<h3>包装清单</h3>
	<p th:text="${ spuDetailInfo.packingList }"></p>
</div>

```

## 10.9 售后保障

![image-20210311213033220](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213033220.png)

<div id="three" class="tab-pane">
	<p th:text="${ spuDetailInfo.afterService }"></p>
</div>


## 10.10 商品标题/价格/图片展示

![image-20210311213121001](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213121001.png)

![image-20210311213134612](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213134612.png)

```javascript
computed:{
    sku () {
        /*
        将:
        {
            颜色 : 0,
            内存 : 1,
            机身存储 : 0
        }
        这样数据转换成0_1_0
        Object.values获取json对象的所有value值得到数据
        */
        const indexStr = Object.values(this.indexes).join('_');
        //数组的find函数: 通过条件查找数组内某一个函数
        //我们需要查询sku.indexes == indexStr的元素
        return this.skusInfo.find(sku => sku.indexes == indexStr);
    },
    images () {
        //先判断一下当前选中sku的images是否有内容
        //然后再通过,分割字符串.因为有可能一个sku有多个图片
        return this.sku.images ? this.sku.images.split(',') : [];
    }
},
```

## 11.1 实现页面静态化

### 11.1.1 mingrui-shop-service-api 

### 11.1.1.1 新建项目mingrui-shop-service-api-template 

### 11.1.1.2 新建包com.baidu.shop 

### 11.1.1.3 包下新建service和config包 

### 11.1.1.4 service包下新建TemplateService

```java
@GetMapping(value = "template/createStaticHTMLTemplate")
Result<JSONObject> createStaticHTMLTemplate(Integer spuId);

@GetMapping(value = "template/initStaticHTMLTemplate")
Result<JSONObject> initStaticHTMLTemplate();

@GetMapping(value = "template/clearStaticHTMLTemplate")
Result<JSONObject> clearStaticHTMLTemplate();

@GetMapping(value = "template/deleteStaticHTMLTemplate")
Result<JSONObject> deleteStaticHTMLTemplate(Integer spuId);
```

### 11.1.1.5 config包下新建MrSwagger2Config

```java
package com.baidu.shop.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

@Configuration
@EnableSwagger2
public class MrSwagger2Config {
    @Bean
    public Docket createRestApi(){
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(this.apiInfo())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.baidu"))
                .paths(PathSelectors.any())
                .build();
    }

    private ApiInfo apiInfo(){
        return new ApiInfoBuilder()
                //标题
                .title("明瑞SWAGGER2标题")
                //条款地址
                .termsOfServiceUrl("http://www.baidu.com")
                //联系方式-->有String参数的方法但是已经过时，所以不推荐使用
                .contact(new Contact("shenyaqi","baidu.com","shenyaqiii@163.com"))
                //版本
                .version("v1.0")
                //项目描述
                .description("描述")
                //创建API基本信息
                .build();
    }
}
```

### 12 mingrui-shop-service-template

### 12.1.2.1  注释掉或者直接删掉controller和service下的所有注解

![image-20210311213948330](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213948330.png)

![image-20210311214014438](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214014438.png)

### 12.1.2.2  application.yml

```yml
mrshop:
	static:
		html:
			path: E:\static-html\item #生成的html文件存储的路径,注意这个目录需要提前建好
```

### 12.1.2.3 impl包下新建TemplateServiceImpl

![image-20210311214129089](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214129089.png)

![image-20210311214140427](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214140427.png)

```java
package com.baidu.shop.service.impl;


import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.*;
import com.baidu.shop.entity.*;
import com.baidu.shop.feign.*;
import com.baidu.shop.service.TemplateService;
import com.baidu.shop.utils.BaiduBeanUtil;
import com.baidu.shop.utils.ObjectUtil;
import com.github.pagehelper.PageInfo;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;
import org.springframework.web.bind.annotation.RestController;
import org.thymeleaf.TemplateEngine;
import org.thymeleaf.context.Context;

import java.io.*;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@RestController
public class TemplateServiceImpl extends BaseApiService implements TemplateService {

    private  final Integer CREATE_STATIC_HTML = 1;
    private final Integer DELETE_STATIC_HTML = 2;

    @Autowired
    private GoodsFeign goodsFeign;

    @Autowired
    private SpecificationFeign specificationFeign;

    @Autowired
    private ElasticsearchRestTemplate elasticsearchRestTemplate;

    @Autowired
    private BrandFeign brandFeign;

    @Autowired
    private CategoryFeign categoryFeign;

    @Autowired
    private SpecParamServiceFeign specParamServiceFeign;

    @Autowired
    private TemplateEngine templateEngine;

    @Value(value = "${mrshop.static.html.path}")
    private String htmlPath;

    @Override
    public Result<JSONObject> createStaticHTMLTemplate(Integer spuId) {
        //得到要渲染的数据
        Map<String, Object> goodsInfo = this.getGoodsInfo(spuId);

        Context context = new Context();
        context.setVariables(goodsInfo);

        File file = new File(htmlPath, spuId + ".html");
        if (!file.exists()) {
            try {
                file.createNewFile();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        PrintWriter writer = null;
        try {
            writer = new PrintWriter(file, "UTF-8");
            templateEngine.process("item",context,writer);
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } catch (UnsupportedEncodingException e) {
            e.printStackTrace();
        } finally {
            if(ObjectUtil.isNotNull(writer))
                writer.close();
        }
        return this.setResultSuccess();
    }

    private Map<String, Object> getGoodsInfo(Integer spuId) {

        Map<String, Object> goodsInfoMap = new HashMap<>();

        //spu
        SpuDTO spuResultData = this.getSpuInfo(spuId);
        goodsInfoMap.put("spuInfo",spuResultData);
        //spuDetail
        goodsInfoMap.put("spuDetail",this.getSpuDetail(spuId));
        //分类信息
        goodsInfoMap.put("categoryInfo",this.getCategoryInfo(spuResultData.getCid1() + ""
                ,spuResultData.getCid2() + "",spuResultData.getCid3() + ""));
        //品牌信息
        goodsInfoMap.put("brandInfo",this.getBrandInfo(spuResultData.getBrandId()));
        //sku
        goodsInfoMap.put("skus",this.getSkus(spuId));
        //规格组,规格参数(通用)
        goodsInfoMap.put("specGroupAndParam",this.getSpecGroupAndParam(spuResultData.getCid3()));
        //特殊规格
        goodsInfoMap.put("specParamMap",this.getSpecParamMap(spuResultData.getCid3()));

        return goodsInfoMap;
    }

    private SpuDTO getSpuInfo(Integer spuId){
        SpuDTO spuDTO = new SpuDTO();
        spuDTO.setId(spuId);
        Result<List<SpuDTO>> spuResult = goodsFeign.getSpuInfo(spuDTO);
        SpuDTO spuResultData = null;
        if(spuResult.isSuccess()){
            spuResultData = spuResult.getData().get(0);
        }
        return spuResultData;
    }

    private SpuDetailEntity getSpuDetail(Integer spuId){

        SpuDetailEntity spuDetailEntity = null;
        Result<SpuDetailEntity> spuDetailResult = goodsFeign.getSpuDetailBySpuId(spuId);
        if(spuDetailResult.isSuccess()){
            spuDetailEntity = spuDetailResult.getData();
        }
        return spuDetailEntity;
    }

    private List<CategoryEntity> getCategoryInfo(String cid1, String cid2, String cid3){

        List<CategoryEntity> categoryEntityList = null;

        Result<List<CategoryEntity>> categoryResult = categoryFeign.getCategoryByIdList(
                String.join(
                        ","
                        , Arrays.asList(cid1, cid2, cid3)
                )
        );
        if(categoryResult.isSuccess()){
            categoryEntityList = categoryResult.getData();
        }
        return categoryEntityList;
    }

    private BrandEntity getBrandInfo(Integer brandId){

        BrandEntity brandEntity = null;

        BrandDTO brandDTO = new BrandDTO();
        brandDTO.setId(brandId);
        Result<PageInfo<BrandEntity>> brandResult = brandFeign.getBrandInfo(brandDTO);
        if(brandResult.isSuccess()){
            brandEntity = brandResult.getData().getList().get(0);
        }

        return brandEntity;
    }

    private List<SkuDTO> getSkus(Integer spuId){

        List<SkuDTO> skuList = null;

        Result<List<SkuDTO>> skusResult = goodsFeign.getSkusBySpuId(spuId);
        if(skusResult.isSuccess()){
            skuList = skusResult.getData();
        }
        return skuList;
    }

    private List<SpecGroupDTO> getSpecGroupAndParam(Integer cid3){

        List<SpecGroupDTO> specGroupAndParam = null;

        SpecGroupDTO specGroupDTO = new SpecGroupDTO();
        specGroupDTO.setCid(cid3);
        Result<List<SpecGroupEntity>> specGroupResult = specificationFeign.getSepcGroupInfo(specGroupDTO);
        if(specGroupResult.isSuccess()){

            List<SpecGroupEntity> specGroupList = specGroupResult.getData();
            specGroupAndParam = specGroupList.stream().map(specGroup -> {
                SpecGroupDTO specGroupDTO1 = BaiduBeanUtil.copyProperties(specGroup, SpecGroupDTO.class);

                SpecParamDTO specParamDTO = new SpecParamDTO();
                specParamDTO.setGroupId(specGroupDTO1.getId());
                specParamDTO.setGeneric(true);
                Result<List<SpecParamEntity>> specParamResult = specParamServiceFeign.getSpecParamInfo(specParamDTO);
                if (specParamResult.isSuccess()) {
                    specGroupDTO1.setSpecList(specParamResult.getData());
                }
                return specGroupDTO1;
            }).collect(Collectors.toList());
        }
        return specGroupAndParam;
    }

    private Map<Integer, String> getSpecParamMap(Integer cid3){

        Map<Integer, String> specParamMap = new HashMap<>();

        SpecParamDTO specParamDTO = new SpecParamDTO();
        specParamDTO.setCid(cid3);
        specParamDTO.setGeneric(false);
        Result<List<SpecParamEntity>> specParamResult = specParamServiceFeign.getSpecParamInfo(specParamDTO);
        if(specParamResult.isSuccess()){
            List<SpecParamEntity> specParamEntityList = specParamResult.getData();
            specParamEntityList.stream().forEach(specParam -> specParamMap.put(specParam.getId(),specParam.getName()));
        }
        return specParamMap;
    }

    @Override
    public Result<JSONObject> initStaticHTMLTemplate() {
        this.operationStaticHTML(CREATE_STATIC_HTML);
        return this.setResultSuccess();
    }

    @Override
    public Result<JSONObject> clearStaticHTMLTemplate() {
        this.operationStaticHTML(DELETE_STATIC_HTML);
        return this.setResultSuccess();
    }

    private Boolean operationStaticHTML(Integer operation){

        try {
            Result<List<SpuDTO>> spuInfo = goodsFeign.getSpuInfo(new SpuDTO());
            if(spuInfo.isSuccess()){
                spuInfo.getData().stream().forEach(spuDTO -> {
                    if(operation == 1){
                        this.createStaticHTMLTemplate(spuDTO.getId());
                    }else{
                        this.deleteStaticHTMLTemplate(spuDTO.getId());
                    }
                });
            }
            return true;
        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }

    @Override
    public Result<JSONObject> deleteStaticHTMLTemplate(Integer spuId) {
        File file = new File(htmlPath, spuId + ".html");
        if(file.exists()){
            file.delete();
        }

        return this.setResultSuccess();
    }
}
```

使用swagger测试看文件是否生成

![image-20210311214246919](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214246919.png)

要修改一下nginx的配置

![image-20210311214315416](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311214315416.png)

```c
location /item {
	root E:\static-html;
}
```

页面静态化完成,但是service中的方法太大了,所以还是需要拆一下方法

```java
package com.baidu.shop.service.impl;


import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.*;
import com.baidu.shop.entity.*;
import com.baidu.shop.feign.*;
import com.baidu.shop.service.TemplateService;
import com.baidu.shop.utils.BaiduBeanUtil;
import com.baidu.shop.utils.ObjectUtil;
import com.github.pagehelper.PageInfo;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;
import org.springframework.web.bind.annotation.RestController;
import org.thymeleaf.TemplateEngine;
import org.thymeleaf.context.Context;

import java.io.*;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@RestController
public class TemplateServiceImpl extends BaseApiService implements TemplateService {

    private  final Integer CREATE_STATIC_HTML = 1;
    private final Integer DELETE_STATIC_HTML = 2;

    @Autowired
    private GoodsFeign goodsFeign;

    @Autowired
    private SpecificationFeign specificationFeign;

    @Autowired
    private ElasticsearchRestTemplate elasticsearchRestTemplate;

    @Autowired
    private BrandFeign brandFeign;

    @Autowired
    private CategoryFeign categoryFeign;

    @Autowired
    private SpecParamServiceFeign specParamServiceFeign;

    @Autowired
    private TemplateEngine templateEngine;

    @Value(value = "${mrshop.static.html.path}")
    private String htmlPath;

    @Override
    public Result<JSONObject> createStaticHTMLTemplate(Integer spuId) {
        //得到要渲染的数据
        Map<String, Object> goodsInfo = this.getGoodsInfo(spuId);

        Context context = new Context();
        context.setVariables(goodsInfo);

        File file = new File(htmlPath, spuId + ".html");
        if (!file.exists()) {
            try {
                file.createNewFile();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        PrintWriter writer = null;
        try {
            writer = new PrintWriter(file, "UTF-8");
            templateEngine.process("item",context,writer);
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } catch (UnsupportedEncodingException e) {
            e.printStackTrace();
        } finally {
            if(ObjectUtil.isNotNull(writer))
                writer.close();
        }
        return this.setResultSuccess();
    }

    private Map<String, Object> getGoodsInfo(Integer spuId) {

        Map<String, Object> goodsInfoMap = new HashMap<>();

        //spu
        SpuDTO spuResultData = this.getSpuInfo(spuId);
        goodsInfoMap.put("spuInfo",spuResultData);
        //spuDetail
        goodsInfoMap.put("spuDetail",this.getSpuDetail(spuId));
        //分类信息
        goodsInfoMap.put("categoryInfo",this.getCategoryInfo(spuResultData.getCid1() + ""
                ,spuResultData.getCid2() + "",spuResultData.getCid3() + ""));
        //品牌信息
        goodsInfoMap.put("brandInfo",this.getBrandInfo(spuResultData.getBrandId()));
        //sku
        goodsInfoMap.put("skus",this.getSkus(spuId));
        //规格组,规格参数(通用)
        goodsInfoMap.put("specGroupAndParam",this.getSpecGroupAndParam(spuResultData.getCid3()));
        //特殊规格
        goodsInfoMap.put("specParamMap",this.getSpecParamMap(spuResultData.getCid3()));

        return goodsInfoMap;
    }

    private SpuDTO getSpuInfo(Integer spuId){
        SpuDTO spuDTO = new SpuDTO();
        spuDTO.setId(spuId);
        Result<List<SpuDTO>> spuResult = goodsFeign.getSpuInfo(spuDTO);
        SpuDTO spuResultData = null;
        if(spuResult.isSuccess()){
            spuResultData = spuResult.getData().get(0);
        }
        return spuResultData;
    }

    private SpuDetailEntity getSpuDetail(Integer spuId){

        SpuDetailEntity spuDetailEntity = null;
        Result<SpuDetailEntity> spuDetailResult = goodsFeign.getSpuDetailBySpuId(spuId);
        if(spuDetailResult.isSuccess()){
            spuDetailEntity = spuDetailResult.getData();
        }
        return spuDetailEntity;
    }

    private List<CategoryEntity> getCategoryInfo(String cid1, String cid2, String cid3){

        List<CategoryEntity> categoryEntityList = null;

        Result<List<CategoryEntity>> categoryResult = categoryFeign.getCategoryByIdList(
                String.join(
                        ","
                        , Arrays.asList(cid1, cid2, cid3)
                )
        );
        if(categoryResult.isSuccess()){
            categoryEntityList = categoryResult.getData();
        }
        return categoryEntityList;
    }

    private BrandEntity getBrandInfo(Integer brandId){

        BrandEntity brandEntity = null;

        BrandDTO brandDTO = new BrandDTO();
        brandDTO.setId(brandId);
        Result<PageInfo<BrandEntity>> brandResult = brandFeign.getBrandInfo(brandDTO);
        if(brandResult.isSuccess()){
            brandEntity = brandResult.getData().getList().get(0);
        }

        return brandEntity;
    }

    private List<SkuDTO> getSkus(Integer spuId){

        List<SkuDTO> skuList = null;

        Result<List<SkuDTO>> skusResult = goodsFeign.getSkusBySpuId(spuId);
        if(skusResult.isSuccess()){
            skuList = skusResult.getData();
        }
        return skuList;
    }

    private List<SpecGroupDTO> getSpecGroupAndParam(Integer cid3){

        List<SpecGroupDTO> specGroupAndParam = null;

        SpecGroupDTO specGroupDTO = new SpecGroupDTO();
        specGroupDTO.setCid(cid3);
        Result<List<SpecGroupEntity>> specGroupResult = specificationFeign.getSepcGroupInfo(specGroupDTO);
        if(specGroupResult.isSuccess()){

            List<SpecGroupEntity> specGroupList = specGroupResult.getData();
            specGroupAndParam = specGroupList.stream().map(specGroup -> {
                SpecGroupDTO specGroupDTO1 = BaiduBeanUtil.copyProperties(specGroup, SpecGroupDTO.class);

                SpecParamDTO specParamDTO = new SpecParamDTO();
                specParamDTO.setGroupId(specGroupDTO1.getId());
                specParamDTO.setGeneric(true);
                Result<List<SpecParamEntity>> specParamResult = specParamServiceFeign.getSpecParamInfo(specParamDTO);
                if (specParamResult.isSuccess()) {
                    specGroupDTO1.setSpecList(specParamResult.getData());
                }
                return specGroupDTO1;
            }).collect(Collectors.toList());
        }
        return specGroupAndParam;
    }

    private Map<Integer, String> getSpecParamMap(Integer cid3){

        Map<Integer, String> specParamMap = new HashMap<>();

        SpecParamDTO specParamDTO = new SpecParamDTO();
        specParamDTO.setCid(cid3);
        specParamDTO.setGeneric(false);
        Result<List<SpecParamEntity>> specParamResult = specParamServiceFeign.getSpecParamInfo(specParamDTO);
        if(specParamResult.isSuccess()){
            List<SpecParamEntity> specParamEntityList = specParamResult.getData();
            specParamEntityList.stream().forEach(specParam -> specParamMap.put(specParam.getId(),specParam.getName()));
        }
        return specParamMap;
    }

    @Override
    public Result<JSONObject> initStaticHTMLTemplate() {
        this.operationStaticHTML(CREATE_STATIC_HTML);
        return this.setResultSuccess();
    }

    @Override
    public Result<JSONObject> clearStaticHTMLTemplate() {
        this.operationStaticHTML(DELETE_STATIC_HTML);
        return this.setResultSuccess();
    }

    private Boolean operationStaticHTML(Integer operation){

        try {
            Result<List<SpuDTO>> spuInfo = goodsFeign.getSpuInfo(new SpuDTO());
            if(spuInfo.isSuccess()){
                spuInfo.getData().stream().forEach(spuDTO -> {
                    if(operation == 1){
                        this.createStaticHTMLTemplate(spuDTO.getId());
                    }else{
                        this.deleteStaticHTMLTemplate(spuDTO.getId());
                    }
                });
            }
            return true;
        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }

    @Override
    public Result<JSONObject> deleteStaticHTMLTemplate(Integer spuId) {
        File file = new File(htmlPath, spuId + ".html");
        if(file.exists()){
            file.delete();
        }

        return this.setResultSuccess();
    }
}
```

# 十.RabbitMQ

## 1.RabbitMQ

### 1.1搜索与商品服务的问题

目前我们已经完成了商品详情和搜索系统的开发

- ​	商品的原始数据保存在数据库中，CRUD都在xxx项目中完成搜索服务数据来源是es索引库，由search项目维护

- ​	商品详情做了页面静态化，静态页面由template项目生成维护

如果我们在后台新增了商品。或者修改，删除商品，那么默认操作的是数据库，而es和template不会默认更新索引库和静态页面

这里有两种解决方案：

- 方案1：每当后台对商品做增删改操作，同时要修改索引库数据及静态页面
- 方案2：搜索服务和商品页面服务对外提供操作接口，后台在商品增删改后，调用feign接口

以上两种方式都有同一个严重问题：就是代码耦合，后台服务中需要嵌入搜索和商品页面服务，违背了微服务的原则。

所以，我们会通过另外一种方式来解决这个问题：消息队列

### 1.2消息队列（MQ）

#### 1.2.1什么是消息队列

消息队列，即MQ，Message Queue。

![image-20210311212552726](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311212552726.png)

消息队列是典型的：生产者、消费者模型。生产者不断向消息队列中生产消息，消费者不断的从队列中获取消息。因为消息的生产和消费都是异步的，而且只关心消息的发送和接收，没有业务逻辑的侵入，这样就实现了生产者和消费者的解耦。

结合前面所说的问题：

- 商品服务对商品增删改以后，无需去操作索引库(es)或静态页面(template)，只是发送一条消息，
  也不关心消息被谁接收。

- 搜索服务和静态页面服务接收消息，分别去处理索引库的更新和静态页面的创建覆盖。

如果以后有其它服务也依赖xxx商品的数据，同样监听消息即可，商品服务无需任何代码修改。

#### 1.2.2 AMQP和JMS

MQ是消息通信的模型，并发具体实现。现在实现MQ的有两种主流方式：AMQP、JMS。

![image-20210311212927986](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311212927986.png)

![image-20210311213534157](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311213534157.png)



两者间的区别和联系：

- JMS是定义了统一的接口，来对消息操作进行统一；AMQP是通过规定协议来统一数据交互的格式
- JMS限定了必须使用Java语言；AMQP只是协议，不规定实现方式，因此是跨语言的。
- JMS规定了两种消息模型；而AMQP的消息模型更加丰富

#### 1.2.3常见MQ产品

- ActiveMQ：基于JMS
- RabbitMQ：基于AMQP协议，erlang语言开发，稳定性好
- RocketMQ：基于JMS，阿里巴巴产品，目前交由Apache基金会
- Kafka：分布式消息系统，高吞吐量ZeroMQ，IBM WebSphere

#### 1.2.4 RabbitMQ

RabbitMQ是基于AMQP的一款消息管理系统

官网：http://www.rabbitmq.com

官方教程：http://www.rabbitmq.com/getstart.html

![image-20210311213948900](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311213948900.png)



![image-20210311214108218](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311214108218.png)

**RabbitMQ基于Erlang语言开发：**

![image-20210311214130591](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311214130591.png)

### 1.3下载和安装

### 1.4七种消息模型

**开始学习**http://www.rabbitmq.com/getstart.html

RabbitMQ提供了7种消息模型

1、2是队列模型

3、4、5是订阅，交换机模型

6、是rpc回调模型

7、是确认模型

![image-20210311214305823](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311214305823.png)

![image-20210311214320279](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311214320279.png)

![image-20210311214342438](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311214342438.png)

新建demo项目

pom.xml

```xml
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.3.1.RELEASE</version>
</parent>
<properties>
        <java.version>1.8</java.version>
</properties>
<dependencies>
	<dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-lang3</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
</dependency></dependencies>
```

新建包com.mr.rabbitmq.utils

在utils包下新建RabbitmqConnectionUtil

```java
importcom.rabbitmq.client.Connection;
importcom.rabbitmq.client.ConnectionFactory;

publicclassRabbitmqConnectionUtil{
	publicstaticConnectiongetConnection()throwsException{
        //定义rabbitmq连接工厂
        ConnectionFactoryfactory=newConnectionFactory();
        //设置超时时间
        factory.setConnectionTimeout(60000);
        //设置服务ip
        factory.setHost("127.0.0.1");
        //设置端口5672
        factory.setPort(5672);
        //设置，用户名、密码、虚拟主机
        factory.setUsername("guest");factory.setPassword("guest");
        //创建连接，根据工厂
        Connectionconnection=factory.newConnection();
        returnconnection;
	}
}
```

#### 1.4.1基本消息模型

在com.mr.rabbitmq下新建simple包

包下新建SendMessage

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;

public class SendMessage {

    //序列名称
    private final static String QUEUE_NAME = "simple_queue";

    //主函数
    public static void main(String[] arg) throws Exception {
        //获取连接 现在可以操作rabbitmq了
        Connection connection = RabbitmqConnectionUtil.getConnection();

        //创建通道
        Channel channel = connection.createChannel();

        /*
        param1 : 队列名称
        param2 : 是否持久化
        param3 : 是否排外
        param4 : 是否自动删除
        param5 : 额外参数
         */
        channel.queueDeclare(QUEUE_NAME,false,false,false,null);

        //要发送的消息
        String msg = "good good study , day day up";

        //发送消息
        channel.basicPublish("",QUEUE_NAME,null,msg.getBytes());
        System.out.println("消息发送成功");

        //关闭通道和连接
        channel.close();
        connection.close();
    }
}

```

channel.queueDeclare(QUEUE_NAME, false, false, false, null);

- param1:队列名字
- param2: durable

- 是否持久化

是否持久化,队列的声明默认是存放到内存中的，如果rabbitmq重启会丢失，如果想重启之后还存在就要使队列持久化，保存到Erlang自带的Mnesia数据库中，当rabbitmq重启之后会读取该数据库

- param3: exclusive

- 是否排外

是否排外的，有两个作用，一：当连接关闭时connection.close()该队列是否会自动删除；二：该队列是否是私有的private，如果不是排外的，可以使用两个消费者都访问同一个队列，没有任何问题，如果是排外的，会对当前队列加锁，其他通道channel是不能访问的，如果强制访问会报异常：com.rabbitmq.client.ShutdownSignalException: channel error;protocol method:text=RESOURCE_LOCKED-cannotobtainexclusiveaccesstolockedqueue一般等于true的话用于一个队列只能有一个消费者来消费的场景

- param4 : autoDelete

- 是否自动删除队列，当最后一个消费者断开连接之后队列是否自动被删除，可以通过RabbitMQ Management，查看某个队列的消费者数量，当consumers = 0时队列就会自动删除
- param5:相关参数

运行main函数

![image-20210311215108280](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311215108280.png)

浏览器打开ip:15672

可以看到消息队列中已经有消息了

![image-20210311215138752](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311215138752.png)

在simple包下新建Receive

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.*;

import javax.sound.midi.Soundbank;
import java.io.IOException;

public class Receive {
	//队列名称
   	private final static String QUEUE_NAME = "simple_queue";

   	public static void main(String[] args) throws Exception {

       //获取连接
        Connectionconnection=RabbitmqConnectionUtil.getConnection();
        //创建通道
        Channelchannel=connection.createChannel();
         /*
            param1:队列名称
            param2: 是否持久化
            param3: 是否排外
            param4: 是否自动删除
            param5: 其他参数
         */
        channel.queueDeclare(QUEUE_NAME,false,false,false,null);
        //定义队列接收端==》消费者
        DefaultConsumerconsumer=newDefaultConsumer(channel){
          //监听队列中的消息，如果有消息，进行处理
        @OverridepublicvoidhandleDelivery(StringconsumerTag,Envelopeenvelope,
        AMQP.BasicPropertiesproperties,byte[]body)throwsIOException{
            //body：消息中参数信息
            Stringmsg=newString(body);
            System.out.println("收到消息，执行中:"+msg+"!");
            //System.out.println(1/0);
            /*
            param1:（唯一标识ID）
            param2:是否进行批处理
            */
            channel.basicAck(envelope.getDeliveryTag(),false);
        }};
        /*
        param1:队列名称
        param2:是否自动确认消息
        param3:消费者
        */
        channel.basicConsume(QUEUE_NAME,false,consumer);
        //消费者需要时时监听消息，不用关闭通道与连接
    }
}
```

执行main函数

![image-20210311215235093](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311215235093.png)

![image-20210311215248539](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311215248539.png)

可以看到消息队列中的数据已经被消费完了

>消费者的消息确认机制(Acknowlage)

通过刚才的案例可以看出，消息一旦被消费者接收，队列中的消息就会被删除。那么问题来了：RabbitMQ怎么知道消息被接收了呢？

这就要通过消息确认机制（Acknowlege）来实现了。当消费者获取消息后，会向RabbitMQ发送回执ACK，告知消息已经被接收。不过这种回执ACK分两种情况：

- 自动ACK：消息一旦被接收，消费者自动发送ACK
- 手动ACK：消息接收后，不会发送ACK，需要手动调用

大家觉得哪种更好呢？

这需要看消息的重要性：

- 如果消息不太重要，丢失也没有影响，那么自动ACK会比较方便

- 如果消息非常重要，不允许丢失。那么最好在消费完成后手动ACK，否则接收消息后就自动ACK，RabbitMQ就会把消息从队列中删除。如果此时消费者宕机，那么消息就丢失了。

我们之前的测试都是自动ACK的，如果要手动ACK，需要改动我们的代码：

```java
importcom.mr.rabbitmq.utils.RabbitmqConnectionUtil;
importcom.rabbitmq.client.*;
importjava.io.IOException;

publicclassReceiveACK{
    //队列名称
    privatefinalstaticStringQUEUE_NAME="simple_queue";
    public static void main(String[]arg)throwsException{
        //获取连接
        Connectionconnection=RabbitmqConnectionUtil.getConnection();
        //创建通道
        Channelchannel=connection.createChannel();
        //声明队列
        channel.queueDeclare(QUEUE_NAME,false,false,false,null);
        //定义队列接收端==》消费者
        DefaultConsumerconsumer=newDefaultConsumer(channel){
        //监听队列中的消息，如果有消息，进行处理
        @OverridepublicvoidhandleDelivery(StringconsumerTag,Envelopeenvelope,
        AMQP.BasicPropertiesproperties,
        byte[]body)throwsIOException{
        //body：消息中参数信息
        Stringmsg=newString(body);
        System.out.println("收到消息，执行中:"+msg+"!");
        //System.out.println(1/0);
        /*
        param1:（唯一标识ID）
        param2:是否进行批处理
        */
        channel.basicAck(envelope.getDeliveryTag(),false);
        }};
        /*
        param1:队列名称
        param2:是否自动确认消息
        param3:消费者
        */
        channel.basicConsume(QUEUE_NAME,false,consumer);
        //消费者需要时时监听消息，不用关闭通道与连接
    }
}
```

#### 1.4.2 work消息模型

> 说明

在刚才的基本模型中，一个生产者，一个消费者，生产的消息直接被消费者消费。比较简单。

Work queues，也被称为（Task queues），任务模型。

当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。此时就可以使用work模型：**让多个消费者绑定到一个队列，共同消费队列中的消息**。队列中的消息一旦消费，就会消失，因此任务是不会被重复执行的。

![image-20210311215651197](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311215651197.png)

角色：

- P：生产者：任务的发布者

- C1：消费者，领取任务并且完成任务，假设完成速度较慢

- C2：消费者2：领取任务并完成任务，假设完成速度快

#### 1.4.2.1生产者

在com.mr.rabbitmq下新建包work

SendMessage

```java
import com.baidu.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;

public class SendMessage {
    //序列名称
    private final static String QUEUE_NAME = "test_work_queue";
    //主函数
    public static void main(String[] arg) throws Exception {
        // 获取到连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 获取通道
        Channel channel = connection.createChannel();
        /*
         *   param1:队列名称
         *   param2: 是否持久化
         *   param3: 是否排外
         *   param4: 是否自动删除
         *   param5: 其他参数
         */
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        // 循环发送消息100条
        for (int i = 0; i < 100; i++) {
            // 消息参数内容
            String message = "task - good study -" + i;
            /*
             *  param1: 交换机名称
             *  param2: routingKey
             *  param3: 一些配置信息
             *  param4: 发送的消息
             */
            channel.basicPublish("", QUEUE_NAME, null, message.getBytes());
            System.out.println(" send '" + message + "' success");
        }
        // 关闭通道和连接
        channel.close();
        connection.close();
    }

}

```

#### 1.4.2.2消费者1

在work包下新建ReceiveOne

```java
import com.baidu.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.*;

import java.io.IOException;

public class ReceiveOne {
    //队列名称
    private final static String QUEUE_NAME = "test_work_queue";

    public static void main(String[] arg) throws Exception {
        // 获取连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 创建通道
        Channel channel = connection.createChannel();
        /*
         *   param1:队列名称
         *   param2: 是否持久化
         *   param3: 是否排外
         *   param4: 是否自动删除
         *   param5: 其他参数
         */
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        //通道设置 一个消费者获取一条消息，执行完毕，再获取下一条
        channel.basicQos(1);
        // 定义队列 接收端==》消费者
        DefaultConsumer consumer = new DefaultConsumer(channel) {
            // 监听队列中的消息，如果有消息，进行处理
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties,
                                       byte[] body) throws IOException {
                // body： 消息中参数信息
                String msg = new String(body);
                System.out.println(" [消费者-1] 收到消息 : " + msg);
                //System.out.println(1/0);
                /*
                 *   param1 : （唯一标识 ID）
                 *   param2 : 是否进行批处理
                 */
                channel.basicAck(envelope.getDeliveryTag(), false);
            }
        };
        /*
         *  param1 : 队列名称
         *  param2 : 是否自动确认消息
         *  param3 : 消费者
         */
        channel.basicConsume(QUEUE_NAME, false, consumer);

        //消费者需要时时监听消息，不用关闭通道与连接
    }
}

```

#### 1.4.2.3消费者2

在work包下新建ReceiveTwo

```java
import com.baidu.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.*;

import java.io.IOException;

public class ReceiveTwo {
    //队列名称
    private final static String QUEUE_NAME = "test_work_queue";

    public static void main(String[] arg) throws Exception {
        // 获取连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 创建通道
        Channel channel = connection.createChannel();
        /*
         *   param1:队列名称
         *   param2: 是否持久化
         *   param3: 是否排外
         *   param4: 是否自动删除
         *   param5: 其他参数
         */
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        //通道设置 一个消费者获取一条消息，执行完毕，再获取下一条
        channel.basicQos(1);

        // 定义队列 接收端==》消费者
        DefaultConsumer consumer = new DefaultConsumer(channel) {
            // 监听队列中的消息，如果有消息，进行处理
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties,
                                       byte[] body) throws IOException {
                // body： 消息中参数信息
                String msg = new String(body);
                System.out.println(" [消费者-2] 收到消息 : " + msg);
                //System.out.println(1/0);

                try {
                    //增加消费者2消费消息的时间
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }

                channel.basicAck(envelope.getDeliveryTag(), false);
            }
        };
        /*
         *  param1 : 队列名称
         *  param2 : 是否自动确认消息
         *  param3 : 消费者
         */
        channel.basicConsume(QUEUE_NAME, false, consumer);

        //消费者需要时时监听消息，不用关闭通道与连接
    }
}

```

运行ReceiveOne和ReceiveTwo

再运行SendMessage

![image-20210311221605602](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311221605602.png)

![image-20210311221617922](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311221617922.png)

可以发现，两个消费者各自消费了50条消息，而且各不相同，这就实现了任务的分发。

增加消费者2的耗时时间，也是如此平衡的分配消息

#### 1.3.2.4能者多劳

刚才的实现有问题吗？

- 消费者2比消费者1的效率要低，一次任务的耗时较长
- 然而两人最终消费的消息数量是一样的
- 消费者1大量时间处于空闲状态，消费者2一直忙碌

现在的状态属于是把任务平均分配，正确的做法应该是消费越快的人，消费的越多。怎么实现呢？

我们可以修改设置，让消费者同一时间只接收一条消息，这样处理完成之前，就不会接收更多消息，就可以让处理快的人，接收更多消息：

代码，设置获取一条消息，执行完在执行下一次

//通道设置一个消费者获取一条消息，执行完毕，再获取下一条
channel.basicQos(1);

![image-20210311221749940](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311221749940.png)

![image-20210311221757766](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311221757766.png)

![image-20210311221806505](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311221806505.png)

#### 1.4.3订阅模型

订阅模型示意图：

![image-20210311221828242](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311221828242.png)

前面2个案例中，只有3个角色：

- P：生产者，也就是要发送消息的程序
- C：消费者：消息的接受者，会一直等待消息到来。
- queue：消息队列，图中红色部分。类似一个邮箱，可以缓存消息；生产者向其中投递消息，消费者从其中取出消息。

而在订阅模型中，多了一个exchange角色，而且过程略有变化：

- P：生产者，也就是要发送消息的程序，消息不再发送到队列中，而是发给X（交换机）
- C：消费者，消息的接受者，会一直等待消息到来。
- Queue：消息队列，接收消息、缓存消息。

- Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有以下3种类型：
- Fanout（扇型交换机）：广播，将消息交给所有绑定到交换机的队列Direct（直连交换机）：定向，把消息交给符合指定routing key的队列
  Topic（主题交换机）：通配符，把消息交给符合routing pattern（路由模式）的队列//router

Fanout（扇型交换机）：广播，将消息交给所有绑定到交换机的队列Direct（直连交换机）：定向，把消息交给符合指定routing key的队列
Topic（主题交换机）：通配符，把消息交给符合routing pattern（路由模式）的队列//router

#### 1.4.3.1订阅模型-Fanout

Fanout，也称为广播。

> 流程说明

流程图：

![image-20210311222109446](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311222109446.png)

在广播模式下，消息发送流程是这样的：

1）可以有多个消费者
2）每个消费者有自己的queue（队列）3）每个队列都要绑定到Exchange（交换机）
4）生产者发送的消息，只能发送到交换机，交换机来决定要发给哪个队列，生产者无法决定。
5）交换机把消息发送给绑定过的所有队列
6）队列的消费者都能拿到消息。实现一条消息被多个消费者消费

##### 1.4.3.1.1生产者

![image-20210311223103807](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311223103807.png)

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;

public class SendMessage {

    //交换机名称
    private final static String EXCHANGE_NAME = "fanout_exchange_test";

    //主函数
    public static void main(String[] arg) throws Exception {
        // 获取到连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 获取通道
        Channel channel = connection.createChannel();

        /*
        param1: 交换机名称
        param2: 交换机类型
         */
        channel.exchangeDeclare(EXCHANGE_NAME,"fanout");

        //发送的消息内容
        String message = "good good study";

        /*
        param1: 交换机名称
        param2: routingKey
        param3: 一些配置信息
        param4: 发送的消息
         */
        //发送消息
        channel.basicPublish(EXCHANGE_NAME, "", null, message.getBytes());

        System.out.println(" 消息发送 '" + message + "' 到交换机 success");
        // 关闭通道和连接
        channel.close();
        connection.close();
    }
}

```

##### 1.4.3.1.2消费者1

![image-20210311223045465](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311223045465.png)

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.*;

import java.io.IOException;

public class ReceiveOne {

    //交换机名称
    private final static String EXCHANGE_NAME = "fanout_exchange_test";

    //队列名称
    private final static String QUEUE_NAME = "fanout_exchange_queue_1";

    public static void main(String[] arg) throws Exception {
        // 获取连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 创建通道
        Channel channel = connection.createChannel();
        // 声明队列
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        //消息队列绑定到交换机
        /*
        param1: 序列名
        param2: 交换机名
        param3: routingKey
         */
        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,"");
        // 定义队列 接收端==》消费者
        DefaultConsumer consumer = new DefaultConsumer(channel) {
            // 监听队列中的消息，如果有消息，进行处理
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties,
                                       byte[] body) throws IOException {
                // body： 消息中参数信息
                String msg = new String(body);
                System.out.println(" [消费者-1] 收到消息 : " + msg );
            }
        };
       /*
       param1 : 队列名称
       param2 : 是否自动确认消息
       param3 : 消费者
        */
        channel.basicConsume(QUEUE_NAME, true, consumer);

        //消费者需要时时监听消息，不用关闭通道与连接
    }
}

```

##### 1.4.3.1.3消费者2

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.*;

import java.io.IOException;

public class ReceiveTwo {

    //交换机名称
    private final static String EXCHANGE_NAME = "fanout_exchange_test";

    //队列名称
    private final static String QUEUE_NAME = "fanout_exchange_queue_2";

    public static void main(String[] arg) throws Exception {
        // 获取连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 创建通道
        Channel channel = connection.createChannel();
        // 声明队列
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        //消息队列绑定到交换机
        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,"");

        // 定义队列 接收端==》消费者
        DefaultConsumer consumer = new DefaultConsumer(channel) {
            // 监听队列中的消息，如果有消息，进行处理
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties,
                                       byte[] body) throws IOException {
                // body： 消息中参数信息
                String msg = new String(body);
                System.out.println(" [消费者-2] 收到消息 : " + msg );
            }
        };
       /*
       param1 : 队列名称
       param2 : 是否自动确认消息
       param3 : 消费者
        */
        channel.basicConsume(QUEUE_NAME, true, consumer);

        //消费者需要时时监听消息，不用关闭通道与连接
    }
}

```

![image-20210311222558566](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311222558566.png)

#### 1.4.3.2订阅模型-Direct

> 说明

在Fanout模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到Direct类型的Exchange。

在Direct模型下：

- 队列与交换机的绑定，不能是任意绑定了，而是要指定一个（路由key）
- 消息的发送方在向Exchange发送消息时，也必须指定消息的。
- Exchange不再把消息交给每一个绑定的队列，而是根据消息的进行判断，只有队列的与消息的完全一致，才会接收到消息

![image-20210311222701323](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311222701323.png)

图解：

- P：生产者，向Exchange发送消息，发送消息时，会指定一个routing key。
- X：Exchange（交换机），接收生产者的消息，然后把消息递交给与routing key完全匹配的队列
- C1：消费者，其所在队列指定了需要routing key为orange的消息
- C2：消费者，其所在队列指定了需要routing key为black、green的消息

##### 1.4.3.2.1生产者

![image-20210311223017629](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311223017629.png)

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;

public class SendMessage {

    //交换机名称
    private final static String EXCHANGE_NAME = "direct_exchange_test";

    //主函数
    public static void main(String[] arg) throws Exception {
        // 获取到连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 获取通道
        Channel channel = connection.createChannel();

        /*
        param1: 交换机名称
        param2: 交换机类型
         */
        channel.exchangeDeclare(EXCHANGE_NAME,"direct");

        //发送的消息内容
        //String message = "商品新增成功  id ： 153";
        //String message = "商品修改成功  id ： 153";
        String message = "商品删除成功  id ： 153";
        /*
        param1: 交换机名称
        param2: routingKey
        param3: 一些配置信息
        param4: 发送的消息
         */
        //发送消息
        channel.basicPublish(EXCHANGE_NAME, "delete", null, message.getBytes());
        //channel.basicPublish(EXCHANGE_NAME, "update", null, message.getBytes());
        //channel.basicPublish(EXCHANGE_NAME, "delete", null, message.getBytes());

        System.out.println(" [商品服务] 发送消息routingKey ：delete   '" + message );
        // 关闭通道和连接
        channel.close();
        connection.close();
    }
}

```

##### 1.4.3.2.2消费者1

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.*;

import java.io.IOException;

public class ReceiveOne {

    //交换机名称
    private final static String EXCHANGE_NAME = "direct_exchange_test";

    //队列名称
    private final static String QUEUE_NAME = "direct_exchange_queue_1";

    public static void main(String[] arg) throws Exception {
        // 获取连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 创建通道
        Channel channel = connection.createChannel();
        // 声明队列
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        //消息队列绑定到交换机
        /*
        param1: 序列名
        param2: 交换机名
        param3: routingKey
         */
        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, "save");
        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, "update");
        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, "delete");
        // 定义队列 接收端==》消费者
        DefaultConsumer consumer = new DefaultConsumer(channel) {
            // 监听队列中的消息，如果有消息，进行处理
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties,
                                       byte[] body) throws IOException {
                // body： 消息中参数信息
                String msg = new String(body);
                System.out.println(" [消费者1模拟es服务] 接收到消息 : " + msg );

            }
        };
       /*
       param1 : 队列名称
       param2 : 是否自动确认消息
       param3 : 消费者
        */
        channel.basicConsume(QUEUE_NAME, false, consumer);

        //消费者需要时时监听消息，不用关闭通道与连接
    }
}

```

##### 1.4.3.2.3消费者2

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.*;

import java.io.IOException;

public class ReceiveTwo {

    //交换机名称
    private final static String EXCHANGE_NAME = "direct_exchange_test";

    //队列名称
    private final static String QUEUE_NAME = "direct_exchange_queue_2";

    public static void main(String[] arg) throws Exception {
        // 获取连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 创建通道
        Channel channel = connection.createChannel();
        // 声明队列
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        //消息队列绑定到交换机
        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, "save");
        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, "update");

        // 定义队列 接收端==》消费者
        DefaultConsumer consumer = new DefaultConsumer(channel) {
            // 监听队列中的消息，如果有消息，进行处理
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties,
                                       byte[] body) throws IOException {
                // body： 消息中参数信息
                String msg = new String(body);
                System.out.println(" [消费者2模拟template服务] 接收到消息 : " + msg);
            }
        };
       /*
       param1 : 队列名称
       param2 : 是否自动确认消息
       param3 : 消费者
        */
        channel.basicConsume(QUEUE_NAME, true, consumer);

        //消费者需要时时监听消息，不用关闭通道与连接
    }
}

```

![image-20210311222941778](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311222941778.png)

执行完这三种routingKey后会发现消费者1能接受到三条消息,消费者2只能接收到两条消息

#### 1.4.3.3订阅模型-Topic

> 说明

Topic 类型的 Exchange 与 Direct 相比，都是可以根据 RoutingKey 把消息路由到不同的队列。只不

过 Topic 类型 Exchange 可以让队列在绑定 Routing key  的时候使用通配符！

 Routingkey  一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如：  item.save

 通配符规则：

​    匹配一个或多个词

   匹配不多不少恰好1个词

举例：

   能够匹配 audit.irs.corporate  或者 

  只能匹配 audit.irs

图示：

![image-20210311223445316](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311223445316.png)

解释：

Queue1：绑定的是 *.orange.*  例如:aa.orange.bb 类似于这种数据都可以以被匹配到

Queue2：绑定的是 *.*.rabbit  和 lazy.# ，例如:aa.bb.rabbit和lazy.aa.bb都可以被匹配到

##### 1.4.3.3.1 生产者

 

使用topic类型的Exchange，发送消息的routing key有1种：  goods.delete

![image-20210311223540092](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311223540092.png)

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;

public class SendMessage {

    //交换机名称
    private final static String EXCHANGE_NAME = "topic_exchange_test";

    //主函数
    public static void main(String[] arg) throws Exception {
        // 获取到连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 获取通道
        Channel channel = connection.createChannel();

        /*
        param1: 交换机名称
        param2: 交换机类型
         */
        channel.exchangeDeclare(EXCHANGE_NAME,"topic");

        //发送的消息内容
        String message = "商品删除成功  id ： 153";
        /*
        param1: 交换机名称
        param2: routingKey
        param3: 一些配置信息
        param4: 发送的消息
         */
        //发送消息
        channel.basicPublish(EXCHANGE_NAME, "goods.delete", null, message.getBytes());
        //channel.basicPublish(EXCHANGE_NAME, "update", null, message.getBytes());
        //channel.basicPublish(EXCHANGE_NAME, "delete", null, message.getBytes());

        System.out.println(" [商品服务] 发送消息routingKey ：delete   '" + message );
        // 关闭通道和连接
        channel.close();
        connection.close();
    }
}

```

##### 1.4.3.3.2消费者1

![image-20210311223712901](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311223712901.png)

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.*;

import java.io.IOException;

public class ReceiveOne {

    //交换机名称
    private final static String EXCHANGE_NAME = "topic_exchange_test";

    //队列名称
    private final static String QUEUE_NAME = "topic_exchange_queue_1";

    public static void main(String[] arg) throws Exception {
        // 获取连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 创建通道
        Channel channel = connection.createChannel();
        // 声明队列
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        //消息队列绑定到交换机
        /*
        param1: 序列名
        param2: 交换机名
        param3: routingKey
         */
        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, "goods.*");
        // 定义队列 接收端==》消费者
        DefaultConsumer consumer = new DefaultConsumer(channel) {
            // 监听队列中的消息，如果有消息，进行处理
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties,
                                       byte[] body) throws IOException {
                // body： 消息中参数信息
                String msg = new String(body);
                System.out.println(" [消费者1模拟es服务] 接收到消息 : " + msg);
            }
        };
       /*
       param1 : 队列名称
       param2 : 是否自动确认消息
       param3 : 消费者
        */
        channel.basicConsume(QUEUE_NAME, true, consumer);

        //消费者需要时时监听消息，不用关闭通道与连接
    }
}

```

##### 1.4.3.3.3消费者2

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.*;

import java.io.IOException;

public class ReceiveTwo {


    //交换机名称
    private final static String EXCHANGE_NAME = "topic_exchange_test";

    //队列名称
    private final static String QUEUE_NAME = "topic_exchange_queue_2";

    public static void main(String[] arg) throws Exception {
        // 获取连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 创建通道
        Channel channel = connection.createChannel();
        // 声明队列
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        //消息队列绑定到交换机
        /*
        param1: 序列名
        param2: 交换机名
        param3: routingKey
         */
        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, "goods.update");
        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, "goods.save");
        // 定义队列 接收端==》消费者
        DefaultConsumer consumer = new DefaultConsumer(channel) {
            // 监听队列中的消息，如果有消息，进行处理
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties,
                                       byte[] body) throws IOException {
                // body： 消息中参数信息
                String msg = new String(body);
                System.out.println(" [消费者2模拟es服务] 接收到消息 : " + msg );
            }
        };
       /*
       param1 : 队列名称
       param2 : 是否自动确认消息
       param3 : 消费者
        */
        channel.basicConsume(QUEUE_NAME, true, consumer);

        //消费者需要时时监听消息，不用关闭通道与连接
    }
}

```

#### 1.4.4 RPC模型

RPC：Remote Procedure Call 远程过程调用

以上五种模型，解决的都是单向传输问题。就是说，发送端发出消息后，不关心谁执行了消息，执行结

果怎么样，这种行为是异步的，消费端接收到消息，执行后，通过ack机制，可以将执行结果发送给队

列，而没有发送给发送端。大多数需求都是这样的 

但如果需求比较特殊，就是 发送端，需要知道消息执行的结果，那么如何处理的，ack只能默认通知到

队列，而不能通知到发送端，如果你有此类需求，那么 rcp模型是你最好的选择

![image-20210311223917004](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311223917004.png)

##### 1.4.4.1生产者

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.*;

import java.io.IOException;

public class RpcSendMessage {

    //交换机名称
    private final static String EXCHANGE_NAME = "exchange_rpc";
    //队列名称
    private final static String QUEUE_NAME = "queue_rpc";

    public static void main(String[] args)throws Exception {
        // 获取连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 创建通道
        final Channel channel = connection.createChannel();
        //创建交换机--先删除后增加
        channel.exchangeDelete(EXCHANGE_NAME);
        channel.exchangeDeclare(EXCHANGE_NAME, "direct", false, false, null);

        //创建队列
        channel.queueDelete(QUEUE_NAME);
        channel.queueDeclare(QUEUE_NAME, false, false, false, null);
        //绑定队列交换机
        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, "rpc");
        //此处注意：我们声明了要回复的队列。队列名称由RabbitMQ自动创建。
        //这样做的好处是：每个客户端有属于自己的唯一回复队列，生命周期同客户端
        String replyQueue = channel.queueDeclare().getQueue();
        final String corrID ="9527";

        //消息 指定回复队列和ID
        AMQP.BasicProperties.Builder builder = new AMQP.BasicProperties.Builder();
        // 指定回复队列和回复correlateId
        builder.replyTo(replyQueue).correlationId(corrID);
        AMQP.BasicProperties properties = builder.build();

        // 消息参数内容
        String message = "good good study ";

        System.out.println("rpc模型消息发送  "+message);
        channel.basicPublish(EXCHANGE_NAME, "rpc", properties, message.getBytes());

        DefaultConsumer consumer = new DefaultConsumer(channel) {
            // 监听队列中的消息，如果有消息，进行处理
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties,
                                       byte[] body) throws IOException {
                if (corrID.equals(properties.getCorrelationId())) {
                    System.out.println("9527  ID对应上的消息：" + new String(body));
                } else {
                    System.out.println("9527  ID未对应上的消息：" + new String(body));
                }
            }
        };
        channel.basicConsume(replyQueue, true, consumer);
    }
}

```

##### 1.4.4.2消费者

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.*;

import java.io.IOException;

public class RpcReceive {

    //队列名称
    private final static String QUEUE_NAME = "queue_rpc";

    public static void main(String[] args) throws Exception {
        // 获取连接
        Connection connection = RabbitmqConnectionUtil.getConnection();
        // 创建通道
        final Channel channel = connection.createChannel();

        DefaultConsumer consumer = new DefaultConsumer(channel) {
            // 监听队列中的消息，如果有消息，进行处理
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties,
                                       byte[] body) throws IOException {
                System.out.println("收到消息 执行中："+new String(body));

                AMQP.BasicProperties.Builder builder = new AMQP.BasicProperties.Builder();
                //我们在将要回复的消息属性中，放入从客户端传递过来的correlateId 关系id
                builder.correlationId(properties.getCorrelationId());
                AMQP.BasicProperties prop = builder.build();

                //发送给回复队列的消息，exchange=""，routingKey=回复队列名称
                //因为RabbitMQ对于队列，始终存在一个默认exchange=""，routingKey=队列名称的绑定关系
                String message= new String(body) + "-收到 over 一定 study";
                channel.basicPublish("", properties.getReplyTo(), prop,message.getBytes());
            }
        };
        channel.basicConsume(QUEUE_NAME, true, consumer);
    }
}

```

#### 1.4.5确认模型

> 确认模型：使用发布者确认来确保已发布的消息已安全到达代理。

先回顾一下之前的消息队列

 整个消息队列环境中都有三个角色

- 生产者
- 队列
- 消费者

 mq常见的面试题中有这样一个问题

 你的消息队列是如何防止消息丢失的? 

基于这个问题我们来研究一下,消息有可能在那个环节丢失？？

1. 生产者

   说白了就是消息没有发送成功到队列中

2. 队列

   生产者成功发送消息到队列,在消费者还没有消费消息的时候重启队列(队列中的消息是存在内存中的)

3. 消费者

   消费者没有正常获取到数据ok,三个环节都有可能发生丢失消息的情况 针对这三个环节我们可以用不同的方式解决消息丢失的问题

4. 生产者消息丢失

   使用确认模型处理

 2.队列消息丢失

 	使用消息持久化

3. 消费者消息丢失

4. 手动ACK(这个我们已经学过了)

接下来我们说一下确认模型

#### 1..4.5.1生产者

![image-20210311224541020](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311224541020.png)

```java
import com.mr.rabbitmq.utils.RabbitmqConnectionUtil;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.MessageProperties;

public class SendMessage {

    //交换机名称
    private final static String EXCHANGE_NAME = "exchange_pub";

    public static void main(String[] args) throws Exception{

        Connection connection = RabbitmqConnectionUtil.getConnection();

        Channel channel = connection.createChannel();

        //是当前的channel处于确认模式
        channel.confirmSelect();

        // 声明创建交换机exchange，指定类型为fanout
        channel.exchangeDeclare(EXCHANGE_NAME, "fanout");

        //消息内容
        String message="good good study";
        channel.basicPublish(EXCHANGE_NAME,"save",
                MessageProperties.PERSISTENT_BASIC,message.getBytes());
        //确认消息，发送完毕
        if(channel.waitForConfirms()){
            System.out.println("发送成功");
        }else{
            System.out.println("发送失败");
        }

        channel.close();
        connection.close();
    }
}

```

#### 1.4.6持久化

如何避免消息丢失？
1）消费者的ACK机制。可以防止消费者丢失消息。
2）但是，如果在消费者消费之前，MQ就宕机了，消息就没了。

是否可以将消息进行持久化呢？
要将消息持久化，前提是：队列、Exchange都持久化

#### 1.4.6.1交换机持久化

![image-20210311224738868](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311224738868.png)

#### 1.4.6.2队列持久化

![image-20210311224825726](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311224825726.png)

#### 1.4.6.3消息持久化

![image-20210311224831399](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311224831399.png)

3）：发送者也要保证发送成功，也有确认机制

4）：可以用第三方记录，例如，es myql mongo备份消息，

## 2 Spring AMQP

### 2.1依赖和配置

#### 2.1.1 pom.xml

```xml
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

#### 2.1.2 application.yml

```yml
spring:
  rabbitmq:
    host: 127.0.0.1
    username: guest
    password: guest
    port: 5672
```

### 2.2启动类

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class RunTestRabbitMqApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunTestRabbitMqApplication.class);
    }
}

```

### 2.3消费者

#### 2.3.1在com.mr.rabbitmq包下新建spring包

#### 2.3.2在spring包下新建MqListener

```java
import org.springframework.amqp.core.ExchangeTypes;
import org.springframework.amqp.rabbit.annotation.Exchange;
import org.springframework.amqp.rabbit.annotation.Queue;
import org.springframework.amqp.rabbit.annotation.QueueBinding;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

@Component//生命当前类是一个spring的组件
public class MqListener {

    @RabbitListener(
            bindings = @QueueBinding(
                    value = @Queue(
                            value = "topic_exchange_queue_1",
                            durable = "true"
                    ),
                    exchange = @Exchange(
                            value = "topic_exchange_test",
                            ignoreDeclarationExceptions = "true",
                            type = ExchangeTypes.TOPIC
                    ),
                    key = {"#.#"}
            )
    )
    public void listen(String msg){
        System.out.println("消费者接受到消息" + msg);
    }
}

```

@RabbitListener 声明这个方法是一个消费者方法 bindings 指定绑定关系，可以有多个。值是 

@QueueBinding 的数组 

@QueueBinding 绑定队列 value 这个消费者关联的队列。值是

 @Queue ，代表一个队列 value 消息队列名称 durable 是否持久化 exchange 队列所绑定的交换机，值是 

@Exchange 类型 value 交换机名称 ignoreDeclarationExceptions 忽略声明异常 type 交换机类型 队列和交换机绑定的 RoutingKey

#### 2.4 生产者

在测试包下新建com.mr.test.SendMsg

```java
import com.mr.RunTestRabbitMqApplication;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.amqp.core.AmqpTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = RunTestRabbitMqApplication.class)
public class SendMsg {

    @Autowired
    private AmqpTemplate amqpTemplate;

    @Test
    public void sendMessage() throws InterruptedException {
        String message = " good good study ";
        //amqpTemplate 发送一个消息 指定：交换机名称， routingkey 参数
        amqpTemplate.convertAndSend("topic_exchange_test","x.x",message);
        System.out.println("发送成功：ok");
        // 等待10秒为了可以看到 消费者接收到消息执行
        //Thread.sleep(10000);
    }
}

```

## 3 项目整合AMQP(rabbitmq)

### 3.1 mingrui-shop-service/pom.xml

```xml
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

### 3.2 mingrui-shop-service-xxx

#### 3.2.1 application.yml

```yml
spring:
 rabbitmq:
  host: 127.0.0.1
  port: 5672
  username: guest
  password: guest
  # 是否确认回调
  publisher-confirm-type: correlated
  # 是否返回回调
  publisher-returns: true
  virtual-host: /
  # 手动确认
  listener:
   simple:
    acknowledge-mode: manual
```

#### 3.2.1.1 common-core项目新建com.baidu.shop.constant包

#### 3.2.1.2 包下新建MqMessageConstant

```java
public class MqMessageConstant {

    //spu交换机，routingkey
    public static final String SPU_ROUT_KEY_SAVE="spu.save";
    public static final String SPU_ROUT_KEY_UPDATE="spu.update";
    public static final String SPU_ROUT_KEY_DELETE="spu.delete";

    //spu-es的队列
    public static  final String SPU_QUEUE_SEARCH_SAVE="spu_queue_es_save";
    public static  final String SPU_QUEUE_SEARCH_UPDATE="spu_queue_es_update";
    public static  final String SPU_QUEUE_SEARCH_DELETE="spu_queue_es_delete";

    //spu-page的队列
    public static  final String SPU_QUEUE_PAGE_SAVE="spu_queue_page_save";
    public static  final String SPU_QUEUE_PAGE_UPDATE="spu_queue_page_update";
    public static  final String SPU_QUEUE_PAGE_DELETE="spu_queue_page_delete";


    public static final String ALTERNATE_EXCHANGE = "exchange.ae";
    public static final String EXCHANGE = "exchange.mr";
    //Dead Letter Exchanges
    public static final String EXCHANGE_DLX = "exchange.dlx";
    public static final String EXCHANGE_DLRK = "dlx.rk";
    public static final Integer MESSAGE_TIME_OUT = 5000;
    public static final String QUEUE = "queue.mr";
    public static final String QUEUE_AE = "queue.ae";
    public static final String QUEUE_DLX = "queue.dlx";
    public static final String ROUTING_KEY = "mrkey";
}

```

### 3.2.2在mingrui-shop-service-xxx新建com.baidu.shop下新建component包

### 3.2.3在包下新建MrRabbitMQ

```java
import com.baidu.shop.constant.MqMessageConstant;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.connection.CorrelationData;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.UUID;

@Component
@Slf4j
public class MrRabbitMQ implements RabbitTemplate.ConfirmCallback, RabbitTemplate.ReturnCallback {

    private RabbitTemplate rabbitTemplate;

    @Autowired
    public MrRabbitMQ(RabbitTemplate rabbitTemplate) {
        this.rabbitTemplate = rabbitTemplate;
        rabbitTemplate.setConfirmCallback(this);
        rabbitTemplate.setMandatory(true);
        rabbitTemplate.setReturnCallback(this);
    }

    public void send(String sendMsg, String routingKey) {
        CorrelationData correlationId = new CorrelationData(UUID.randomUUID().toString());
        //convertAndSend(exchange:交换机名称,routingKey:路由关键字,object:发送的消息 内容, correlationData:消息ID)
        rabbitTemplate.convertAndSend(MqMessageConstant.EXCHANGE, routingKey, sendMsg, correlationId);
    }


    @Override
    public void confirm(CorrelationData correlationData, boolean b, String s) {
        if (b) {
            log.info("消息发送成功:correlationData({}), ack({}), cause({}) ", correlationData, b, s);
        } else {
            log.error("消息发送失败:correlationData({}), ack({}), cause({}) ", correlationData, b, s);
        }
    }

    @Override
    public void returnedMessage(Message message, int i, String s, String s1, String s2) {
        log.warn("消息丢失:exchange({}),route({}),replyCode({}),replyText({}),message:{}", s1, s2, i, s, message);
    }

}

```

### 3.2.4 GoodsServiceImpl

![image-20210311230708831](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311230708831.png)

```java
@Transactional
@Override
public Result<JSONObject> saveGoods(SpuDTO spuDTO) {
    //新增spu
    SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO,
    SpuEntity.class);
    spuEntity.setSaleable(1);
    spuEntity.setValid(1);
    final Date date = new Date();//保持两个时间一致
    spuEntity.setCreateTime(date);
    spuEntity.setLastUpdateTime(date);
    spuMapper.insertSelective(spuEntity);
    //新增spuDetail
    SpuDetailEntity spuDetailEntity =
    BaiduBeanUtil.copyProperties(spuDTO.getSpuDetail(), SpuDetailEntity.class);
    spuDetailEntity.setSpuId(spuEntity.getId());
    spuDetailMapper.insertSelective(spuDetailEntity);
    this.saveSkusAndStocks(spuDTO.getSkus(),spuEntity.getId(),date);
    mrRabbitMQ.send(spuEntity.getId() + "",
    MqMessageConstant.SPU_ROUT_KEY_SAVE);
    return this.setResultSuccess();
}
```

![image-20210311230836149](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311230836149.png)

### 3.3 mingrui-shop-service-search

#### 3.3.1 application.yml

```yml
spring:
 rabbitmq:
  host: 127.0.0.1
  port: 5672
  username: guest
  password: guest
  # 是否确认回调
  publisher-confirm-type: correlated
  # 是否返回回调
  publisher-returns: true
  virtual-host: /
  # 手动确认
  listener:
   simple:
    acknowledge-mode: manual
```

#### 3.3.2 ShopElasticsearchService

```java
@ApiOperation(value = "新增数据到es")
@PostMapping(value = "es/saveData")
Result<JSONObject> saveData(Integer spuId);

@ApiOperation(value = "通过id删除es数据")
@DeleteMapping(value = "es/saveData")
Result<JSONObject> delData(Integer spuId);

```

#### 3.3.3 ShopElasticsearchServiceImpl

![image-20210311231044262](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231044262.png)

```java
@Override
public Result<JSONObject> saveData(Integer spuId) {
    SpuDTO spuDTO = new SpuDTO();
    spuDTO.setId(spuId);
    List<GoodsDoc> goodsDocs = this.esGoodsInfo(spuDTO);
    GoodsDoc goodsDoc = goodsDocs.get(0);
    elasticsearchRestTemplate.save(goodsDoc);
    return this.setResultSuccess();
}
```

![image-20210311231114571](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231114571.png)

![image-20210311231121456](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231121456.png)

```java
@Override
public Result<JSONObject> delData(Integer spuId) {
    GoodsDoc goodsDoc = new GoodsDoc();
    goodsDoc.setId(spuId.longValue());
    elasticsearchRestTemplate.delete(goodsDoc);
    return this.setResultSuccess();
}
```

#### 3.3.4 com.baidu.shop下新建包listener

#### 3.3.5 包下新建GoodsListener

```java
package com.baidu.shop.listener;

import com.baidu.service.ShopElasticsearchService;
import com.baidu.shop.constant.MqMessageConstant;
import com.rabbitmq.client.Channel;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.core.ExchangeTypes;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.Exchange;
import org.springframework.amqp.rabbit.annotation.Queue;
import org.springframework.amqp.rabbit.annotation.QueueBinding;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.io.IOException;

@Component
@Slf4j
public class GoodsListener {

    @Autowired
    private ShopElasticsearchService shopElasticsearchService;

    @RabbitListener(
            bindings = @QueueBinding(
                    value = @Queue(
                            value = MqMessageConstant.SPU_QUEUE_SEARCH_SAVE,
                            durable = "true"
                    ),
                    exchange = @Exchange(
                            value = MqMessageConstant.EXCHANGE,
                            ignoreDeclarationExceptions = "true",
                            type = ExchangeTypes.TOPIC
                    ),
                    key = {MqMessageConstant.SPU_ROUT_KEY_SAVE, MqMessageConstant.SPU_ROUT_KEY_UPDATE}
            )
    )

    public void save(Message message, Channel channel) throws IOException {
        log.info("es服务接受到需要保存数据的消息: " + new String(message.getBody()));
        //新增数据到es
        shopElasticsearchService.saveData(Integer.parseInt(new String(message.getBody())));
        channel.basicAck(message.getMessageProperties().getDeliveryTag(), true);
    }

    @RabbitListener(
            bindings = @QueueBinding(
                    value = @Queue(
                            value = MqMessageConstant.SPU_QUEUE_SEARCH_DELETE,
                            durable = "true"
                    ),
                    exchange = @Exchange(
                            value = MqMessageConstant.EXCHANGE,
                            ignoreDeclarationExceptions = "true",
                            type = ExchangeTypes.TOPIC
                    ),
                    key = MqMessageConstant.SPU_ROUT_KEY_DELETE
            )
    )

    public void delete(Message message, Channel channel) throws IOException {
        log.info("es服务接受到需要删除数据的消息: " + new String(message.getBody()));
        //新增数据到es
        shopElasticsearchService.delData(Integer.parseInt(new String(message.getBody())));
        channel.basicAck(message.getMessageProperties().getDeliveryTag(), true);
    }

}

```

### 3.4 mingrui-shop-service-template

#### 3.4.1 application.yml

```yml
spring:
 rabbitmq:
  host: 127.0.0.1
  port: 5672
  username: guest
  password: guest
  # 是否确认回调
  publisher-confirm-type: correlated
  # 是否返回回调
  publisher-returns: true
  virtual-host: /
  # 手动确认
  listener:
   simple:
    acknowledge-mode: manual
```

### 3.4.2 TemplateService

```java
@DeleteMapping(value = "template/delHTMLBySpuId")
Result<JSONObject> delHTMLBySpuId(Integer spuId);
```

#### 3.4.3 TemplateServiceImpl

```java
@Override
public Result<JSONObject> delHTMLBySpuId(Integer spuId) {
    File file = new File(staticHTMLPath + File.separator + spuId + ".html");
    if(!file.delete()){
    return this.setResultError("文件删除失败");
    }
    return this.setResultSuccess();
}
```

#### 3.4.4 com.baidu.shop包下新建listener包

#### 3.4.5 包下新建TemplateListener

```java
package com.baidu.shop.listener;

import com.baidu.shop.constant.MqMessageConstant;
import com.baidu.shop.service.TemplateService;
import com.rabbitmq.client.Channel;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.core.ExchangeTypes;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.Exchange;
import org.springframework.amqp.rabbit.annotation.Queue;
import org.springframework.amqp.rabbit.annotation.QueueBinding;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;
import java.io.IOException;

@Component
@Slf4j
public class TemplateListener {
    
    @Resource
    private TemplateService templateService;

    @RabbitListener(
            bindings = @QueueBinding(
                    value = @Queue(
                            value = MqMessageConstant.SPU_QUEUE_PAGE_SAVE,
                            durable = "true"
                    ),
                    exchange = @Exchange(
                            value = MqMessageConstant.EXCHANGE,
                            ignoreDeclarationExceptions = "true",
                            type = ExchangeTypes.TOPIC
                    ),
                    key = {MqMessageConstant.SPU_ROUT_KEY_SAVE, MqMessageConstant.SPU_ROUT_KEY_UPDATE}
            )
    )
    public void save(Message message, Channel channel) throws IOException {
        log.info("template服务接受到需要保存数据的消息: " + new String(message.getBody()));
        templateService.createStaticHTMLTemplate(Integer.valueOf(new String(message.getBody())));
        channel.basicAck(message.getMessageProperties().getDeliveryTag(), true);
    }

    @RabbitListener(
            bindings = @QueueBinding(
                    value = @Queue(
                            value = MqMessageConstant.SPU_QUEUE_PAGE_DELETE,
                            durable = "true"
                    ),
                    exchange = @Exchange(
                            value = MqMessageConstant.EXCHANGE,
                            ignoreDeclarationExceptions = "true",
                            type = ExchangeTypes.TOPIC
                    ),
                    key = MqMessageConstant.SPU_ROUT_KEY_DELETE
            )
    )
    public void delete(Message message, Channel channel) throws IOException {

        log.info("template服务接受到需要删除数据的消息: " + new String(message.getBody()));
        templateService.deleteStaticHTMLTemplate(Integer.valueOf(new String(message.getBody())));

        channel.basicAck(message.getMessageProperties().getDeliveryTag(), true);
    }
}

```

### 3.4.6测试流程

1. 浏览器访问manage.mrshop.com 
2. 将xxx,template,search项目的控制台先清空一下,方便查看日志 
3. 新增商品

![image-20210311231732908](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231732908.png)

![image-20210311231742937](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231742937.png)

可以发现两个消费端都报错了.....

往上翻一下日志可以看到消费者已经接受到消息了

![image-20210311231803149](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231803149.png)

再仔细看一下错误日志

![image-20210311231817365](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231817365.png)

debug跟踪一下

![image-20210311231825708](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231825708.png)

可以发现确实是没有查询到数据 

这是为啥呢 

我们再从生产者发消息那块找一下看能不能发现什么信息

![image-20210311231844417](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231844417.png)

![image-20210311231907575](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231907575.png)

再看一下数据库

![image-20210311231920721](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231920721.png)

![image-20210311231929309](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231929309.png)

ok现在问题已经很明了了

现在的问题是 我新增正常执行了,但是到方法结束之前还没有进行提交事务(这个时候大家就得去复习一 下spring 的事务了)

我们现在用到了@Transactional这个注解,这个注解的作用就是帮我们提交事务

我方法没有执行完成的时候是不会提交事务的(这个时候大家还需要去复习一下JVM的虚拟机栈)

![image-20210311231955037](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311231955037.png)

也就是是说栈针出栈的时候才会提交事务, 那我们知道了,应该是我消息已经发送成功了,消费者也接受到消息了,但是你的事务还没有提交,所以在消 费端查询不到数据!!!! 知道问题出现的原因以后,我们就可以解决这个问题了

解决这个问题有好几种方式:

1. 在MrRabbitMQ这个类中使用事务监听(自己去研究)-->监听到事务已经成功提交了再发送消息 
2. 手动提交事务(自己去研究)

![image-20210311232044643](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232044643.png)

3. 拆方法

![image-20210311232103317](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232103317.png)

### 3.4 再次测试

![image-20210311232138410](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232138410.png)

![image-20210311232145498](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232145498.png)

![image-20210311232152070](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232152070.png)

既然新增有这个问题,那么修改和删除同样有这个问题,大家自己把方法拆一下就可以

### 3.6 测试删除

由于新增和修改对于es(新增和修改使用同一个函数)和生成文件(新增是创建文件,修改是覆盖文件)都是 一样的操作,所以不做修改测试,你们自己测试即可 浏览器打开http://manage.mrshop.com/删除商品

![image-20210311232247551](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232247551.png)

我们可以看到 静态文件竟然删除失败了!!!!!!!!!!!!,而且也没有报错,只是告诉我们失败了

![image-20210311232300273](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232300273.png)

我们可以尝试自己手动删一下这个文件

![image-20210311232312347](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232312347.png)

这个问题出现的原因在创建静态文件的那个方法

![image-20210311232329205](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232329205.png)

![image-20210311232347906](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232347906.png)

### 3.7 再次测试删除

![image-20210311232407204](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232407204.png)

完成

### 4 网关现在存在的问题

现在在微服务逐渐多起来的情况下会发现一个问题 我们的请求前缀也会跟着相应的多起来 后台项目请求的是api-xxx(当前请求前缀有可能还有会更多)

搜索项目请求的前缀请求的是api-search 所以我们处理一下请求前缀不统一的问题 我们将所有的请求前缀设置为api zuul/application.yml

![image-20210311232455537](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232455537.png)

```yml
zuul:
  # 路由前缀
  prefix: /api
  # 声明路由
  routes:
    xxx-server: /manage/**
    search-server: /search/**
```

修改mrshop-manage-web项目src目录下config文件

![image-20210311232539161](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232539161.png)

测试后台项目看是否可以正常使用

修改mrshop-internet-portal项目js目录下common.js

![image-20210311232558090](D:\GitHub\zhishizongjie\项目总结\typora-user-images/image-20210311232558090.png)

修改search.html的查询方法url

![image-20210311232608620](image/image-20210311232608620.png)

# 十一:用户中心

## 1-目标

完成用户注册功能

完成redis数据库搭建

完成短信发送功能

熟练使用redis

### **2**- **项目搭建**

## 2.1service-api

## 2.1.1新建mingrui-shop-service-api-user

### 2.1.2 新建包com.baidu.shop.entity

### 2.1.3 包下新建UserEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;


@Table(name = "tb_user")
@Data
public class UserEntity {

    @Id
    private Integer id;

    private String username;

    private String password;

    private String phone;

    private Date created;

    private String salt;


}
```

### 2.1.4 新建包com.baidu.shop.dto

### 2.1.5 包下新建UserDTO

```java
package com.baidu.shop.dto;

import com.baidu.shop.validata.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotNull;
import java.util.Date;


@Data
@ApiModel(value = "用户DTO")
public class UserDTO {

    @ApiModelProperty(value = "用户主键", example = "1")
    @NotNull(message = "主键不能为空", groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "账户")
    @NotNull(message = "账户不能为空", groups = {MingruiOperation.Add.class})
    private String username;

    @ApiModelProperty(value = "密码")
    @NotNull(message = "密码不能为空", groups = {MingruiOperation.Add.class})
    private String password;

    @ApiModelProperty(value = "手机号")
    @NotNull(message = "手机号不能为空", groups = {MingruiOperation.Add.class})
    private String phone;

    private Date created;

    private String salt;

}


```

### 2.1.6 新建包com.baidu.shop.config

### 2.1.7 新建MrSwagger2Config

```java
package com.baidu.shop.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;


@Configuration
@EnableSwagger2
public class MrSwagger2Config {

    @Bean
    public Docket createRestApi(){
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(this.apiInfo())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.baidu"))
                .paths(PathSelectors.any())
                .build();
    }

    private ApiInfo apiInfo(){
        return new ApiInfoBuilder()
                //标题
                .title("明瑞SWAGGER2标题")
                //条款地址
                .termsOfServiceUrl("http://www.baidu.com")
                //联系方式-->有String参数的方法但是已经过时，所以不推荐使用
                .contact(new Contact("wangyue","baidu.com","wangyuealimee@163.com"))
                //版本
                .version("v1.0")
                //项目描述
                .description("描述")
                //创建API基本信息
                .build();
    }

}

```



### 2.1.8 新建包com.baidu.shop.service

### 2.1.9 新建UserService

```java

@Api(tags = "用户接口")
public interface UserService {


    @ApiOperation(value = "用户注册")
    @PostMapping(value = "user/register")
    Result<JSONObject> register(@RequestBody UserDTO userDTO);

}

```

## 2.2 common-core

### 2.2.1 utils包下新建BCryptUtil

```java
package com.baidu.shop.utils;

import java.io.UnsupportedEncodingException;
import java.security.SecureRandom;



public class BCryptUtil {

    // BCrypt parameters
    private static final int GENSALT_DEFAULT_LOG2_ROUNDS = 10;
    private static final int BCRYPT_SALT_LEN = 16;
    // Blowfish parameters
    private static final int BLOWFISH_NUM_ROUNDS = 16;
    // Initial contents of key schedule
    private static final int P_orig[] = {
            0x243f6a88, 0x85a308d3, 0x13198a2e, 0x03707344,
            0xa4093822, 0x299f31d0, 0x082efa98, 0xec4e6c89,
            0x452821e6, 0x38d01377, 0xbe5466cf, 0x34e90c6c,
            0xc0ac29b7, 0xc97c50dd, 0x3f84d5b5, 0xb5470917,
            0x9216d5d9, 0x8979fb1b
    };
    private static final int S_orig[] = {
            0xd1310ba6, 0x98dfb5ac, 0x2ffd72db, 0xd01adfb7,
            0xb8e1afed, 0x6a267e96, 0xba7c9045, 0xf12c7f99,
            0x24a19947, 0xb3916cf7, 0x0801f2e2, 0x858efc16,
            0x636920d8, 0x71574e69, 0xa458fea3, 0xf4933d7e,
            0x0d95748f, 0x728eb658, 0x718bcd58, 0x82154aee,
            0x7b54a41d, 0xc25a59b5, 0x9c30d539, 0x2af26013,
            0xc5d1b023, 0x286085f0, 0xca417918, 0xb8db38ef,
            0x8e79dcb0, 0x603a180e, 0x6c9e0e8b, 0xb01e8a3e,
            0xd71577c1, 0xbd314b27, 0x78af2fda, 0x55605c60,
            0xe65525f3, 0xaa55ab94, 0x57489862, 0x63e81440,
            0x55ca396a, 0x2aab10b6, 0xb4cc5c34, 0x1141e8ce,
            0xa15486af, 0x7c72e993, 0xb3ee1411, 0x636fbc2a,
            0x2ba9c55d, 0x741831f6, 0xce5c3e16, 0x9b87931e,
            0xafd6ba33, 0x6c24cf5c, 0x7a325381, 0x28958677,
            0x3b8f4898, 0x6b4bb9af, 0xc4bfe81b, 0x66282193,
            0x61d809cc, 0xfb21a991, 0x487cac60, 0x5dec8032,
            0xef845d5d, 0xe98575b1, 0xdc262302, 0xeb651b88,
            0x23893e81, 0xd396acc5, 0x0f6d6ff3, 0x83f44239,
            0x2e0b4482, 0xa4842004, 0x69c8f04a, 0x9e1f9b5e,
            0x21c66842, 0xf6e96c9a, 0x670c9c61, 0xabd388f0,
            0x6a51a0d2, 0xd8542f68, 0x960fa728, 0xab5133a3,
            0x6eef0b6c, 0x137a3be4, 0xba3bf050, 0x7efb2a98,
            0xa1f1651d, 0x39af0176, 0x66ca593e, 0x82430e88,
            0x8cee8619, 0x456f9fb4, 0x7d84a5c3, 0x3b8b5ebe,
            0xe06f75d8, 0x85c12073, 0x401a449f, 0x56c16aa6,
            0x4ed3aa62, 0x363f7706, 0x1bfedf72, 0x429b023d,
            0x37d0d724, 0xd00a1248, 0xdb0fead3, 0x49f1c09b,
            0x075372c9, 0x80991b7b, 0x25d479d8, 0xf6e8def7,
            0xe3fe501a, 0xb6794c3b, 0x976ce0bd, 0x04c006ba,
            0xc1a94fb6, 0x409f60c4, 0x5e5c9ec2, 0x196a2463,
            0x68fb6faf, 0x3e6c53b5, 0x1339b2eb, 0x3b52ec6f,
            0x6dfc511f, 0x9b30952c, 0xcc814544, 0xaf5ebd09,
            0xbee3d004, 0xde334afd, 0x660f2807, 0x192e4bb3,
            0xc0cba857, 0x45c8740f, 0xd20b5f39, 0xb9d3fbdb,
            0x5579c0bd, 0x1a60320a, 0xd6a100c6, 0x402c7279,
            0x679f25fe, 0xfb1fa3cc, 0x8ea5e9f8, 0xdb3222f8,
            0x3c7516df, 0xfd616b15, 0x2f501ec8, 0xad0552ab,
            0x323db5fa, 0xfd238760, 0x53317b48, 0x3e00df82,
            0x9e5c57bb, 0xca6f8ca0, 0x1a87562e, 0xdf1769db,
            0xd542a8f6, 0x287effc3, 0xac6732c6, 0x8c4f5573,
            0x695b27b0, 0xbbca58c8, 0xe1ffa35d, 0xb8f011a0,
            0x10fa3d98, 0xfd2183b8, 0x4afcb56c, 0x2dd1d35b,
            0x9a53e479, 0xb6f84565, 0xd28e49bc, 0x4bfb9790,
            0xe1ddf2da, 0xa4cb7e33, 0x62fb1341, 0xcee4c6e8,
            0xef20cada, 0x36774c01, 0xd07e9efe, 0x2bf11fb4,
            0x95dbda4d, 0xae909198, 0xeaad8e71, 0x6b93d5a0,
            0xd08ed1d0, 0xafc725e0, 0x8e3c5b2f, 0x8e7594b7,
            0x8ff6e2fb, 0xf2122b64, 0x8888b812, 0x900df01c,
            0x4fad5ea0, 0x688fc31c, 0xd1cff191, 0xb3a8c1ad,
            0x2f2f2218, 0xbe0e1777, 0xea752dfe, 0x8b021fa1,
            0xe5a0cc0f, 0xb56f74e8, 0x18acf3d6, 0xce89e299,
            0xb4a84fe0, 0xfd13e0b7, 0x7cc43b81, 0xd2ada8d9,
            0x165fa266, 0x80957705, 0x93cc7314, 0x211a1477,
            0xe6ad2065, 0x77b5fa86, 0xc75442f5, 0xfb9d35cf,
            0xebcdaf0c, 0x7b3e89a0, 0xd6411bd3, 0xae1e7e49,
            0x00250e2d, 0x2071b35e, 0x226800bb, 0x57b8e0af,
            0x2464369b, 0xf009b91e, 0x5563911d, 0x59dfa6aa,
            0x78c14389, 0xd95a537f, 0x207d5ba2, 0x02e5b9c5,
            0x83260376, 0x6295cfa9, 0x11c81968, 0x4e734a41,
            0xb3472dca, 0x7b14a94a, 0x1b510052, 0x9a532915,
            0xd60f573f, 0xbc9bc6e4, 0x2b60a476, 0x81e67400,
            0x08ba6fb5, 0x571be91f, 0xf296ec6b, 0x2a0dd915,
            0xb6636521, 0xe7b9f9b6, 0xff34052e, 0xc5855664,
            0x53b02d5d, 0xa99f8fa1, 0x08ba4799, 0x6e85076a,
            0x4b7a70e9, 0xb5b32944, 0xdb75092e, 0xc4192623,
            0xad6ea6b0, 0x49a7df7d, 0x9cee60b8, 0x8fedb266,
            0xecaa8c71, 0x699a17ff, 0x5664526c, 0xc2b19ee1,
            0x193602a5, 0x75094c29, 0xa0591340, 0xe4183a3e,
            0x3f54989a, 0x5b429d65, 0x6b8fe4d6, 0x99f73fd6,
            0xa1d29c07, 0xefe830f5, 0x4d2d38e6, 0xf0255dc1,
            0x4cdd2086, 0x8470eb26, 0x6382e9c6, 0x021ecc5e,
            0x09686b3f, 0x3ebaefc9, 0x3c971814, 0x6b6a70a1,
            0x687f3584, 0x52a0e286, 0xb79c5305, 0xaa500737,
            0x3e07841c, 0x7fdeae5c, 0x8e7d44ec, 0x5716f2b8,
            0xb03ada37, 0xf0500c0d, 0xf01c1f04, 0x0200b3ff,
            0xae0cf51a, 0x3cb574b2, 0x25837a58, 0xdc0921bd,
            0xd19113f9, 0x7ca92ff6, 0x94324773, 0x22f54701,
            0x3ae5e581, 0x37c2dadc, 0xc8b57634, 0x9af3dda7,
            0xa9446146, 0x0fd0030e, 0xecc8c73e, 0xa4751e41,
            0xe238cd99, 0x3bea0e2f, 0x3280bba1, 0x183eb331,
            0x4e548b38, 0x4f6db908, 0x6f420d03, 0xf60a04bf,
            0x2cb81290, 0x24977c79, 0x5679b072, 0xbcaf89af,
            0xde9a771f, 0xd9930810, 0xb38bae12, 0xdccf3f2e,
            0x5512721f, 0x2e6b7124, 0x501adde6, 0x9f84cd87,
            0x7a584718, 0x7408da17, 0xbc9f9abc, 0xe94b7d8c,
            0xec7aec3a, 0xdb851dfa, 0x63094366, 0xc464c3d2,
            0xef1c1847, 0x3215d908, 0xdd433b37, 0x24c2ba16,
            0x12a14d43, 0x2a65c451, 0x50940002, 0x133ae4dd,
            0x71dff89e, 0x10314e55, 0x81ac77d6, 0x5f11199b,
            0x043556f1, 0xd7a3c76b, 0x3c11183b, 0x5924a509,
            0xf28fe6ed, 0x97f1fbfa, 0x9ebabf2c, 0x1e153c6e,
            0x86e34570, 0xeae96fb1, 0x860e5e0a, 0x5a3e2ab3,
            0x771fe71c, 0x4e3d06fa, 0x2965dcb9, 0x99e71d0f,
            0x803e89d6, 0x5266c825, 0x2e4cc978, 0x9c10b36a,
            0xc6150eba, 0x94e2ea78, 0xa5fc3c53, 0x1e0a2df4,
            0xf2f74ea7, 0x361d2b3d, 0x1939260f, 0x19c27960,
            0x5223a708, 0xf71312b6, 0xebadfe6e, 0xeac31f66,
            0xe3bc4595, 0xa67bc883, 0xb17f37d1, 0x018cff28,
            0xc332ddef, 0xbe6c5aa5, 0x65582185, 0x68ab9802,
            0xeecea50f, 0xdb2f953b, 0x2aef7dad, 0x5b6e2f84,
            0x1521b628, 0x29076170, 0xecdd4775, 0x619f1510,
            0x13cca830, 0xeb61bd96, 0x0334fe1e, 0xaa0363cf,
            0xb5735c90, 0x4c70a239, 0xd59e9e0b, 0xcbaade14,
            0xeecc86bc, 0x60622ca7, 0x9cab5cab, 0xb2f3846e,
            0x648b1eaf, 0x19bdf0ca, 0xa02369b9, 0x655abb50,
            0x40685a32, 0x3c2ab4b3, 0x319ee9d5, 0xc021b8f7,
            0x9b540b19, 0x875fa099, 0x95f7997e, 0x623d7da8,
            0xf837889a, 0x97e32d77, 0x11ed935f, 0x16681281,
            0x0e358829, 0xc7e61fd6, 0x96dedfa1, 0x7858ba99,
            0x57f584a5, 0x1b227263, 0x9b83c3ff, 0x1ac24696,
            0xcdb30aeb, 0x532e3054, 0x8fd948e4, 0x6dbc3128,
            0x58ebf2ef, 0x34c6ffea, 0xfe28ed61, 0xee7c3c73,
            0x5d4a14d9, 0xe864b7e3, 0x42105d14, 0x203e13e0,
            0x45eee2b6, 0xa3aaabea, 0xdb6c4f15, 0xfacb4fd0,
            0xc742f442, 0xef6abbb5, 0x654f3b1d, 0x41cd2105,
            0xd81e799e, 0x86854dc7, 0xe44b476a, 0x3d816250,
            0xcf62a1f2, 0x5b8d2646, 0xfc8883a0, 0xc1c7b6a3,
            0x7f1524c3, 0x69cb7492, 0x47848a0b, 0x5692b285,
            0x095bbf00, 0xad19489d, 0x1462b174, 0x23820e00,
            0x58428d2a, 0x0c55f5ea, 0x1dadf43e, 0x233f7061,
            0x3372f092, 0x8d937e41, 0xd65fecf1, 0x6c223bdb,
            0x7cde3759, 0xcbee7460, 0x4085f2a7, 0xce77326e,
            0xa6078084, 0x19f8509e, 0xe8efd855, 0x61d99735,
            0xa969a7aa, 0xc50c06c2, 0x5a04abfc, 0x800bcadc,
            0x9e447a2e, 0xc3453484, 0xfdd56705, 0x0e1e9ec9,
            0xdb73dbd3, 0x105588cd, 0x675fda79, 0xe3674340,
            0xc5c43465, 0x713e38d8, 0x3d28f89e, 0xf16dff20,
            0x153e21e7, 0x8fb03d4a, 0xe6e39f2b, 0xdb83adf7,
            0xe93d5a68, 0x948140f7, 0xf64c261c, 0x94692934,
            0x411520f7, 0x7602d4f7, 0xbcf46b2e, 0xd4a20068,
            0xd4082471, 0x3320f46a, 0x43b7d4b7, 0x500061af,
            0x1e39f62e, 0x97244546, 0x14214f74, 0xbf8b8840,
            0x4d95fc1d, 0x96b591af, 0x70f4ddd3, 0x66a02f45,
            0xbfbc09ec, 0x03bd9785, 0x7fac6dd0, 0x31cb8504,
            0x96eb27b3, 0x55fd3941, 0xda2547e6, 0xabca0a9a,
            0x28507825, 0x530429f4, 0x0a2c86da, 0xe9b66dfb,
            0x68dc1462, 0xd7486900, 0x680ec0a4, 0x27a18dee,
            0x4f3ffea2, 0xe887ad8c, 0xb58ce006, 0x7af4d6b6,
            0xaace1e7c, 0xd3375fec, 0xce78a399, 0x406b2a42,
            0x20fe9e35, 0xd9f385b9, 0xee39d7ab, 0x3b124e8b,
            0x1dc9faf7, 0x4b6d1856, 0x26a36631, 0xeae397b2,
            0x3a6efa74, 0xdd5b4332, 0x6841e7f7, 0xca7820fb,
            0xfb0af54e, 0xd8feb397, 0x454056ac, 0xba489527,
            0x55533a3a, 0x20838d87, 0xfe6ba9b7, 0xd096954b,
            0x55a867bc, 0xa1159a58, 0xcca92963, 0x99e1db33,
            0xa62a4a56, 0x3f3125f9, 0x5ef47e1c, 0x9029317c,
            0xfdf8e802, 0x04272f70, 0x80bb155c, 0x05282ce3,
            0x95c11548, 0xe4c66d22, 0x48c1133f, 0xc70f86dc,
            0x07f9c9ee, 0x41041f0f, 0x404779a4, 0x5d886e17,
            0x325f51eb, 0xd59bc0d1, 0xf2bcc18f, 0x41113564,
            0x257b7834, 0x602a9c60, 0xdff8e8a3, 0x1f636c1b,
            0x0e12b4c2, 0x02e1329e, 0xaf664fd1, 0xcad18115,
            0x6b2395e0, 0x333e92e1, 0x3b240b62, 0xeebeb922,
            0x85b2a20e, 0xe6ba0d99, 0xde720c8c, 0x2da2f728,
            0xd0127845, 0x95b794fd, 0x647d0862, 0xe7ccf5f0,
            0x5449a36f, 0x877d48fa, 0xc39dfd27, 0xf33e8d1e,
            0x0a476341, 0x992eff74, 0x3a6f6eab, 0xf4f8fd37,
            0xa812dc60, 0xa1ebddf8, 0x991be14c, 0xdb6e6b0d,
            0xc67b5510, 0x6d672c37, 0x2765d43b, 0xdcd0e804,
            0xf1290dc7, 0xcc00ffa3, 0xb5390f92, 0x690fed0b,
            0x667b9ffb, 0xcedb7d9c, 0xa091cf0b, 0xd9155ea3,
            0xbb132f88, 0x515bad24, 0x7b9479bf, 0x763bd6eb,
            0x37392eb3, 0xcc115979, 0x8026e297, 0xf42e312d,
            0x6842ada7, 0xc66a2b3b, 0x12754ccc, 0x782ef11c,
            0x6a124237, 0xb79251e7, 0x06a1bbe6, 0x4bfb6350,
            0x1a6b1018, 0x11caedfa, 0x3d25bdd8, 0xe2e1c3c9,
            0x44421659, 0x0a121386, 0xd90cec6e, 0xd5abea2a,
            0x64af674e, 0xda86a85f, 0xbebfe988, 0x64e4c3fe,
            0x9dbc8057, 0xf0f7c086, 0x60787bf8, 0x6003604d,
            0xd1fd8346, 0xf6381fb0, 0x7745ae04, 0xd736fccc,
            0x83426b33, 0xf01eab71, 0xb0804187, 0x3c005e5f,
            0x77a057be, 0xbde8ae24, 0x55464299, 0xbf582e61,
            0x4e58f48f, 0xf2ddfda2, 0xf474ef38, 0x8789bdc2,
            0x5366f9c3, 0xc8b38e74, 0xb475f255, 0x46fcd9b9,
            0x7aeb2661, 0x8b1ddf84, 0x846a0e79, 0x915f95e2,
            0x466e598e, 0x20b45770, 0x8cd55591, 0xc902de4c,
            0xb90bace1, 0xbb8205d0, 0x11a86248, 0x7574a99e,
            0xb77f19b6, 0xe0a9dc09, 0x662d09a1, 0xc4324633,
            0xe85a1f02, 0x09f0be8c, 0x4a99a025, 0x1d6efe10,
            0x1ab93d1d, 0x0ba5a4df, 0xa186f20f, 0x2868f169,
            0xdcb7da83, 0x573906fe, 0xa1e2ce9b, 0x4fcd7f52,
            0x50115e01, 0xa70683fa, 0xa002b5c4, 0x0de6d027,
            0x9af88c27, 0x773f8641, 0xc3604c06, 0x61a806b5,
            0xf0177a28, 0xc0f586e0, 0x006058aa, 0x30dc7d62,
            0x11e69ed7, 0x2338ea63, 0x53c2dd94, 0xc2c21634,
            0xbbcbee56, 0x90bcb6de, 0xebfc7da1, 0xce591d76,
            0x6f05e409, 0x4b7c0188, 0x39720a3d, 0x7c927c24,
            0x86e3725f, 0x724d9db9, 0x1ac15bb4, 0xd39eb8fc,
            0xed545578, 0x08fca5b5, 0xd83d7cd3, 0x4dad0fc4,
            0x1e50ef5e, 0xb161e6f8, 0xa28514d9, 0x6c51133c,
            0x6fd5c7e7, 0x56e14ec4, 0x362abfce, 0xddc6c837,
            0xd79a3234, 0x92638212, 0x670efa8e, 0x406000e0,
            0x3a39ce37, 0xd3faf5cf, 0xabc27737, 0x5ac52d1b,
            0x5cb0679e, 0x4fa33742, 0xd3822740, 0x99bc9bbe,
            0xd5118e9d, 0xbf0f7315, 0xd62d1c7e, 0xc700c47b,
            0xb78c1b6b, 0x21a19045, 0xb26eb1be, 0x6a366eb4,
            0x5748ab2f, 0xbc946e79, 0xc6a376d2, 0x6549c2c8,
            0x530ff8ee, 0x468dde7d, 0xd5730a1d, 0x4cd04dc6,
            0x2939bbdb, 0xa9ba4650, 0xac9526e8, 0xbe5ee304,
            0xa1fad5f0, 0x6a2d519a, 0x63ef8ce2, 0x9a86ee22,
            0xc089c2b8, 0x43242ef6, 0xa51e03aa, 0x9cf2d0a4,
            0x83c061ba, 0x9be96a4d, 0x8fe51550, 0xba645bd6,
            0x2826a2f9, 0xa73a3ae1, 0x4ba99586, 0xef5562e9,
            0xc72fefd3, 0xf752f7da, 0x3f046f69, 0x77fa0a59,
            0x80e4a915, 0x87b08601, 0x9b09e6ad, 0x3b3ee593,
            0xe990fd5a, 0x9e34d797, 0x2cf0b7d9, 0x022b8b51,
            0x96d5ac3a, 0x017da67d, 0xd1cf3ed6, 0x7c7d2d28,
            0x1f9f25cf, 0xadf2b89b, 0x5ad6b472, 0x5a88f54c,
            0xe029ac71, 0xe019a5e6, 0x47b0acfd, 0xed93fa9b,
            0xe8d3c48d, 0x283b57cc, 0xf8d56629, 0x79132e28,
            0x785f0191, 0xed756055, 0xf7960e44, 0xe3d35e8c,
            0x15056dd4, 0x88f46dba, 0x03a16125, 0x0564f0bd,
            0xc3eb9e15, 0x3c9057a2, 0x97271aec, 0xa93a072a,
            0x1b3f6d9b, 0x1e6321f5, 0xf59c66fb, 0x26dcf319,
            0x7533d928, 0xb155fdf5, 0x03563482, 0x8aba3cbb,
            0x28517711, 0xc20ad9f8, 0xabcc5167, 0xccad925f,
            0x4de81751, 0x3830dc8e, 0x379d5862, 0x9320f991,
            0xea7a90c2, 0xfb3e7bce, 0x5121ce64, 0x774fbe32,
            0xa8b6e37e, 0xc3293d46, 0x48de5369, 0x6413e680,
            0xa2ae0810, 0xdd6db224, 0x69852dfd, 0x09072166,
            0xb39a460a, 0x6445c0dd, 0x586cdecf, 0x1c20c8ae,
            0x5bbef7dd, 0x1b588d40, 0xccd2017f, 0x6bb4e3bb,
            0xdda26a7e, 0x3a59ff45, 0x3e350a44, 0xbcb4cdd5,
            0x72eacea8, 0xfa6484bb, 0x8d6612ae, 0xbf3c6f47,
            0xd29be463, 0x542f5d9e, 0xaec2771b, 0xf64e6370,
            0x740e0d8d, 0xe75b1357, 0xf8721671, 0xaf537d5d,
            0x4040cb08, 0x4eb4e2cc, 0x34d2466a, 0x0115af84,
            0xe1b00428, 0x95983a1d, 0x06b89fb4, 0xce6ea048,
            0x6f3f3b82, 0x3520ab82, 0x011a1d4b, 0x277227f8,
            0x611560b1, 0xe7933fdc, 0xbb3a792b, 0x344525bd,
            0xa08839e1, 0x51ce794b, 0x2f32c9b7, 0xa01fbac9,
            0xe01cc87e, 0xbcc7d1f6, 0xcf0111c3, 0xa1e8aac7,
            0x1a908749, 0xd44fbd9a, 0xd0dadecb, 0xd50ada38,
            0x0339c32a, 0xc6913667, 0x8df9317c, 0xe0b12b4f,
            0xf79e59b7, 0x43f5bb3a, 0xf2d519ff, 0x27d9459c,
            0xbf97222c, 0x15e6fc2a, 0x0f91fc71, 0x9b941525,
            0xfae59361, 0xceb69ceb, 0xc2a86459, 0x12baa8d1,
            0xb6c1075e, 0xe3056a0c, 0x10d25065, 0xcb03a442,
            0xe0ec6e0e, 0x1698db3b, 0x4c98a0be, 0x3278e964,
            0x9f1f9532, 0xe0d392df, 0xd3a0342b, 0x8971f21e,
            0x1b0a7441, 0x4ba3348c, 0xc5be7120, 0xc37632d8,
            0xdf359f8d, 0x9b992f2e, 0xe60b6f47, 0x0fe3f11d,
            0xe54cda54, 0x1edad891, 0xce6279cf, 0xcd3e7e6f,
            0x1618b166, 0xfd2c1d05, 0x848fd2c5, 0xf6fb2299,
            0xf523f357, 0xa6327623, 0x93a83531, 0x56cccd02,
            0xacf08162, 0x5a75ebb5, 0x6e163697, 0x88d273cc,
            0xde966292, 0x81b949d0, 0x4c50901b, 0x71c65614,
            0xe6c6c7bd, 0x327a140a, 0x45e1d006, 0xc3f27b9a,
            0xc9aa53fd, 0x62a80f00, 0xbb25bfe2, 0x35bdd2f6,
            0x71126905, 0xb2040222, 0xb6cbcf7c, 0xcd769c2b,
            0x53113ec0, 0x1640e3d3, 0x38abbd60, 0x2547adf0,
            0xba38209c, 0xf746ce76, 0x77afa1c5, 0x20756060,
            0x85cbfe4e, 0x8ae88dd8, 0x7aaaf9b0, 0x4cf9aa7e,
            0x1948c25c, 0x02fb8a8c, 0x01c36ae4, 0xd6ebe1f9,
            0x90d4f869, 0xa65cdea0, 0x3f09252d, 0xc208e69f,
            0xb74e6132, 0xce77e25b, 0x578fdfe3, 0x3ac372e6
    };
    // bcrypt IV: "OrpheanBeholderScryDoubt". The C implementation calls
// this "ciphertext", but it is really plaintext or an IV. We keep
// the name to make code comparison easier.
    static private final int bf_crypt_ciphertext[] = {
            0x4f727068, 0x65616e42, 0x65686f6c,
            0x64657253, 0x63727944, 0x6f756274
    };
    // Table for Base64 encoding
    static private final char base64_code[] = {
            '.', '/', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J',
            'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V',
            'W', 'X', 'Y', 'Z', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h',
            'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't',
            'u', 'v', 'w', 'x', 'y', 'z', '0', '1', '2', '3', '4', '5',
            '6', '7', '8', '9'
    };
    // Table for Base64 decoding
    static private final byte index_64[] = {
            -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
            -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
            -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
            -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
            -1, -1, -1, -1, -1, -1, 0, 1, 54, 55,
            56, 57, 58, 59, 60, 61, 62, 63, -1, -1,
            -1, -1, -1, -1, -1, 2, 3, 4, 5, 6,
            7, 8, 9, 10, 11, 12, 13, 14, 15, 16,
            17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27,
            -1, -1, -1, -1, -1, -1, 28, 29, 30,
            31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
            41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
            51, 52, 53, -1, -1, -1, -1, -1
    };
    // Expanded Blowfish key
    private int P[];
    private int S[];
    /**
     * Encode a byte array using bcrypt's slightly-modified base64
     * encoding scheme. Note that this is *not* compatible with
     * the standard MIME-base64 encoding.
     *
     * @param d the byte array to encode
     * @param len the number of bytes to encode
     * @return base64-encoded string
     * @exception IllegalArgumentException if the length is invalid
     */
    private static String encode_base64(byte d[], int len)
            throws IllegalArgumentException {
        int off = 0;
        StringBuffer rs = new StringBuffer();
        int c1, c2;
        if (len <= 0 || len > d.length) {
            throw new IllegalArgumentException("Invalid len");
        }
        while (off < len) {
            c1 = d[off++] & 0xff;
            rs.append(base64_code[(c1 >> 2) & 0x3f]);
            c1 = (c1 & 0x03) << 4;
            if (off >= len) {
                rs.append(base64_code[c1 & 0x3f]);
                break;
            }
            c2 = d[off++] & 0xff;
            c1 |= (c2 >> 4) & 0x0f;
            rs.append(base64_code[c1 & 0x3f]);
            c1 = (c2 & 0x0f) << 2;
            if (off >= len) {
                rs.append(base64_code[c1 & 0x3f]);
                break;
            }
            c2 = d[off++] & 0xff;
            c1 |= (c2 >> 6) & 0x03;
            rs.append(base64_code[c1 & 0x3f]);
            rs.append(base64_code[c2 & 0x3f]);
        }
        return rs.toString();
    }
    /**
     * Look up the 3 bits base64-encoded by the specified character,
     * range-checking againt conversion table
     * @param x the base64-encoded value
     * @return the decoded value of x
     */
    private static byte char64(char x) {
        if ((int)x < 0 || (int)x > index_64.length) {
            return -1;
        }
        return index_64[(int)x];
    }
    /**
     * Decode a string encoded using bcrypt's base64 scheme to a
     * byte array. Note that this is *not* compatible with
     * the standard MIME-base64 encoding.
     * @param s the string to decode
     * @param maxolen the maximum number of bytes to decode
     * @return an array containing the decoded bytes
     * @throws IllegalArgumentException if maxolen is invalid
     */
    private static byte[] decode_base64(String s, int maxolen)
            throws IllegalArgumentException {
        StringBuffer rs = new StringBuffer();
        int off = 0, slen = s.length(), olen = 0;
        byte ret[];
        byte c1, c2, c3, c4, o;
        if (maxolen <= 0) {
            throw new IllegalArgumentException("Invalid maxolen");
        }
        while (off < slen - 1 && olen < maxolen) {
            c1 = char64(s.charAt(off++));
            c2 = char64(s.charAt(off++));
            if (c1 == -1 || c2 == -1) {
                break;
            }
            o = (byte)(c1 << 2);
            o |= (c2 & 0x30) >> 4;
            rs.append((char)o);
            if (++olen >= maxolen || off >= slen) {
                break;
            }
            c3 = char64(s.charAt(off++));
            if (c3 == -1) {
                break;
            }
            o = (byte)((c2 & 0x0f) << 4);
            o |= (c3 & 0x3c) >> 2;
            rs.append((char)o);
            if (++olen >= maxolen || off >= slen) {
                break;
            }
            c4 = char64(s.charAt(off++));
            o = (byte)((c3 & 0x03) << 6);
            o |= c4;
            rs.append((char)o);
            ++olen;
        }
        ret = new byte[olen];
        for (off = 0; off < olen; off++) {
            ret[off] = (byte) rs.charAt(off);
        }
        return ret;
    }
    /**
     * Blowfish encipher a single 64-bit block encoded as
     * two 32-bit halves
     * @param lr an array containing the two 32-bit half blocks
     * @param off the position in the array of the blocks
     */
    private final void encipher(int lr[], int off) {
        int i, n, l = lr[off], r = lr[off + 1];
        l ^= P[0];
        for (i = 0; i <= BLOWFISH_NUM_ROUNDS - 2;) {
// Feistel substitution on left word
            n = S[(l >> 24) & 0xff];
            n += S[0x100 | ((l >> 16) & 0xff)];
            n ^= S[0x200 | ((l >> 8) & 0xff)];
            n += S[0x300 | (l & 0xff)];
            r ^= n ^ P[++i];
// Feistel substitution on right word
            n = S[(r >> 24) & 0xff];
            n += S[0x100 | ((r >> 16) & 0xff)];
            n ^= S[0x200 | ((r >> 8) & 0xff)];
            n += S[0x300 | (r & 0xff)];
            l ^= n ^ P[++i];
        }
        lr[off] = r ^ P[BLOWFISH_NUM_ROUNDS + 1];
        lr[off + 1] = l;
    }
    /**
     * Cycically extract a word of key material
     * @param data the string to extract the data from
     * @param offp a "pointer" (as a one-entry array) to the
     * current offset into data
     * @return the next word of material from data
     */
    private static int streamtoword(byte data[], int offp[]) {
        int i;
        int word = 0;
        int off = offp[0];
        for (i = 0; i < 4; i++) {
            word = (word << 8) | (data[off] & 0xff);
            off = (off + 1) % data.length;
        }
        offp[0] = off;
        return word;
    }
    /**
     * Initialise the Blowfish key schedule
     */
    private void init_key() {
        P = (int[])P_orig.clone();
        S = (int[])S_orig.clone();
    }
    /**
     * Key the Blowfish cipher
     * @param key an array containing the key
     */
    private void key(byte key[]) {
        int i;
        int koffp[] = { 0 };
        int lr[] = { 0, 0 };
        int plen = P.length, slen = S.length;
        for (i = 0; i < plen; i++) {
            P[i] = P[i] ^ streamtoword(key, koffp);
        }
        for (i = 0; i < plen; i += 2) {
            encipher(lr, 0);
            P[i] = lr[0];
            P[i + 1] = lr[1];
        }
        for (i = 0; i < slen; i += 2) {
            encipher(lr, 0);
            S[i] = lr[0];
            S[i + 1] = lr[1];
        }
    }
    /**
     * Perform the "enhanced key schedule" step described by
     * Provos and Mazieres in "A Future-Adaptable Password Scheme"
     * http://www.openbsd.org/papers/bcrypt-paper.ps
     * @param data salt information
     * @param key password information
     */
    private void ekskey(byte data[], byte key[]) {
        int i;
        int koffp[] = { 0 }, doffp[] = { 0 };
        int lr[] = { 0, 0 };
        int plen = P.length, slen = S.length;
        for (i = 0; i < plen; i++) {
            P[i] = P[i] ^ streamtoword(key, koffp);
        }
        for (i = 0; i < plen; i += 2) {
            lr[0] ^= streamtoword(data, doffp);
            lr[1] ^= streamtoword(data, doffp);
            encipher(lr, 0);
            P[i] = lr[0];
            P[i + 1] = lr[1];
        }
        for (i = 0; i < slen; i += 2) {
            lr[0] ^= streamtoword(data, doffp);
            lr[1] ^= streamtoword(data, doffp);
            encipher(lr, 0);
            S[i] = lr[0];
            S[i + 1] = lr[1];
        }
    }
    /**
     * Perform the central password hashing step in the
     * bcrypt scheme
     * @param password the password to hash
     * @param salt the binary salt to hash with the password
     * @param log_rounds the binary logarithm of the number
     * of rounds of hashing to apply
     * @param cdata the plaintext to encrypt
     * @return an array containing the binary hashed password
     */
    public byte[] crypt_raw(byte password[], byte salt[], int log_rounds,
                            int cdata[]) {
        int rounds, i, j;
        int clen = cdata.length;
        byte ret[];
        if (log_rounds < 4 || log_rounds > 30) {
            throw new IllegalArgumentException("Bad number of rounds");
        }
        rounds = 1 << log_rounds;
        if (salt.length != BCRYPT_SALT_LEN) {
            throw new IllegalArgumentException("Bad salt length");
        }
        init_key();
        ekskey(salt, password);
        for (i = 0; i != rounds; i++) {
            key(password);
            key(salt);
        }
        for (i = 0; i < 64; i++) {
            for (j = 0; j < (clen >> 1); j++) {
                encipher(cdata, j << 1);
            }
        }
        ret = new byte[clen * 4];
        for (i = 0, j = 0; i < clen; i++) {
            ret[j++] = (byte)((cdata[i] >> 24) & 0xff);
            ret[j++] = (byte)((cdata[i] >> 16) & 0xff);
            ret[j++] = (byte)((cdata[i] >> 8) & 0xff);
            ret[j++] = (byte)(cdata[i] & 0xff);
        }
        return ret;
    }
    /**
     * Hash a password using the OpenBSD bcrypt scheme
     * @param password the password to hash
     * @param salt the salt to hash with (perhaps generated
     * using BCrypt.gensalt)
     * @return the hashed password
     */
    public static String hashpw(String password, String salt) {
        BCryptUtil B;
        String real_salt;
        byte passwordb[], saltb[], hashed[];
        char minor = (char)0;
        int rounds, off = 0;
        StringBuffer rs = new StringBuffer();
        if (salt.charAt(0) != '$' || salt.charAt(1) != '2') {
            throw new IllegalArgumentException("Invalid salt version");
        }
        if (salt.charAt(2) == '$') {
            off = 3;
        } else {
            minor = salt.charAt(2);
            if (minor != 'a' || salt.charAt(3) != '$') {
                throw new IllegalArgumentException("Invalid salt revision");
            }
            off = 4;
        }
// Extract number of rounds
        if (salt.charAt(off + 2) > '$') {
            throw new IllegalArgumentException("Missing salt rounds");
        }
        rounds = Integer.parseInt(salt.substring(off, off + 2));
        real_salt = salt.substring(off + 3, off + 25);
        try {
            passwordb = (password + (minor >= 'a' ? "\000" : "")).getBytes("UTF8");
        } catch (UnsupportedEncodingException uee) {
            throw new AssertionError("UTF-8 is not supported");
        }
        saltb = decode_base64(real_salt, BCRYPT_SALT_LEN);
        B = new BCryptUtil();
        hashed = B.crypt_raw(passwordb, saltb, rounds,
                (int[])bf_crypt_ciphertext.clone());
        rs.append("$2");
        if (minor >= 'a') {
            rs.append(minor);
        }
        rs.append("$");
        if (rounds < 10) {
            rs.append("0");
        }
        if (rounds > 30) {
            throw new IllegalArgumentException(
                    "rounds exceeds maximum (30)");
        }
        rs.append(Integer.toString(rounds));
        rs.append("$");
        rs.append(encode_base64(saltb, saltb.length));
        rs.append(encode_base64(hashed,
                bf_crypt_ciphertext.length * 4 - 1));
        return rs.toString();
    }
    /**
     * Generate a salt for use with the BCrypt.hashpw() method
     * @param log_rounds the log2 of the number of rounds of
     * hashing to apply - the work factor therefore increases as
     * 2**log_rounds.
     * @param random an instance of SecureRandom to use
     * @return an encoded salt value
     */
    public static String gensalt(int log_rounds, SecureRandom random) {
        StringBuffer rs = new StringBuffer();
        byte rnd[] = new byte[BCRYPT_SALT_LEN];
        random.nextBytes(rnd);
        rs.append("$2a$");
        if (log_rounds < 10) {
            rs.append("0");
        }
        if (log_rounds > 30) {
            throw new IllegalArgumentException(
                    "log_rounds exceeds maximum (30)");
        }
        rs.append(Integer.toString(log_rounds));
        rs.append("$");
        rs.append(encode_base64(rnd, rnd.length));
        return rs.toString();
    }
    /**
     * Generate a salt for use with the BCrypt.hashpw() method
     * @param log_rounds the log2 of the number of rounds of
     * hashing to apply - the work factor therefore increases as
     * 2**log_rounds.
     * @return an encoded salt value
     */
    public static String gensalt(int log_rounds) {
        return gensalt(log_rounds, new SecureRandom());
    }
    /**
     * Generate a salt for use with the BCrypt.hashpw() method,
     * selecting a reasonable default for the number of hashing
     * rounds to apply
     * @return an encoded salt value
     */
    public static String gensalt() {
        return gensalt(GENSALT_DEFAULT_LOG2_ROUNDS);
    }
    /**
     * Check that a plaintext password matches a previously hashed
     * one
     * @param plaintext the plaintext password to verify
     * @param hashed the previously-hashed password
     * @return true if the passwords match, false otherwise
     */
    public static boolean checkpw(String plaintext, String hashed) {
        byte hashed_bytes[];
        byte try_bytes[];
        try {
            String try_pw = hashpw(plaintext, hashed);
            hashed_bytes = hashed.getBytes("UTF-8");
            try_bytes = try_pw.getBytes("UTF-8");
        } catch (UnsupportedEncodingException uee) {
            return false;
        }
        if (hashed_bytes.length != try_bytes.length) {

            return false;
        }
        byte ret = 0;
        for (int i = 0; i < try_bytes.length; i++) {
            ret |= hashed_bytes[i] ^ try_bytes[i];
        }
        return ret == 0;
    }
    /* public static void main(String[] args) {
        String password = "123456";
        String mingruijiaoyu = hashpw(password, gensalt());//加密
        System.out.println(mingruijiaoyu);
        String pwd =
        "$2a$10$nA2g16Zq1xS.CinETDlKfuxqLbZWMgIVSCGsE7G2G27PicxqoKsL.";
        boolean checkpw = checkpw("1234556", pwd);//明文密码和密文密码比较
        System.out.println(checkpw);
    }*/
}

```

## 2.3 service

### 2.3.1 新建mingrui-shop-service-user项目

### 2.3.2 pom.xml

```xml
    <dependencies>
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-service-api-user</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
    </dependencies>
```

### 2.3.3 application.yml



```yml
server:
  port: 8500
spring:
  application:
    name: user-server
  # 配置数据源
  datasource:
    # 数据源名称，任意
    name: mysql
    url: jdbc:mysql://localhost:3306/2005?useUnicode=true&characterEncoding=utf8
    # 数据库连接用户
    username: root
    # 数据库连接密码
    password: root
    # 驱动名称
    driver-class-name: com.mysql.jdbc.Driver
    # boot2.0+使用hikari作为默认数据库连接池
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      # 是否自动提交事务 默认
      auto-commit: true
      # 允许的最小连接数
      minimum-idle: 5
      # 连接池内最大连接数
      maximum-pool-size: 10
      # 验证连接的sql语句
      connection-test-query: SELECT 1 FROM DUAL
      # 连接超时时间 默认30000 毫秒 如果小于250毫秒，则被重置回30秒
      connection-timeout: 30000
      # 验证超时时间默认5000毫秒 如果小于250毫秒，则会被重置回5秒
      validation-timeout: 5000
      # 设置连接在连接池中的存货时间 如果不等于0且小于30秒则会被重置回30分钟
      max-lifetime: 1800000
# 通用mapper
mapper:
  mappers: tk.mybatis.mapper.common.Mapper
  identity: MYSQL
#日志设置
logging:
  level:
    # 打印与我们程序相关的日志信息
    com.baidu.shop: debug
# eureka配置
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/



```

### 2.3.4 新建包com.baidu 

### 2.3.5 新建启动类RunUserServerApplication

```java
package com.baidu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import tk.mybatis.spring.annotation.MapperScan;


@SpringBootApplication
@EnableEurekaClient
@MapperScan("com.baidu.shop.mapper")
public class RunUserServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunUserServerApplication.class,args);
    }
}

```

### 2.3.6 新建包com.baidu.shop.mapper 

### 2.3.7 包下新建UserMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.UserEntity;
import tk.mybatis.mapper.common.Mapper;

public interface UserMapper extends Mapper<UserEntity>  {
}

```



### **2.3.8** 新建包com.baidu.shop.service.impl

### 2.3.9 包下新建UserServiceImpl

```java
public class UserServiceImpl extends BaseApiService implements UserService {

	@Resource
    private UserMapper userMapper;
	
	
	@Override
    public Result<JSONObject> register(UserDTO userDTO) {
        UserEntity userEntity = BaiDuBeanUtil.copyProperties(userDTO,
                UserEntity.class);
        userEntity.setPassword(BCryptUtil.hashpw(userEntity.getPassword(), BCryptUtil.gensalt()));
        userEntity.setCreated(new Date());

        userMapper.insertSelective(userEntity);
        return this.setResultSuccess();
    }
}

```



### 2.3.10 测试注册接口

如果数据库表的密码长度给的不够,修改数据库password长度

ps:salt这个字段我们没有用,但是数据库设置的这个字段不能为空

## 2.4 zuul

### 2.4.1 application.yml

```yml
zuul:
  #路由前缀
  prefix: /api
  # 声明路由
  routes:
    xxx-server: /manage/**
    search-server: /search/**
    user-server: /user-center/**
```



### 3-注册功能实现

## 3.1 校验用户名/手机号唯一

### 3.1.1 UserService

```java
 @ApiOperation(value = "校验用户名或手机号唯一")
    @GetMapping(value = "user/check/{value}/{type}")
    Result<List<UserEntity>> checkUserNameOrPhone(@PathVariable(value = "value") String value, @PathVariable(value = "type") Integer type);
```

### 3.1.2 UserServiceImpl

```java
    //验证用户名或手机号
    @Override
    public Result<List<UserEntity>> checkUserNameOrPhone(String value, Integer type) {
        Example example = new Example(UserEntity.class);
        Example.Criteria criteria = example.createCriteria();

        if (type != null && value != null) {
            if (type == 1) {
                //通过用户名校验
                criteria.andEqualTo("username", value);
            } else {
                //通过手机号校验
                criteria.andEqualTo("phone", value);
            }
        }

        List<UserEntity> userEntities = userMapper.selectByExample(example);

        return this.setResultSuccess(userEntities);
    }
```

### 3.1.3 前台代码 register.html

```javascript
                validate(value, args) {
                    return new Promise(resolve => {
                        mrshop.http.get("/user-center/user/check/" + value + "/"+ args[0])
                            .then(resp => {
                                console.log(resp)
                                if(resp.data.code == 200){
                                    resolve({
                                        valid: !(resp.data.data.length > 0),
                                        data: "已存在!"
                                    })
                                 }
                             })
                     });
                }
```

## 3.2 给手机发送验证码

### 3.2.1 螺丝帽

文档：项目接入短信平台（螺丝帽）.note 链接：http://note.youdao.com/noteshare?id=423762507f2d04dd10c936498bb678e0&sub=9E5C9 B6C0C6543428DE728EBA964E6CC

### 3.2.2 将本地jar包安装到本地仓库

```sh
mvn install:install-file -Dfile=jersey-bundle-1.19.jar -
DgroupId=com.mrshop.luosimao -DartifactId=jersey-bundle -Dversion=1.0.0 -
Dpackaging=jar

mvn install:install-file -Dfile=json-org.jar -DgroupId=com.mrshop.luosimao -
DartifactId=json-org -Dversion=1.0.0 -Dpackaging=jar
```

在公司里 应该将代码上传自己的maven私服

### 3.2.3 common-core 

### 3.2.3.1 pom.xml

```xml
        <dependency>
            <groupId>com.mrshop.luosimao</groupId>
            <artifactId>jersey-bundle</artifactId>
            <version>1.0.0</version>
        </dependency>

        <dependency>
            <groupId>com.mrshop.luosimao</groupId>
            <artifactId>json-org</artifactId>
            <version>1.0.0</version>
        </dependency>
```

### 3.2.3.2 utils包下新建LuosimaoDuanxinUtil

```java
package com.baidu.shop.utils;

import com.sun.jersey.api.client.Client;
import com.sun.jersey.api.client.ClientResponse;
import com.sun.jersey.api.client.WebResource;
import com.sun.jersey.api.client.filter.HTTPBasicAuthFilter;
import com.sun.jersey.core.util.MultivaluedMapImpl;
import lombok.extern.slf4j.Slf4j;
import javax.ws.rs.core.MediaType;



@Slf4j
public class LuosimaoDuanxinUtil {
    //短信平台的APIkey
    private static final String DUANXIN_API_KEY = "key-595053173c6d79ef48e646f56fa6f44e";//需要使用自己的APIkey
    private static final String SPEAK_API_KEY = "key-806b63baabbba45fc73eb919f0232e36";//需要使用自己的APIkey
    private static final String SEND_DUANXIN_URL = "http://sms-api.luosimao.com/v1/send.json";//发送短信的接口
    private static final String SEND_SPEAK_URL = "http://voice-api.luosimao.com/v1/verify.json";//发送语音的接口
    private static final String STATUS_URL = "http://sms-api.luosimao.com/v1/status.json";//查看余额的接口

    public static String SendCode(String phone,String code){

        // just replace key here
        Client client = Client.create();
        client.addFilter(new HTTPBasicAuthFilter(
                "api",DUANXIN_API_KEY));
        WebResource webResource = client.resource(SEND_DUANXIN_URL);
        MultivaluedMapImpl formData = new MultivaluedMapImpl();
        formData.add("mobile", phone);
        formData.add("message", "验证码：" + code + "【铁壳测试】");//注意此处不能修改
        ClientResponse response =  webResource.type(MediaType.APPLICATION_FORM_URLENCODED).
                post(ClientResponse.class, formData);
        String textEntity = response.getEntity(String.class);
        int status = response.getStatus();
        log.info(textEntity);
        log.info("---------发送短信验证状态------" + status);
        return textEntity;
    }

    public static String sendSpeak(String phone,String code){
        // just replace key here
        Client client = Client.create();
        client.addFilter(new HTTPBasicAuthFilter(
                "api",SPEAK_API_KEY));
        WebResource webResource = client.resource(
                SEND_SPEAK_URL);
        MultivaluedMapImpl formData = new MultivaluedMapImpl();
        formData.add("mobile", phone);
        formData.add("code", code);
        ClientResponse response =  webResource.type(MediaType.APPLICATION_FORM_URLENCODED).
                post(ClientResponse.class, formData);
        String textEntity = response.getEntity(String.class);
        int status = response.getStatus();
        log.info(textEntity);
        log.info("---------发送语音验证状态------" + status);

        return textEntity;
    }

    private static String getStatus(){
        Client client = Client.create();
        client.addFilter(new HTTPBasicAuthFilter(
                "api",DUANXIN_API_KEY));
        WebResource webResource = client.resource( STATUS_URL );
        MultivaluedMapImpl formData = new MultivaluedMapImpl();
        ClientResponse response =  webResource.get( ClientResponse.class );
        String textEntity = response.getEntity(String.class);
        int status = response.getStatus();

        log.info(textEntity);
        log.info(status + "");
        return textEntity;
    }
}

```



### 3.2.4 前端页面 

```js
 createVerifyCode() {// 生成短信验证码

                if(this.sended)return ;
                this.$validator.validate("phone").then(r => {
                    if (r) {
                        mrshop.http.post("/user-center/user/sendValidCode",{
                            phone:this.user.phone
                        }).then(resp => {
                           console.log(resp);
                        }).catch(error => console.log(error));
                    }
                });
```

### 3.2.5 UserService

```java
	@ApiOperation(value = "给手机号发送验证码")
    @PostMapping(value = "user/sendValidCode")
    Result<JSONObject> sendValidCode(@RequestBody UserDTO userDTO);
```

### 3.2.6 UserServiceImpl

```java
@Override
    public Result<JSONObject> sendValidCode(UserDTO userDTO) {

        //生成随机6位验证码
        String code = (int)((Math.random() * 9 + 1) * 100000) + "";
        // 发送短信验证码
        LuosimaoDuanxinUtil.SendCode(userDTO.getPhone(),code);
        //发送语音验证码
        //LuosimaoDuanxinUtil.sendSpeak(userDTO.getPhone(),code);




        return this.setResultSuccess();
    }
```

螺丝帽只有十条免费,不够我们测试

```java
        //短信条数只有10条,不够我们测试.所以就不发送短信验证码了,直接在控制台打印就可以
        log.debug("向手机号码:{} 发送验证码:{}",userDTO.getPhone(),code);
```

### 3.2.7 前台

```js
 var registerVm = new Vue({
        el: "#registerApp",
        data: {
            user: {
                username: '',
                password: '',
                confirmPassword: '',
                phone: '',
                code: ''
            },
            check: {
                username: false
            },
            sended:false,
            sendMsg:'获取短信验证码'
        },
```

```js
                        <span class="code-span" @click="createVerifyCode">
                               {{sendMsg}}
                        </span>
```

```js
if(this.sended)return ;
                this.$validator.validate("phone").then(r => {
                    if (r) {
                        mrshop.http.post("/user-center/user/sendValidCode",{
                            phone:this.user.phone
                        }).then(resp => {
                           if(resp.data.code == 200){
                               //成功发送验证码,设置已经发送过验证码
                               this.sended = true;
                               //验证有效时间60秒
                               let time = 60;
                               //js定时执行任务
                               const timer = window.setInterval(() => {
                                    time--;//执行一次减一秒 
                                    this.sendMsg = '验证码已经发送,请' + time + '秒 后重试';
                                     if(time == 1){//如果time的值为1 那这个定时器就不应该再次执行了 
                                        //停止定时任务 
                                        window.clearInterval(timer); 
                                        this.sended = false;//设置发送状态 
                                        this.sendMsg = '获取短信验证码';//修改按钮的值 
                                    } }, 1000);
                           }
                        }).catch(error => console.log(error));
                    }
                });

```

## 3.3 校验手机验证码

### 3.3.1 redis

### 3.3.1.1 redis介绍

 简单来说 redis 就是一个数据库，不过与传统数据库不同的是 redis 的数据是存在内存中的，所以读写 速度非常快，因此 redis 被广泛应用于缓存方向。另外，redis 也经常用来做分布式锁。redis 提供了多 种数据类型来支持不同的业务场景。除此之外，redis 支持事务 、持久化、LUA脚本、LRU驱动事件、 多种集群方案。 

### 3.3.2.3 redis安装

 linux下新建redis目录

 下载linux压缩包

```shell
wget http://download.redis.io/releases/redis-5.0.5.tar.gz
```

 解压压缩包 

```shell
tar -zxvf redis-5.0.5.tar.gz
```

 进入刚刚解压的目录

```shell
cd redis-5.0.5/
```

 编译

```shell
make
```

![img](D:\GitHub\zhishizongjie\项目总结\typora-user-images\Snipaste_2021-03-11_23-35-17.png)

 测试编译

```shell
make test
```

![image-20210311212815431](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311212815431.png)



```shell
yum install tcl
```

![image-20210311212914914](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311212914914.png)

再次测试编译

```shell
make test
```

所有测试都通过后创建etc和bin文件夹

```shell
mkdir etc
mkdir bin
```

将redis配置文件移动到etc文件夹下

```shell
mv redis.conf etc/
```

进入src文件夹

```shell
cd src/
```

将我们有可能使用到的脚本放到bin文件夹

```shell
mv mkreleasehdr.sh redis-benchmark redis-check-aof redis-check-rdb redis-cli
redis-server ../bin/
```



进入etc文件夹 

修改redis.conf

```shell
vi redis.conf
```

![img](D:\GitHub\zhishizongjie\项目总结\typora-user-images\Snipaste_2021-03-11_23-34-51.png)

![image-20210311213302697](D:\GitHub\zhishizongjie\项目总结\typora-user-images\image-20210311213302697.png)

在redis_home下创建logs文件夹

```shell
mkdir logs
```

 文件夹内创建redis.log文件 

```shell
touch redis.log

```

进入bin文件夹

 启动redis服务

```shell
./redis-server
./redis-server ../etc/redis.conf #后台运行
ps -ef | grep redis #查看redis进程
```

 进入logs文件夹查看日志

 进入bin目录

 执行客户端脚本

```shell
./redis-cli
auth 123456 #验证密码

```



### 3.3.2 项目整合redis

### 3.3.2.1 api-user 

### 3.3.2.1.1 pom.xml

```xml
 <dependencies>
        <!--springboot整合redis-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        <!--redis需要的对象池 redis可以将存储对象-->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-pool2</artifactId>
            <version>2.8.0</version>
        </dependency>
    </dependencies>
```

### 3.3.2.1.2 config包下新建RedisConfig

```java
package com.baidu.shop.config;

import com.fasterxml.jackson.annotation.JsonAutoDetect;
import com.fasterxml.jackson.annotation.JsonTypeInfo;
import com.fasterxml.jackson.annotation.PropertyAccessor;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.jsontype.impl.LaissezFaireSubTypeValidator;
import org.springframework.cache.CacheManager;
import org.springframework.cache.annotation.CachingConfigurerSupport;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.data.redis.cache.RedisCacheConfiguration;
import org.springframework.data.redis.cache.RedisCacheManager;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.RedisSerializationContext;
import org.springframework.data.redis.serializer.RedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;

import java.nio.charset.Charset;
import java.time.Duration;


public class RedisConfig extends CachingConfigurerSupport {

    @Bean
    @Primary
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {

        RedisTemplate<String, Object> template = new RedisTemplate<>();

        RedisSerializer<String> redisSerializer = new StringRedisSerializer(Charset.forName("UTF8"));

        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);
        ObjectMapper om = new ObjectMapper();
        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        //om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);//方法已经过时,我印象当中这个方法是有漏洞的
        om.activateDefaultTyping(LaissezFaireSubTypeValidator.instance,ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.WRAPPER_ARRAY);
        jackson2JsonRedisSerializer.setObjectMapper(om);

        template.setConnectionFactory(factory);
        //key序列化方式
        template.setKeySerializer(redisSerializer);
        //value序列化
        template.setValueSerializer(jackson2JsonRedisSerializer);
        //value hashmap序列化
        template.setHashValueSerializer(jackson2JsonRedisSerializer);

        return template;
    }

    @Bean
    public CacheManager cacheManager(RedisConnectionFactory factory) {
        RedisSerializer<String> redisSerializer = new StringRedisSerializer();
        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);

        //解决查询缓存转换异常的问题
        ObjectMapper om = new ObjectMapper();
        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        //om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);
        om.activateDefaultTyping(LaissezFaireSubTypeValidator.instance,ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.WRAPPER_ARRAY);
        jackson2JsonRedisSerializer.setObjectMapper(om);

        // 配置序列化（解决乱码的问题）,过期时间30秒
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofSeconds(30))
                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))
                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))
                .disableCachingNullValues();

        RedisCacheManager cacheManager = RedisCacheManager.builder(factory)
                .cacheDefaults(config)
                .build();
        return cacheManager;
    }
}

```

### 3.3.2.2 service-user 

application.yml

```yml
# 整合redis配置
  redis:
    # 数据库标识，可以配置多个redis使用不同的标识区分
    database: 0
    # redisIP地址
    host: 81.70.218.80
    # redis端口号
    port: 6379
    # redis密码
    password: 123456
    # redis连接池的配置
    jedis:
      pool:
        #最大连接数据库连接数,设 0 为没有限制
        max-active: 8
        #最大等待连接中的数量,设 0 为没有限制
        max-idle: 8
        #最大建立连接等待时间。如果超过此时间将接到异常。设为-1表示无限制。
        max-wait: -1ms
        #最小等待连接中的数量,设 0 为没有限制
        min-idle: 0
```

### 3.3.2.2.1 com.baidu.shop包下新建redis.repository包 

### 3.3.2.2.2 包下新建RedisRepository

```java
package com.baidu.shop.redis;

import com.baidu.shop.utils.JSONUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.DataAccessException;
import org.springframework.data.redis.connection.RedisConnection;
import org.springframework.data.redis.core.RedisCallback;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.data.redis.serializer.RedisSerializer;
import org.springframework.stereotype.Component;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.TimeUnit;

/**
 * @ClassName RedisRepository
 * @Description: TODO
 * @Author wangyue
 * @Date 2021/3/11
 * @Version V1.0
 **/
@Component
public class RedisRepository {
    //--注意：此处不能使用Resource注解，因为在RedisConfig line:30行中使用@Bean注解，方法的返回值是RedisTemplate @Resource默认按名称自动注入，会与我们定义的redisTemplate冲突
    @Autowired
    private StringRedisTemplate redisTemplate;

    /**
     * 获取序列化工具
     * @return
     */
    private RedisSerializer<String> getSerializer(){

        return redisTemplate.getStringSerializer();
    }

    /**
     * 放入string类型的值
     * @param key
     * @param value
     * @return
     */
    public boolean set(final String key, final String value) {
        return redisTemplate.execute(new RedisCallback<Boolean>() {

            @Override
            public Boolean doInRedis(RedisConnection connection) throws DataAccessException {

                return connection.set(getSerializer().serialize(key), getSerializer().serialize(value));
            }
        });
    }

    /**
     * 放入对象类型的值
     * @param key
     * @param obj
     * @return
     */
    public boolean setObj(final String key, final Object obj) {

        return redisTemplate.execute(new RedisCallback<Boolean>() {

            @Override
            public Boolean doInRedis(RedisConnection connection) throws DataAccessException {

                return connection.set(getSerializer().serialize(key), getSerializer().serialize(JSONUtil.toJsonString(obj)));
            }
        });
    }

    /**
     * 获取string类型的值
     * @param key
     * @return
     */
    public String get(final String key) {

        return redisTemplate.execute(new RedisCallback<String>() {
            @Override
            public String doInRedis(RedisConnection connection) throws DataAccessException {

                byte[] value = connection.get(getSerializer().serialize(key));

                return getSerializer().deserialize(value);
            }
        });
    }

    /**
     * 获取对象类型的值
     * @param key
     * @param clazz
     * @param <T>
     * @return
     */
    public <T> T getObj(final String key,Class<T> clazz) {

        String result = redisTemplate.execute(new RedisCallback<String>() {

            @Override
            public String doInRedis(RedisConnection connection) throws DataAccessException {

                byte[] value = connection.get(getSerializer().serialize(key));

                return getSerializer().deserialize(value);
            }
        });

        Object o = JSONUtil.toBean(result, clazz);

        if(clazz.isInstance(o)){

            return clazz.cast(o);
        }

        return null;
    }

    /**
     * 给key值设置过期时间
     * @param key
     * @param expire
     * @return
     */
    public boolean expire(final String key, long expire) {
        return redisTemplate.expire(key, expire, TimeUnit.SECONDS);
    }

    /**
     * 放入list类型的值
     * @param key
     * @param list
     * @param <T>
     * @return
     */
    public <T> boolean setList(String key, List<T> list) {

        return set(key, JSONUtil.toJsonString(list));
    }

    /**
     * 获取list类型的值
     * @param key
     * @param clz
     * @param <T>
     * @return
     */
    public <T> List<T> getList(String key, Class<T> clz) {

        String json = get(key);

        if (json != null) {

            List<T> list = JSONUtil.toList(json, clz);
            return list;
        }
        return null;
    }

    /**
     * 操作队列
     * @param key
     * @param obj
     * @return
     */
    public long rpush(final String key, Object obj) {
        final String value = JSONUtil.toJsonString(obj);
        long result = redisTemplate.execute(new RedisCallback<Long>() {
            @Override
            public Long doInRedis(RedisConnection connection) throws DataAccessException {

                long count = connection.rPush(getSerializer().serialize(key), getSerializer().serialize(value));
                return count;
            }
        });
        return result;
    }

    /**
     * 删除队列
     * @param key
     * @return
     */
    public String lpop(final String key) {
        String result = redisTemplate.execute(new RedisCallback<String>() {
            @Override
            public String doInRedis(RedisConnection connection) throws DataAccessException {

                byte[] res = connection.lPop(getSerializer().serialize(key));
                return getSerializer().deserialize(res);
            }
        });
        return result;
    }

    /**
     * 通过key值删除缓存数据
     * @param key
     * @return
     */
    public boolean del(String key) {
        // TODO Auto-generated method stub
        return redisTemplate.delete(key);
    }

    /**
     * 存入hash类型的值
     * @param key
     * @param mapKey
     * @param value
     * @return
     */
    public boolean setHash(final String key,final String mapKey, final String value) {

        return redisTemplate.execute(new RedisCallback<Boolean>() {
            @Override
            public Boolean doInRedis(RedisConnection connection) throws DataAccessException {
                // TODO Auto-generated method stub

                return connection.hSet(getSerializer().serialize(key), getSerializer().serialize(mapKey), getSerializer().serialize(value));
            }
        });
    }

    /**
     * 通过redis的key和hashkey删除value
     * @param key
     * @param mapKey
     * @return
     */
    public boolean delHash(final String key,final String mapKey) {

        return redisTemplate.execute(new RedisCallback<Boolean>() {
            @Override
            public Boolean doInRedis(RedisConnection connection) throws DataAccessException {
                // TODO Auto-generated method stub
                Long aLong = connection.hDel(getSerializer().serialize(key), getSerializer().serialize(mapKey));
                return aLong != 0;
            }
        });
    }

    /**
     * 通过rediskey删除hash
     * @param key
     * @return
     */
    public boolean delHash(final String key) {

        return redisTemplate.execute(new RedisCallback<Boolean>() {
            @Override
            public Boolean doInRedis(RedisConnection connection) throws DataAccessException {
                // TODO Auto-generated method stub
                Long aLong = connection.hDel(getSerializer().serialize(key));
                return aLong != 0;
            }
        });
    }


    /**
     * 根据redis的key和hask的key获取hash对应的值
     * @param key
     * @param mapKey
     * @param clazz
     * @param <T>
     * @return
     */
    public <T> T getHash(final String key,final String mapKey,Class<T> clazz) {

        String result = redisTemplate.execute(new RedisCallback<String>() {
            @Override
            public String doInRedis(RedisConnection connection) throws DataAccessException {

                byte[] bytes = connection.hGet(getSerializer().serialize(key), getSerializer().serialize(mapKey));

                return getSerializer().deserialize(bytes);
            }
        });

        Object o = JSONUtil.toBean(result, clazz);
        if(clazz.isInstance(o)){
            return clazz.cast(o);
        }
        return null;
    }

    /**
     * 根据redis 的key值获取hash的entry
     * @param key
     * @return
     */
    public Map<String, String> getHash(final String key) {

        Map<byte[], byte[]> result = (Map<byte[], byte[]>) redisTemplate.execute(new RedisCallback<Map<byte[], byte[]>>() {
            @Override
            public Map<byte[], byte[]> doInRedis(RedisConnection connection) throws DataAccessException {

                Map<byte[], byte[]> map = connection.hGetAll(getSerializer().serialize(key));
                return map;
            }
        });

        Map<String, String> map = new HashMap<String, String>();
        for (Map.Entry<byte[], byte[]> entry : result.entrySet()){

            map.put(getSerializer().deserialize(entry.getKey()),getSerializer().deserialize(entry.getValue()));
        }

        return map;
    }
}

```

### 3.3.2.2.3 UserServiceImpl 

在发送手机验证码同时将验证码存到redis库中,并设置过期时间为60秒

```java
	@Autowired
    private RedisRepository redisRepository;


	@Override
    public Result<JSONObject> sendValidCode(UserDTO userDTO) {

        //生成随机6位验证码
        String code = (int)((Math.random() * 9 + 1) * 100000) + "";
        // 发送短信验证码
        //LuosimaoDuanxinUtil.SendCode(userDTO.getPhone(),code);
        //发送语音验证码
        //LuosimaoDuanxinUtil.sendSpeak(userDTO.getPhone(),code);

        log.info("手机号码为 : {} , 验证为 : {}", userDTO.getPhone(),code);
        redisRepository.set("valid-code-" + userDTO.getPhone(),code);
        redisRepository.expire("valid-code-" + userDTO.getPhone(),60L);


        return this.setResultSuccess();
    }
```

### 3.3.2.2.4 提供一个校验验证码的接口

```java
 	@ApiOperation(value = "校验手机验证码")
    @GetMapping(value = "user/checkCode")
    Result<JSONObject> checkCode(String phone,String code);
```

在common-core下新建com.baidu.shop.constant

```java
package com.baidu.shop.constant;

/**
 * @ClassName MrConstants
 * @Description: TODO
 * @Author wangyue
 * @Date 2021/3/11
 * @Version V1.0
 **/
public class MrConstants {
    public static final String REDIS_DUANXIN_CODE_PRE = "valid-code-";
}

```



```java
//校验手机验证码
    @Override
    public Result<JSONObject> checkCode(String phone, String code) {
        String redisCode = redisRepository.get(MrConstants.REDIS_DUANXIN_CODE_PRE + phone);
        if(code.equals(redisCode)){
            return this.setResultSuccess();
        }

        return this.setResultError("验证码输入错误");
    }
```

## 3.4页面校验

```java
                    <div class="controls">
                        <input type="text" placeholder="短信验证码" class="input-xfat input-xlarge" style="width: 120px;"
                               v-model="user.code" name="code" v-validate="{required:true,code:user.phone}" data-vv-as="验证码">
                        <span class="code-span" @click="createVerifyCode">
                               {{sendMsg}}
                        </span>
                    </div>
```

```js
this.$validator.extend('code',{
                getMessage(){
                    return "验证码输入错误"
                },
                validate(val,args){
                    //验证验证码输入是否正确
                    return new Promise(resolve => {
                        mrshop.http.get('/user-center/user/checkCode',{
                            params:{
                                phone:args[0],
                                code:val
                            }
                        }).then(resp=>{
                            resolve({
                                valid:resp.data.code == 200
                            })
                        }).catch(error=>console.log(error));
                    })
                }

            })
```

## 3.5 完成注册

```js
submit() {
                this.$validator.validateAll().then(d => {
                    if (d) {
                        // 校验通过，提交表单
                        mrshop.http.post("/user-center/user/register",this.user)
                            .then(resp => {
                                if (resp.data.code === 200) {
                                    // 注册成功
                                    alert("注册成功,即将跳转到登录页！");
                                    setTimeout(() => window.location = '/login.html', 2000);
                                }
                            })
                            .catch(() => alert("注册失败！"))
                    }
                })
            }
```



